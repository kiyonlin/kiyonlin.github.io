<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>解析Fiber路由管理 - Tsing Wind - 清风徐来 水波不兴</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Kiyon Lin" />
  <meta name="description" content="本文主要通过阅读Fiber源码，解析Fiber是如何管理路由的： 路由注册 路由匹配 环境：macos 10.15.4 &#43; go 1.14.1 &#43; fiber 1.12.1 路由注册 路由结构和路由器接口 首" />

  <meta name="keywords" content="Hugo, theme, kiyon, kiyonlin" />






<meta name="generator" content="Hugo 0.72.0" />


<link rel="canonical" href="https://kiyonlin.github.io/post/work/gofiber/fiber-router/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/kiyon.min.fa3d941d1d0e0ddc985804227feabffea55c89883eb0af34e0532a7ae9135151.css" integrity="sha256-&#43;j2UHR0ODdyYWAQif&#43;q//qVciYg&#43;sK804FMqeukTUVE=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="解析Fiber路由管理" />
<meta property="og:description" content="本文主要通过阅读Fiber源码，解析Fiber是如何管理路由的： 路由注册 路由匹配 环境：macos 10.15.4 &#43; go 1.14.1 &#43; fiber 1.12.1 路由注册 路由结构和路由器接口 首" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kiyonlin.github.io/post/work/gofiber/fiber-router/" />
<meta property="article:published_time" content="2020-06-23T13:18:48+08:00" />
<meta property="article:modified_time" content="2020-07-01T16:30:04+08:00" />
<meta itemprop="name" content="解析Fiber路由管理">
<meta itemprop="description" content="本文主要通过阅读Fiber源码，解析Fiber是如何管理路由的： 路由注册 路由匹配 环境：macos 10.15.4 &#43; go 1.14.1 &#43; fiber 1.12.1 路由注册 路由结构和路由器接口 首">
<meta itemprop="datePublished" content="2020-06-23T13:18:48&#43;08:00" />
<meta itemprop="dateModified" content="2020-07-01T16:30:04&#43;08:00" />
<meta itemprop="wordCount" content="4190">



<meta itemprop="keywords" content="golang,gofiber,web," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="解析Fiber路由管理"/>
<meta name="twitter:description" content="本文主要通过阅读Fiber源码，解析Fiber是如何管理路由的： 路由注册 路由匹配 环境：macos 10.15.4 &#43; go 1.14.1 &#43; fiber 1.12.1 路由注册 路由结构和路由器接口 首"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Tsing Wind</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/kiyonlin" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Tsing Wind
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/kiyonlin" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">解析Fiber路由管理</h1>
      
      <div class="post-meta">
        <time datetime="2020-06-23" class="post-time">
          2020-06-23
        </time>
        <div class="post-category">
            <a href="https://kiyonlin.github.io/categories/golang/"> golang </a>
            <a href="https://kiyonlin.github.io/categories/web/"> web </a>
            
          </div>
        <span class="more-meta"> 约 4190 字 </span>
          <span class="more-meta"> 预计阅读 9 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#路由注册">路由注册</a>
      <ul>
        <li><a href="#路由结构和路由器接口">路由结构和路由器接口</a></li>
        <li><a href="#app的注册方法"><code>App</code>的注册方法</a></li>
        <li><a href="#group的add方法"><code>Group</code>的<code>Add</code>方法</a></li>
        <li><a href="#解析路由路径">解析路由路径</a></li>
        <li><a href="#小结">小结</a></li>
      </ul>
    </li>
    <li><a href="#路由匹配">路由匹配</a>
      <ul>
        <li><a href="#匹配请求路径">匹配请求路径</a></li>
        <li><a href="#路由参数匹配">路由参数匹配</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#其他">其他</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>本文主要通过阅读<a href="https://github.com/gofiber/fiber">Fiber</a>源码，解析<code>Fiber</code>是如何管理路由的：</p>
<ol>
<li>路由注册</li>
<li>路由匹配</li>
</ol>
<blockquote>
<p>环境：macos 10.15.4 + go 1.14.1 + fiber <a href="https://github.com/gofiber/fiber/tree/v1.12.1">1.12.1</a></p>
</blockquote>
<h2 id="路由注册">路由注册</h2>
<h3 id="路由结构和路由器接口">路由结构和路由器接口</h3>
<p>首先看一下路由的结构(<a href="https://github.com/gofiber/fiber/blob/v1.12.1/router.go#L37-L53">源码</a>)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Route 存放了注册处理器的元数据
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Route</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">pos</span>         <span class="kt">int</span>         <span class="c1">// 路由栈中的位置
</span><span class="c1"></span>	<span class="nx">use</span>         <span class="kt">bool</span>        <span class="c1">// 匹配路由前缀（中间件）
</span><span class="c1"></span>	<span class="nx">star</span>        <span class="kt">bool</span>        <span class="c1">// 路由路径为&#39;*&#39;
</span><span class="c1"></span>	<span class="nx">root</span>        <span class="kt">bool</span>        <span class="c1">// 路由路径为&#39;/&#39;
</span><span class="c1"></span>	<span class="nx">path</span>        <span class="kt">string</span>      <span class="c1">// 美化的路由路径
</span><span class="c1"></span>	<span class="nx">routeParser</span> <span class="nx">routeParser</span> <span class="c1">// 路由解析器
</span><span class="c1"></span>	<span class="nx">routeParams</span> <span class="p">[]</span><span class="kt">string</span>    <span class="c1">// 大小写敏感的参数 key
</span><span class="c1"></span>
	<span class="nx">Name</span>     <span class="kt">string</span>    <span class="c1">// 路由第一个处理器的名称
</span><span class="c1"></span>	<span class="nx">Path</span>     <span class="kt">string</span>    <span class="c1">// 原始注册路由路径
</span><span class="c1"></span>	<span class="nx">Method</span>   <span class="kt">string</span>    <span class="c1">// HTTP method
</span><span class="c1"></span>	<span class="nx">Handlers</span> <span class="p">[]</span><span class="nx">Handler</span> <span class="c1">// 所有处理器
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以及路由器接口的定义(<a href="https://github.com/gofiber/fiber/blob/v1.12.1/router.go#L16-L35">源码</a>)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Router</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// 注册中间件
</span><span class="c1"></span>	<span class="nf">Use</span><span class="p">(</span><span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="o">*</span><span class="nx">Route</span>

	<span class="nf">Get</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>
	<span class="nf">Head</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>
	<span class="nf">Post</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>
	<span class="nf">Put</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>
	<span class="nf">Delete</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>
	<span class="nf">Connect</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>
	<span class="nf">Options</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>
	<span class="nf">Trace</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>
	<span class="nf">Patch</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>

	<span class="nf">Add</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>
	<span class="nf">Static</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">root</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">config</span> <span class="o">...</span><span class="nx">Static</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span>
	<span class="nf">All</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Route</span>
	<span class="c1">// 路由组，有处理器时注册成中间件
</span><span class="c1"></span>	<span class="nf">Group</span><span class="p">(</span><span class="nx">prefix</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Group</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/gofiber/fiber/blob/v1.12.1/app.go#L45-L58">App</a>和<a href="https://github.com/gofiber/fiber/blob/v1.12.1/group.go#L12-L16">Group</a>结构都实现了<code>Router</code>接口，它们的<code>Get</code>、<code>Head</code>、<code>Post</code>、<code>Put</code>、<code>Delete</code>、<code>Connect</code>、<code>Options</code>、<code>Trace</code>和<code>Patch</code>方法是对<code>Add</code>方法的封装。<code>App</code>的<code>Add</code>方法其实也是对其<code>register</code>方法的封装，而<code>Group</code>的实现只是组装了路由路径，再直接调用<code>App</code>的相关方法。</p>
<h3 id="app的注册方法"><code>App</code>的注册方法</h3>
<p>我们先看<code>func (app *App) register(method, pathRaw string, handlers ...Handler) *Route</code>方法(<a href="https://github.com/gofiber/fiber/blob/v1.12.1/router.go#L138-L216">源码</a>)：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">App</span><span class="p">)</span> <span class="nf">register</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">pathRaw</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span> <span class="p">{</span>
	<span class="c1">// 一些检测工作
</span><span class="c1"></span>	<span class="c1">// pathPretty 会根据 pathRaw 做一些额外的路径处理：大小写转换，清除后缀&#39;/&#39;等
</span><span class="c1"></span>	<span class="nx">pathPretty</span> <span class="o">:=</span> <span class="nx">pathRaw</span>
	<span class="c1">// ...
</span><span class="c1"></span>	<span class="c1">// 是不是中间件
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">isUse</span> <span class="p">=</span> <span class="nx">method</span> <span class="o">==</span> <span class="s">&#34;USE&#34;</span>
	<span class="c1">// 是否通配符
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">isStar</span> <span class="p">=</span> <span class="nx">pathPretty</span> <span class="o">==</span> <span class="s">&#34;/*&#34;</span>
	<span class="c1">// 是否根路径
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">isRoot</span> <span class="p">=</span> <span class="nx">pathPretty</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span>
	<span class="c1">// 解析路由路径
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">parsedRaw</span> <span class="p">=</span> <span class="nf">parseRoute</span><span class="p">(</span><span class="nx">pathRaw</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">parsedPretty</span> <span class="p">=</span> <span class="nf">parseRoute</span><span class="p">(</span><span class="nx">pathPretty</span><span class="p">)</span>

	<span class="c1">// 增加全局的路由位置
</span><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="nx">app</span><span class="p">.</span><span class="nx">routes</span><span class="o">++</span>
	<span class="nx">app</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="c1">// 创建路由元数据
</span><span class="c1"></span>	<span class="nx">route</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Route</span><span class="p">{</span>
		<span class="nx">pos</span><span class="p">:</span>  <span class="nx">app</span><span class="p">.</span><span class="nx">routes</span><span class="p">,</span>
		<span class="nx">use</span><span class="p">:</span>  <span class="nx">isUse</span><span class="p">,</span>
		<span class="nx">star</span><span class="p">:</span> <span class="nx">isStar</span><span class="p">,</span>
		<span class="nx">root</span><span class="p">:</span> <span class="nx">isRoot</span><span class="p">,</span>
		<span class="nx">path</span><span class="p">:</span>        <span class="nx">pathPretty</span><span class="p">,</span>
		<span class="nx">routeParser</span><span class="p">:</span> <span class="nx">parsedPretty</span><span class="p">,</span>
		<span class="nx">routeParams</span><span class="p">:</span> <span class="nx">parsedRaw</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span>
		<span class="nx">Path</span><span class="p">:</span>     <span class="nx">pathRaw</span><span class="p">,</span>
		<span class="nx">Method</span><span class="p">:</span>   <span class="nx">method</span><span class="p">,</span>
		<span class="nx">Handlers</span><span class="p">:</span> <span class="nx">handlers</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="c1">// 假如是中间件，则为每种 HTTP methods 栈都追加路由
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">isUse</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">methodINT</span> <span class="p">{</span>
			<span class="nx">app</span><span class="p">.</span><span class="nf">addRoute</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">route</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">route</span>
	<span class="p">}</span>

	<span class="c1">// 假如是 GET 方法，则补上 HEAD 方法
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">method</span> <span class="o">==</span> <span class="nx">MethodGet</span> <span class="p">{</span>
		<span class="nx">app</span><span class="p">.</span><span class="nf">addRoute</span><span class="p">(</span><span class="nx">MethodHead</span><span class="p">,</span> <span class="nx">route</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// 追加到路由栈
</span><span class="c1"></span>	<span class="nx">app</span><span class="p">.</span><span class="nf">addRoute</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">route</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">route</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们稍微分析一下<code>register</code>做了什么事情：</p>
<ol>
<li>一些检测工作，<code>method</code>参数是否合法，<code>handlers</code>是否为空，补全路由路径等</li>
<li>创建<code>pathPretty</code>，它是<code>pathRaw</code>的副本，然后做一些额外的路径处理：根据配置转换大小写；根据严格模式清除后缀<code>/</code></li>
<li>生成路由元数据，其中解析路由路径这个操作会在<a href="#%E8%A7%A3%E6%9E%90%E8%B7%AF%E7%94%B1%E8%B7%AF%E5%BE%84">后面</a>详细分析</li>
<li>根据<code>isUse</code>判断是否为中间件，是的话，给每个<code>HTTP Methods</code>栈追加路由，并直接返回路由对象</li>
<li>若<code>method</code>是<code>GET</code>方法，则为<code>HEAD</code>路由栈追加同样的路由</li>
<li>给指定的<code>method</code>路由栈追加路由</li>
</ol>
<p>这样，一个路由注册工作就完成了，非常直接了当。</p>
<h3 id="group的add方法"><code>Group</code>的<code>Add</code>方法</h3>
<p>接下来我们看一下<code>Group</code>的<code>Add</code>方法实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">grp</span> <span class="o">*</span><span class="nx">Group</span><span class="p">)</span> <span class="nf">Add</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handlers</span> <span class="o">...</span><span class="nx">Handler</span><span class="p">)</span> <span class="o">*</span><span class="nx">Route</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">grp</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nf">getGroupPath</span><span class="p">(</span><span class="nx">grp</span><span class="p">.</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span> <span class="nx">handlers</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>非常简单，使用<code>getGroupPath</code>重新组装<code>path</code>，调用<code>App</code>的<code>register</code>方法。<code>getGroupPath</code>方法的实现也很简单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">getGroupPath</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">prefix</span>
	<span class="p">}</span>
	<span class="c1">// 清除 prefix 的&#39;/&#39;后缀，再拼接 path
</span><span class="c1"></span>	<span class="k">return</span> <span class="nx">utils</span><span class="p">.</span><span class="nf">TrimRight</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">path</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="解析路由路径">解析路由路径</h3>
<p>解析路由路径的工作，单独放在了<a href="https://github.com/gofiber/fiber/blob/v1.12.1/path.go">path</a>文件中，我们先来看看核心的<code>routeParser</code>和<code>paramSeg</code>结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// routeParser 保存了路径 segments 和参数名称
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">routeParser</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">segs</span>   <span class="p">[]</span><span class="nx">paramSeg</span>
	<span class="nx">params</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// paramsSeg 保存了每个段的元数据
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">paramSeg</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Param</span>      <span class="kt">string</span>	<span class="c1">// 参数名
</span><span class="c1"></span>	<span class="nx">Const</span>      <span class="kt">string</span>	<span class="c1">// 常量字符串
</span><span class="c1"></span>	<span class="nx">IsParam</span>    <span class="kt">bool</span>		<span class="c1">// 是否参数
</span><span class="c1"></span>	<span class="nx">IsOptional</span> <span class="kt">bool</span>		<span class="c1">// 是否可选
</span><span class="c1"></span>	<span class="nx">IsLast</span>     <span class="kt">bool</span>		<span class="c1">// 是否最后一个段
</span><span class="c1"></span>	<span class="nx">EndChar</span>    <span class="kt">byte</span>		<span class="c1">// 终止字符，是&#39;/&#39;， &#39;-&#39;， &#39;.&#39;的其中一个，默认为&#39;/&#39;
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们从上述注册方法中使用的<code>func parseRoute(pattern string) (p routeParser)</code>方法(<a href="https://github.com/gofiber/fiber/blob/v1.12.1/path.go#L38-L95">源码</a>)开始分析，再以<code>/api/v1/:year-:month.:day/*/:param?</code>当参数，作为例子讲解：</p>
<ol>
<li>找到匹配串<code>/</code>，这是一个特殊情况，<code>pattern</code>变为<code>api/v1/:year-:month.:day/*/:param?</code></li>
<li>找到匹配串<code>api/</code>，这是一个常量匹配串，所以生成一个常量<code>segment</code>，常量<code>Const</code>字段为<code>api</code>，终止字符为<code>/</code>，<code>pattern</code>变为<code>v1/:year-:month.:day/*/:param?</code></li>
<li>找到匹配串<code>v1/</code>，这是一个常量匹配串，且上一个<code>segment</code>是常量类型，所以追加<code>/v1</code>到上一个<code>segment</code>的<code>Const</code>字段中，<code>pattern</code>变为<code>:year-:month.:day/*/:param?</code></li>
<li>找到匹配串<code>:year-</code>，<code>:</code>开头，所以这个<code>segment</code>是一个参数，参数名为<code>year</code>，终止字符为<code>-</code>，<code>pattern</code>变为<code>:month.:day/*/:param?</code></li>
<li>找到匹配串<code>:month.</code>，<code>:</code>开头，所以这个<code>segment</code>是一个参数，参数名为<code>month</code>，终止字符为<code>.</code>，<code>pattern</code>变为<code>:day/*/:param?</code></li>
<li>找到匹配串<code>:day/</code>，<code>:</code>开头，所以这个<code>segment</code>是一个参数，参数名为<code>day</code>，终止字符为<code>/</code>，<code>pattern</code>变为<code>*/:param?</code></li>
<li>找到匹配串<code>*/</code>，<code>*</code>开头，所以这个<code>segment</code>是一个参数，而且可选(<code>*</code>是通配符)，参数名为<code>*</code>，终止字符为<code>/</code>，<code>pattern</code>变为<code>:param?</code></li>
<li>找不到分隔符，剩余的<code>pattern</code>作为匹配串，即<code>:param?</code>，<code>:</code>开头，所以这个<code>segment</code>是一个参数，<code>?</code>结尾，所以这个<code>segment</code>也是可选的，参数名为<code>param</code>，因为接下来<code>pattern</code>已经没有了，所以终止字符使用默认值<code>/</code>，且这个<code>segment</code>的<code>IsLast</code>字段标记为<code>true</code></li>
</ol>
<p>最终的<code>routeParser</code>结果为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">segs: [
{Param:&#34;&#34; Const:&#34;api/v1&#34; IsParam:false IsOptional:false IsLast:false EndChar:&#39;/&#39;},
{Param:&#34;year&#34; Const:&#34;&#34; IsParam:true IsOptional:false IsLast:false EndChar:&#39;-&#39;},
{Param:&#34;month&#34; Const:&#34;&#34; IsParam:true IsOptional:false IsLast:false EndChar:&#39;.&#39;},
{Param:&#34;day&#34; Const:&#34;&#34; IsParam:true IsOptional:false IsLast:false EndChar:&#39;/&#39;},
{Param:&#34;*&#34; Const&#34;&#34;: IsParam:true IsOptional:true IsLast:false EndChar:&#39;/&#39;},
{Param:&#34;param&#34; Const&#34;&#34;: IsParam:true IsOptional:true IsLast:true EndChar:&#39;/}
]
params:[&#34;year&#34; &#34;month&#34; &#34;day&#34; &#34;*&#34; &#34;param&#34;]
</code></pre></td></tr></table>
</div>
</div><h3 id="小结">小结</h3>
<p>路由注册到这里就差不多了，我们可以看到主要的工作就是解析路由路径，保存好元数据，供路由匹配使用。其实还剩下静态资源路由注册<code>registerStatic</code>没讲，它封装了<code>fasthttp</code>的相关方法，有兴趣的同学可以自行查看<a href="https://github.com/gofiber/fiber/blob/v1.12.1/router.go#L218-L320">源码</a>。</p>
<h2 id="路由匹配">路由匹配</h2>
<p>每当<code>Http</code>请求到达后，会由<code>fasthttp</code>解析，<code>Fiber</code>将<code>rctx *fasthttp.RequestCtx</code>包装为<a href="https://github.com/gofiber/fiber/blob/v1.12.1/ctx.go#L33-L46">Fiber.Ctx</a>对象，由<code>app.next</code>处理（详见<a href="https://github.com/gofiber/fiber/blob/v1.12.1/router.go#L119-L125">源码</a>）。没有匹配的路由，则尝试设置<code>Method Not Allowed 405</code>状态码（详见<a href="https://github.com/gofiber/fiber/blob/v1.12.1/router.go#L130-L133">源码</a>）。</p>
<p><code>app.next</code>是处理的核心：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">App</span><span class="p">)</span> <span class="nf">next</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">Ctx</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="c1">// TODO set unique INT within handler(), not here over and over again
</span><span class="c1"></span>	<span class="nx">method</span> <span class="o">:=</span> <span class="nx">methodINT</span><span class="p">[</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">method</span><span class="p">]</span>
	<span class="c1">// 路由栈长度
</span><span class="c1"></span>	<span class="nx">lenr</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nx">method</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
	<span class="c1">// 从上一个索引开始循环路由栈
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">indexRoute</span> <span class="p">&lt;</span> <span class="nx">lenr</span> <span class="p">{</span>
		<span class="c1">// 增加路由索引，初始为-1
</span><span class="c1"></span>		<span class="nx">ctx</span><span class="p">.</span><span class="nx">indexRoute</span><span class="o">++</span>
		<span class="nx">route</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nx">method</span><span class="p">][</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">indexRoute</span><span class="p">]</span>
		<span class="c1">// 检查路由是否匹配请求路径
</span><span class="c1"></span>		<span class="nx">match</span><span class="p">,</span> <span class="nx">values</span> <span class="o">:=</span> <span class="nx">route</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">pathOriginal</span><span class="p">)</span>
		<span class="c1">// 未匹配则继续查找
</span><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">match</span> <span class="p">{</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="c1">// 设置路由对象和路由路径参数对应的值
</span><span class="c1"></span>		<span class="nx">ctx</span><span class="p">.</span><span class="nx">route</span> <span class="p">=</span> <span class="nx">route</span>
		<span class="nx">ctx</span><span class="p">.</span><span class="nx">values</span> <span class="p">=</span> <span class="nx">values</span>
		<span class="c1">// 执行路由的第一个处理器
</span><span class="c1"></span>		<span class="nx">ctx</span><span class="p">.</span><span class="nx">indexHandler</span> <span class="p">=</span> <span class="mi">0</span>
		<span class="nx">route</span><span class="p">.</span><span class="nx">Handlers</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="nx">ctx</span><span class="p">)</span>
		<span class="c1">// 停止扫描路由栈
</span><span class="c1"></span>		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">}</span>
	<span class="c1">// 默认设置 404 状态码
</span><span class="c1"></span>	<span class="nx">ctx</span><span class="p">.</span><span class="nf">SendStatus</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
	<span class="nx">ctx</span><span class="p">.</span><span class="nf">SendString</span><span class="p">(</span><span class="s">&#34;Cannot &#34;</span> <span class="o">+</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">method</span> <span class="o">+</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">pathOriginal</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们看看<code>next</code>做了什么事：</p>
<ul>
<li>找到请求的<code>method</code>方法对应的路由栈</li>
<li>遍历路由栈，检查路由是否匹配请求路径，详细匹配过程见<a href="#%E5%8C%B9%E9%85%8D%E8%AF%B7%E6%B1%82%E8%B7%AF%E5%BE%84">下文</a></li>
<li>匹配成功，为<code>ctx</code>设置路由对象和路由路径参数对应的值</li>
<li>执行该路由的第一个处理器</li>
<li>处理器中调用了<code>ctx.Next()</code>的话，可能<a href="https://github.com/gofiber/fiber/blob/v1.12.1/ctx.go#L615">继续</a>遍历路由栈</li>
</ul>
<h3 id="匹配请求路径">匹配请求路径</h3>
<p>接下来让我们瞅瞅路由如何去匹配请求路径：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Route</span><span class="p">)</span> <span class="nf">match</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">original</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">match</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">values</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// 根路径匹配
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">root</span> <span class="o">&amp;&amp;</span> <span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;/&#34;</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">values</span>
		<span class="c1">// 通配符匹配
</span><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">star</span> <span class="p">{</span>
		<span class="nx">values</span> <span class="o">:=</span> <span class="nf">getAllocFreeParams</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="nx">original</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
		<span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">values</span>
	<span class="p">}</span>
	<span class="c1">// 路由包含参数时
</span><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">routeParams</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// 匹配参数
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">paramPos</span><span class="p">,</span> <span class="nx">match</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">routeParser</span><span class="p">.</span><span class="nf">getMatch</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">use</span><span class="p">);</span> <span class="nx">match</span> <span class="p">{</span>
			<span class="c1">// 从源请求路径中解析出参数值
</span><span class="c1"></span>			<span class="k">return</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">routeParser</span><span class="p">.</span><span class="nf">paramsForPos</span><span class="p">(</span><span class="nx">original</span><span class="p">,</span> <span class="nx">paramPos</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="c1">// 是否中间件
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">use</span> <span class="p">{</span>
		<span class="c1">// 根路由或者路由路径是请求路径的前缀
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">root</span> <span class="o">||</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">values</span>
		<span class="p">}</span>
		<span class="c1">// 路由路径和请求路径相同
</span><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">path</span> <span class="o">==</span> <span class="nx">path</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">values</span>
	<span class="p">}</span>
	<span class="c1">// 不匹配
</span><span class="c1"></span>	<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">values</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>路由匹配函数的匹配过程如下：</p>
<ol>
<li>匹配根路径<code>/</code></li>
<li>通配符路径<code>/*</code>，参数<code>*</code>的值就是源请求路径的去掉首字符之后的字符串<code>original[1:]</code></li>
<li>路由包含参数的话，使用路由解析器<a href="#%E8%B7%AF%E7%94%B1%E5%8F%82%E6%95%B0%E5%8C%B9%E9%85%8D">匹配</a>参数位置，匹配时，从源请求路径获取参数对应的值</li>
<li>中间件路由的情况下，根路由或者路由路径是请求路径的前缀也算匹配，例如<code>/api</code>匹配<code>/api/v1</code></li>
<li>最后检查路径是否相等</li>
</ol>
<h3 id="路由参数匹配">路由参数匹配</h3>
<p>带参数的路由匹配<code>func (p *routeParser) getMatch(s string, partialCheck bool) ([][2]int, bool)</code>方法，是最复杂的部分，我们单独拎出来讲，代码不贴了，详见<a href="https://github.com/gofiber/fiber/blob/v1.12.1/path.go#L109-L169">源码</a>：</p>
<ul>
<li>根据参数数量，获取预分配内存的参数位置切片</li>
<li>遍历路由解析器<code>routeParser</code>中所有的<code>segment</code></li>
<li><code>partLen = len(s)</code>获取需要匹配的请求路径长度</li>
<li>先看常量类型的<code>segment</code>匹配：
<ul>
<li><code>i = len(segment.Const)</code>获取常量字符串长度</li>
<li><code>partLen &lt; i || (i == 0 &amp;&amp; partLen &gt; 0)</code>先匹配长度</li>
<li><code>s[:i] != segment.Const</code>再匹配常量字符串值</li>
<li><code>(partLen &gt; i &amp;&amp; s[i] != segment.EndChar)</code>最后匹配终止符</li>
<li>若以上有不匹配的，则直接返回</li>
</ul>
</li>
<li>再看参数类型的<code>segment</code>匹配，目标是计算出参数长度：
<ul>
<li>通配符参数
<ul>
<li>当前<code>segment</code>是最后一个时，参数长度为剩余请求路径长度</li>
<li>从右向左贪婪匹配(<a href="https://github.com/gofiber/fiber/blob/v1.12.1/path.go#L186-L213">源码</a>)最长的字符串长度，当作参数长度</li>
</ul>
</li>
<li>非通配符参数，根据当前<code>segment</code>的终止符查找，没找到的话，参数长度为剩余请求路径长度</li>
<li><code>segment</code>不是可选参数且参数长度为0，直接返回</li>
<li>终止符不匹配，也直接返回</li>
<li>记录当前<code>segment</code>参数对应的位置，自增参数位置下标迭代器</li>
</ul>
</li>
<li>根据匹配串的长度，调整请求路径切片和下一个参数起始位置</li>
<li>若请求路径未匹配完全，且不是部分匹配（中间件前缀匹配），则直接返回</li>
<li>成功返回参数切片位置和匹配成功标识</li>
</ul>
<p>取得参数位置后，我们就可以在源请求路径中截取出参数对应的值(<a href="https://github.com/gofiber/fiber/blob/v1.12.1/path.go#L171-L184">源码</a>)。</p>
<h2 id="总结">总结</h2>
<p><code>Fiber</code>的路由管理使用了很简单的数据结构——<code>slice</code>，每种<code>Http method</code>对应一组路由栈，而不是像<a href="https://github.com/gin-gonic/gin">gin</a>一样使用<a href="https://en.wikipedia.org/wiki/Radix_tree">基数树</a>这种数据结构，详细原因见<a href="#%E5%85%B6%E4%BB%96">文末</a>。最后作一下总结：</p>
<ul>
<li>注册路由时，分析路径，将其分段，保存元数据到路由栈中</li>
<li>匹配路由时，逐个匹配请求<code>method</code>对应的路由栈，匹配时执行相应的处理器</li>
</ul>
<h2 id="其他">其他</h2>
<p><code>Fiber</code>作者<a href="https://github.com/Fenny">Fenny</a>关于为什么不使用<a href="https://en.wikipedia.org/wiki/Radix_tree">基数树</a>管理路由的回答：</p>
<blockquote>
<p>We discussed using a radix tree, but we would lose the stack order flexibility (like express has).</p>
<p>Another thing I would like to mention which is misconception by many, the performance of decent routers will not impact your application.</p>
<p>When you have 10,000 routes, you still talking about nano seconds. If you have a database query in one of your handlers, the performance of the router would not matter anymore.</p>
<p>However, we made sure our router is 💯 regarding allocation and performance. And <a href="https://github.com/ReneWerner87">@René</a> did an awesome job to replicate most key features of the expressjs path behaviour.</p>
<p>Which makes routes like /api/*/:param/:param2 ~&gt; /api/joker/batman/robin/2/1 possible, only in Fiber.</p>
</blockquote>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Kiyon Lin</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2020-07-01
      
        
        
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://kiyonlin.github.io/tags/golang/">golang</a>
          <a href="https://kiyonlin.github.io/tags/gofiber/">gofiber</a>
          <a href="https://kiyonlin.github.io/tags/web/">web</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/work/fasthttp/01fh%E8%AF%B7%E6%B1%82%E8%A1%8C/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Fasthttp系列——请求行</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/work/gofiber/fiber-limiter/">
            <span class="next-text nav-default">基于延迟计算令牌桶的gofiber频率限制中间件实现</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "kiyonlin/kiyonlin.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:kiyonlin@163.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
  
  
  
  
  
    <a href="https://github.com/kiyonlin" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
  
    <a href="https://www.zhihu.com/people/kiyonlin" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>
  
  
  
  
  
  
  
  
  
  


<a href="https://kiyonlin.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2016 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Kiyon Lin
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
