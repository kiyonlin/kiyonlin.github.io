<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>鸟哥Linux基础-进阶文件系统管理-LVM - Tsing Wind - 清风徐来 水波不兴</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Kiyon Lin" />
  <meta name="description" content="原文鸟哥的 Linux私房菜 什么是LVM LVM 的全名是Logical Volume Manager，逻辑卷轴管理员。LVM 的作法是将几个物理的partition" />

  <meta name="keywords" content="Hugo, theme, kiyon, kiyonlin" />






<meta name="generator" content="Hugo 0.72.0" />


<link rel="canonical" href="https://kiyonlin.github.io/post/work/linux/%E9%B8%9F%E5%93%A5linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-lvm/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/kiyon.min.fa3d941d1d0e0ddc985804227feabffea55c89883eb0af34e0532a7ae9135151.css" integrity="sha256-&#43;j2UHR0ODdyYWAQif&#43;q//qVciYg&#43;sK804FMqeukTUVE=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="鸟哥Linux基础-进阶文件系统管理-LVM" />
<meta property="og:description" content="原文鸟哥的 Linux私房菜 什么是LVM LVM 的全名是Logical Volume Manager，逻辑卷轴管理员。LVM 的作法是将几个物理的partition" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kiyonlin.github.io/post/work/linux/%E9%B8%9F%E5%93%A5linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-lvm/" />
<meta property="article:published_time" content="2017-04-21T10:02:09+00:00" />
<meta property="article:modified_time" content="2017-04-21T10:02:09+00:00" />
<meta itemprop="name" content="鸟哥Linux基础-进阶文件系统管理-LVM">
<meta itemprop="description" content="原文鸟哥的 Linux私房菜 什么是LVM LVM 的全名是Logical Volume Manager，逻辑卷轴管理员。LVM 的作法是将几个物理的partition">
<meta itemprop="datePublished" content="2017-04-21T10:02:09&#43;00:00" />
<meta itemprop="dateModified" content="2017-04-21T10:02:09&#43;00:00" />
<meta itemprop="wordCount" content="8179">



<meta itemprop="keywords" content="linux,LVM," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="鸟哥Linux基础-进阶文件系统管理-LVM"/>
<meta name="twitter:description" content="原文鸟哥的 Linux私房菜 什么是LVM LVM 的全名是Logical Volume Manager，逻辑卷轴管理员。LVM 的作法是将几个物理的partition"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Tsing Wind</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/kiyonlin" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Tsing Wind
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://kiyonlin.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/kiyonlin" rel="noopener" target="_blank">
              Github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">鸟哥Linux基础-进阶文件系统管理-LVM</h1>
      
      <div class="post-meta">
        <time datetime="2017-04-21" class="post-time">
          2017-04-21
        </time>
        <div class="post-category">
            <a href="https://kiyonlin.github.io/categories/linux/"> linux </a>
            
          </div>
        <span class="more-meta"> 约 8179 字 </span>
          <span class="more-meta"> 预计阅读 17 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#什么是lvm">什么是LVM</a>
      <ul>
        <li><a href="#physical-volume-pv-物理卷轴">Physical Volume, PV, 物理卷轴</a></li>
        <li><a href="#volume-group-vg-卷轴群组">Volume Group, VG, 卷轴群组</a></li>
        <li><a href="#physical-extent-pe-物理范围区块">Physical Extent, PE, 物理范围区块</a></li>
        <li><a href="#logical-volume-lv-逻辑卷轴">Logical Volume, LV, 逻辑卷轴</a></li>
      </ul>
    </li>
    <li><a href="#lvm-操作流程">LVM 操作流程</a>
      <ul>
        <li><a href="#0-disk-阶段实际的磁盘">0. Disk 阶段(实际的磁盘)</a></li>
        <li><a href="#1-pv-阶段">1. PV 阶段</a></li>
        <li><a href="#2-vg-阶段">2. VG 阶段</a></li>
        <li><a href="#3-lv-阶段">3. LV 阶段</a></li>
        <li><a href="#文件系统阶段">文件系统阶段</a></li>
        <li><a href="#放大lv-容量">放大LV 容量</a></li>
      </ul>
    </li>
    <li><a href="#使用lvm-thin-volume-让lvm-动态自动调整磁盘使用率">使用LVM thin Volume 让LVM 动态自动调整磁盘使用率</a></li>
    <li><a href="#lvm-的lv-磁盘快照">LVM 的LV 磁盘快照</a>
      <ul>
        <li><a href="#传统快照区的建立">传统快照区的建立</a></li>
        <li><a href="#利用快照区复原系统">利用快照区复原系统</a></li>
      </ul>
    </li>
    <li><a href="#lvm-的关闭">LVM 的关闭</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>原文<a href="http://linux.kiyon.org/">鸟哥的 Linux私房菜</a></p>
<h2 id="什么是lvm">什么是LVM</h2>
<p>LVM 的全名是Logical Volume Manager，逻辑卷轴管理员。LVM 的作法是将几个物理的partitions (或disk) 通过软件组合成为一块看起来是独立的大磁盘(VG) ，然后将这块大磁盘再经过分割成为可使用分区(LV)，最终就能够挂载使用了。但是为什么这样的系统可以进行filesystem 的扩充或缩小呢？其实与一个称为PE 的项目有关。</p>
<h3 id="physical-volume-pv-物理卷轴">Physical Volume, PV, 物理卷轴</h3>
<p>我们实际的partition (或Disk)需要调整系统识别码(system ID)成为8e (LVM的识别码)，然后再经过pvcreate的指令将它转成LVM最底层的物理卷轴(PV) ，之后才能够将这些PV加以利用！调整system ID的方是就是通过gdisk进行！</p>
<h3 id="volume-group-vg-卷轴群组">Volume Group, VG, 卷轴群组</h3>
<p>所谓的LVM 大磁盘就是将许多PV 整合成这个VG ！所以VG 就是LVM 组合起来的大磁盘！那么这个大磁盘最大可以到多少容量呢？这与底下要说明的PE 以及LVM 的格式版本有关。在预设的情况下， 使用32位的Linux 系统时，基本上LV 最大仅能支持到65534 个PE 而已，若使用预设的PE为4MB 的情况下， 最大容量则仅能达到约256GB 而已。不过，这个问题在64位的Linux 系统上面已经不存在了！LV 几乎没有啥容量限制！</p>
<h3 id="physical-extent-pe-物理范围区块">Physical Extent, PE, 物理范围区块</h3>
<p>LVM预设使用4MB的PE区块，而LVM的LV在32位系统上最多仅能含有65534个PE (lvm1的格式)，因此预设的LVM的LV会有4M*65534/(1024M/G )=256G。PE是整个LVM最小的储存区块，也就是说，其实我们的文件资料都是藉由写入PE来处理的。简单的说，这个PE就有点像文件系统里面的block大小。所以调整PE会影响到LVM的最大容量！不过，在CentOS 6.x以后，由于直接使用lvm2的各项格式功能，以及系统转为64位，因此这个限制已经不存在了。</p>
<h3 id="logical-volume-lv-逻辑卷轴">Logical Volume, LV, 逻辑卷轴</h3>
<p>最终的VG还会被切成LV，这个LV就是最后可以被格式化使用的类似分区的东西！那么LV是否可以随意指定大小呢？当然不可以！既然PE是整个LVM的最小储存单位，那么LV的大小就与在此LV内的PE总数有关。为了方便使用者利用LVM来管理其系统，因此LV的设备档名通常指定为『 /dev/vgname/lvname』的样式！</p>
<p>此外，我们刚刚有谈到LVM 可弹性的变更filesystem 的容量，那是如何办到的？其实就是通过『交换PE 』来进行资料转换， 将原本LV 内的PE 移转到其他设备中以降低LV 容量，或将其他设备的PE 加到此LV 中以加大容量！</p>
<h2 id="lvm-操作流程">LVM 操作流程</h2>
<h3 id="0-disk-阶段实际的磁盘">0. Disk 阶段(实际的磁盘)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># gdisk -l /dev/vda</span>
Number  Start <span class="o">(</span>sector<span class="o">)</span>    End <span class="o">(</span>sector<span class="o">)</span>  Size       Code  Name
   <span class="m">1</span>            <span class="m">2048</span>            <span class="m">6143</span>   2.0 MiB     EF02
   <span class="m">2</span>            <span class="m">6144</span>         <span class="m">2103295</span>   1024.0 MiB  <span class="m">0700</span>
   <span class="m">3</span>         <span class="m">2103296</span>        <span class="m">65026047</span>   30.0 GiB    8E00
   <span class="m">4</span>        <span class="m">65026048</span>        <span class="m">67123199</span>   1024.0 MiB  <span class="m">8300</span>  Linux filesystem
   <span class="m">5</span>        <span class="m">75511808</span>        <span class="m">77608959</span>   1024.0 MiB  8E00  Linux LVM
   <span class="m">6</span>        <span class="m">69220352</span>        <span class="m">71317503</span>   1024.0 MiB  8E00  Linux LVM
   <span class="m">7</span>        <span class="m">71317504</span>        <span class="m">73414655</span>   1024.0 MiB  8E00  Linux LVM
   <span class="m">8</span>        <span class="m">73414656</span>        <span class="m">75511807</span>   1024.0 MiB  8E00  Linux LVM
   <span class="m">9</span>        <span class="m">77608960</span>        <span class="m">79706111</span>   1024.0 MiB  8E00  Linux LVM
<span class="c1">## 其实system ID不改变也没关系！只是为了让我们管理员清楚知道该partition的内容，</span>
<span class="c1">## 所以这里建议还是修改成正确的磁盘内容较好！</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的/dev/sda{5,6,7,8} 这4 个分区就是我们的物理分区！也就是底下会实际用到的信息！至于/dev/sda9 则先保留下来不使用。注意看，那个8e 的出现会导致system 变成『 Linux LVM 』！其实没有设定成为8e 也没关系， 不过某些LVM 的侦测指令可能会侦测不到该partition。</p>
<h3 id="1-pv-阶段">1. PV 阶段</h3>
<p>要建立PV 其实很简单，只要直接使用pvcreate 即可！</p>
<ul>
<li>pvcreate ：将物理partition 建立成为PV ；</li>
<li>pvscan ：搜寻目前系统里面任何具有PV 的磁盘；</li>
<li>pvdisplay ：显示出目前系统上面的PV 状态；</li>
<li>pvremove ：将PV 属性移除，让该partition 不具有PV 属性。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">
<span class="c1">## 1.检查有无PV在系统上，然后将/dev/sda{5-8}建立成为PV格式</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># pvscan</span>
  PV /dev/sda3   VG centos          lvm2 <span class="o">[</span>30.00 GiB / 14.00 GiB free<span class="o">]</span>
    Total: <span class="m">1</span> <span class="o">[</span>30.00 GiB<span class="o">]</span> / in use: <span class="m">1</span> <span class="o">[</span>30.00 GiB<span class="o">]</span> / in no VG: <span class="m">0</span> <span class="o">[</span><span class="m">0</span>   <span class="o">]</span>
<span class="c1">## 其实安装的时候，我们就有使用LVM 了喔！所以会有/dev/vda3 存在的！</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># pvcreate /dev/sda{5,6,7,8}</span>
  Physical volume <span class="s2">&#34;/dev/sda5&#34;</span> successfully created.
  Physical volume <span class="s2">&#34;/dev/sda6&#34;</span> successfully created.
  Physical volume <span class="s2">&#34;/dev/sda7&#34;</span> successfully created.
  Physical volume <span class="s2">&#34;/dev/sda8&#34;</span> successfully created.
<span class="c1">## 这个指令可以一口气建立这四个partition 成为PV ！注意大括号的用途</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># pvscan</span>
  PV /dev/sda3   VG centos          lvm2 <span class="o">[</span>30.00 GiB / 14.00 GiB free<span class="o">]</span>
  PV /dev/sda7                      lvm2 <span class="o">[</span>1.00 GiB<span class="o">]</span>
  PV /dev/sda8                      lvm2 <span class="o">[</span>1.00 GiB<span class="o">]</span>
  PV /dev/sda6                      lvm2 <span class="o">[</span>1.00 GiB<span class="o">]</span>
  PV /dev/sda5                      lvm2 <span class="o">[</span>1.00 GiB<span class="o">]</span>
  Total: <span class="m">5</span> <span class="o">[</span>34.00 GiB<span class="o">]</span> / in use: <span class="m">1</span> <span class="o">[</span>30.00 GiB<span class="o">]</span> / in no VG: <span class="m">4</span> <span class="o">[</span>4.00 GiB<span class="o">]</span>
<span class="c1">## 这就分别显示每个PV 的信息与系统所有PV 的信息。尤其最后一行，显示的是：</span>
<span class="c1">## 整体PV 的量 / 已经被使用到VG 的PV 量 / 剩余的PV 量</span>

<span class="c1">## 2.更详细的列示出系统上面每个PV的个别信息：</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># pvdisplay /dev/sda5</span>
  <span class="s2">&#34;/dev/sda5&#34;</span> is a new physical volume of <span class="s2">&#34;1.00 GiB&#34;</span>
  --- NEW Physical volume ---
  PV Name               /dev/sda5
  VG Name
  PV Size               1.00 GiB
  Allocatable           NO
  PE Size               <span class="m">0</span>
  Total PE              <span class="m">0</span>
  Free PE               <span class="m">0</span>
  Allocated PE          <span class="m">0</span>
  PV UUID               hiIqyY-CcAj-qImn-6MWn-07Ed-XJgf-3wzMul
<span class="c1">## 由于PE 是在建立VG 时才给予的参数，因此在这里看到的PV 里头的PE 都会是 0</span>
<span class="c1">## 而且也没有多余的PE 可供分配(allocatable)。</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="2-vg-阶段">2. VG 阶段</h3>
<ul>
<li>vgcreate ：建立VG 的指令。</li>
<li>vgscan ：搜寻系统上面是否有VG 存在；</li>
<li>vgdisplay ：显示目前系统上面的VG 状态；</li>
<li>vgextend ：在VG 内增加额外的PV ；</li>
<li>vgreduce ：在VG 内移除PV；</li>
<li>vgchange ：设定VG 是否启动(active)；</li>
<li>vgremove ：删除一个VG。</li>
</ul>
<p>与PV 不同的是， VG 的名称是自定义的！我们知道PV 的名称其实就是partition 的设备文件名， 但是这个VG 名称则可以随便自己取。建立这个 VG 的流程是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## vgcreate [-s N[mgt]] VG名称PV名称</span>
<span class="c1">## 选项与参数：</span>
<span class="c1">## -s ：后面接PE 的大小(size) ，单位可以是m, g, t (大小写均可)</span>

<span class="c1">## 1.将/dev/sda5-7建立成为一个VG，且指定PE为16MB！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># vgcreate -s 16M kiyonvg /dev/sda{5,6,7}</span>
  Volume group <span class="s2">&#34;kiyonvg&#34;</span> successfully created

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># vgscan</span>
  Reading volume groups from cache.
  Found volume group <span class="s2">&#34;kiyonvg&#34;</span> using metadata <span class="nb">type</span> lvm2
  Found volume group <span class="s2">&#34;centos&#34;</span> using metadata <span class="nb">type</span> lvm2

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># pvscan</span> 
  PV /dev/sda5   VG kiyonvg         lvm2 <span class="o">[</span>1008.00 MiB / 1008.00 MiB free<span class="o">]</span>
  PV /dev/sda6   VG kiyonvg         lvm2 <span class="o">[</span>1008.00 MiB / 1008.00 MiB free<span class="o">]</span>
  PV /dev/sda7   VG kiyonvg         lvm2 <span class="o">[</span>1008.00 MiB / 1008.00 MiB free<span class="o">]</span>
  PV /dev/sda3   VG centos          lvm2 <span class="o">[</span>30.00 GiB / 14.00 GiB free<span class="o">]</span>
  PV /dev/sda8                      lvm2 <span class="o">[</span>1.00 GiB<span class="o">]</span>
  Total: <span class="m">5</span> <span class="o">[</span>33.95 GiB<span class="o">]</span> / in use: <span class="m">4</span> <span class="o">[</span>32.95 GiB<span class="o">]</span> / in no VG: <span class="m">1</span> <span class="o">[</span>1.00 GiB<span class="o">]</span>
<span class="c1">## 有三个PV 被用去，剩下1 个/dev/sda8 的PV 没被用掉！</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># vgdisplay kiyonvg</span>
  --- Volume group ---
  VG Name               kiyonvg
  System ID
  Format                lvm2
  Metadata Areas        <span class="m">3</span>
  Metadata Sequence No  <span class="m">1</span>
  VG Access             read/write
  VG Status             resizable
  MAX LV                <span class="m">0</span>
  Cur LV                <span class="m">0</span>
  Open LV               <span class="m">0</span>
  Max PV                <span class="m">0</span>
  Cur PV                <span class="m">3</span>
  Act PV                <span class="m">3</span>
  VG Size               2.95 GiB
  PE Size               16.00 MiB
  Total PE              <span class="m">189</span>
  Alloc PE / Size       <span class="m">0</span> / <span class="m">0</span>
  Free  PE / Size       <span class="m">189</span> / 2.95 GiB
  VG UUID               cBoibr-y9mY-90Cl-SRSr-1DAY-lLAZ-Ecbl4u
<span class="c1">## 最后那三行指的就是PE 能够使用的情况！由于尚未切出LV，因此所有的PE 均可自由使用。</span>
</code></pre></td></tr></table>
</div>
</div><p>这样就建立一个VG 了！假设我们要增加这个VG 的容量，因为我们还有/dev/sda8 ！此时可以这样做：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## 2.将剩余的PV (/dev/sda8)丢给kiyonvg</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># vgextend kiyonvg /dev/sda8</span>
  Volume group <span class="s2">&#34;kiyonvg&#34;</span> successfully extended

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># vgdisplay kiyonvg</span> 
<span class="c1">## ....(前面省略)....</span>
  VG Size               3.94 GiB
  PE Size               16.00 MiB
  Total PE              <span class="m">252</span>
  Alloc PE / Size       <span class="m">0</span> / <span class="m">0</span>
  Free  PE / Size       <span class="m">252</span> / 3.94 GiB
  VG UUID               cBoibr-y9mY-90Cl-SRSr-1DAY-lLAZ-Ecbl4u
</code></pre></td></tr></table>
</div>
</div><h3 id="3-lv-阶段">3. LV 阶段</h3>
<p>创造出VG 这个大磁盘之后，再来就是要建立分割区啦！这个分割区就是所谓的LV ！假设我要将刚刚那个 kiyonvg 磁盘，分割成为kiyonlv ，整个VG 的容量都被分配到kiyonlv 里面去。</p>
<ul>
<li>lvcreate ：建立LV！</li>
<li>lvscan ：查询系统上面的LV ；</li>
<li>lvdisplay ：显示系统上面的LV 状态！</li>
<li>lvextend ：在LV 里面增加容量！</li>
<li>lvreduce ：在LV 里面减少容量；</li>
<li>lvremove ：删除一个LV ！</li>
<li>lvresize ：对LV 进行容量大小的调整！</li>
</ul>
<p>命令详解：
<code>lvcreate [-LN[mgt]] [-n LV名称] VG名称</code>
<code>lvcreate [-l N] [-n LV名称] VG名称</code>
选项与参数：</p>
<ul>
<li>-L ：后面接容量，容量的单位可以是M,G,T 等，要注意的是，最小单位为PE，
因此这个数量必须要是PE 的倍数，若不相符，系统会自行计算最相近的容量。</li>
<li>-l ：后面可以接PE 的『个数』，而不是数量。若要这么做，得要自行计算PE 数。</li>
<li>-n ：后面接的就是LV 的名称！</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## 1.将kiyonvg分2GB给kiyonlv！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvcreate -L 2G -n kiyonlv kiyonvg</span>
  Logical volume <span class="s2">&#34;kiyonlv&#34;</span> created
<span class="c1">## 由于本案例中每个PE 为16M ，如果要用PE 的数量来处理的话，那使用下面的指令也OK！</span>
<span class="c1">## lvcreate -l 128 -n kiyonlv kiyonvg</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvscan</span> 
  ACTIVE            <span class="s1">&#39;/dev/kiyonvg/kiyonlv&#39;</span> <span class="o">[</span>2.00 GiB<span class="o">]</span> inherit
  ACTIVE            <span class="s1">&#39;/dev/centos/root&#39;</span>     <span class="o">[</span>10.00 GiB<span class="o">]</span> inherit
  ACTIVE            <span class="s1">&#39;/dev/centos/home&#39;</span>     <span class="o">[</span>5.00 GiB<span class="o">]</span> inherit
  ACTIVE            <span class="s1">&#39;/dev/centos/swap&#39;</span>     <span class="o">[</span>1.00 GiB<span class="o">]</span> inherit

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvdisplay /dev/kiyonvg/kiyonlv</span>
  --- Logical volume ---
  LV Path                /dev/kiyonvg/kiyonlv
  LV Name                kiyonlv
  VG Name                kiyonvg
  LV UUID                1t1324-TfsC-bx5M-P9Ee-MeMK-Cjs3-m94yH2
  LV Write Access        read/write
  LV Creation host, <span class="nb">time</span> study.centos.kiyon, 2017-04-21 14:18:30 +0800
  LV Status              available
  <span class="c1"># open                 0</span>
  LV Size                2.00 GiB
  Current LE             <span class="m">128</span>
  Segments               <span class="m">3</span>
  Allocation             inherit
  Read ahead sectors     auto
  - currently <span class="nb">set</span> to     <span class="m">8192</span>
  Block device           253:3
</code></pre></td></tr></table>
</div>
</div><p>如此一来，整个LV partition也准备好了！接下来，就是针对这个LV来处理！要特别注意的是， VG的名称为kiyonvg ，但是LV的名称必须使用全名/dev/kiyonvg/kiyonlv才对！后续的处理都是这样的！</p>
<h3 id="文件系统阶段">文件系统阶段</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## 1.格式化、挂载与观察我们的LV吧！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># mkfs.xfs /dev/kiyonvg/kiyonlv  #&lt;==注意LV全名！</span>
meta-data<span class="o">=</span>/dev/kiyonvg/kiyonlv   <span class="nv">isize</span><span class="o">=</span><span class="m">512</span>    <span class="nv">agcount</span><span class="o">=</span>4, <span class="nv">agsize</span><span class="o">=</span><span class="m">131072</span> <span class="nv">blks</span>
         <span class="o">=</span>                       <span class="nv">sectsz</span><span class="o">=</span><span class="m">4096</span>  <span class="nv">attr</span><span class="o">=</span>2, <span class="nv">projid32bit</span><span class="o">=</span><span class="nv">1</span>
         <span class="o">=</span>                       <span class="nv">crc</span><span class="o">=</span><span class="m">1</span>        <span class="nv">finobt</span><span class="o">=</span>0, <span class="nv">sparse</span><span class="o">=</span><span class="m">0</span>
<span class="nv">data</span>     <span class="o">=</span>                       <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>524288, <span class="nv">imaxpct</span><span class="o">=</span><span class="nv">25</span>
         <span class="o">=</span>                       <span class="nv">sunit</span><span class="o">=</span><span class="m">0</span>      <span class="nv">swidth</span><span class="o">=</span><span class="m">0</span> blks
<span class="nv">naming</span>   <span class="o">=</span>version <span class="m">2</span>              <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   ascii-ci<span class="o">=</span><span class="m">0</span> <span class="nv">ftype</span><span class="o">=</span><span class="m">1</span>
<span class="nv">log</span>      <span class="o">=</span>internal log           <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>2560, <span class="nv">version</span><span class="o">=</span><span class="nv">2</span>
         <span class="o">=</span>                       <span class="nv">sectsz</span><span class="o">=</span><span class="m">4096</span>  <span class="nv">sunit</span><span class="o">=</span><span class="m">1</span> blks, lazy-count<span class="o">=</span><span class="m">1</span>
<span class="nv">realtime</span> <span class="o">=</span>none                   <span class="nv">extsz</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>0, <span class="nv">rtextents</span><span class="o">=</span><span class="m">0</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># mkdir /srv/lvm</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># mount /dev/kiyonvg/kiyonlv /srv/lvm</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv xfs   2.0G   33M  2.0G   2% /srv/lvm

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># cp -a /etc /var/log /srv/lvm</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv xfs   2.0G   74M  2.0G   4% /srv/lvm
</code></pre></td></tr></table>
</div>
</div><h3 id="放大lv-容量">放大LV 容量</h3>
<ol>
<li>
<p>VG阶段需要有剩余的容量：因为需要放大文件系统，所以需要放大LV，但是若没有多的VG容量，那么更上层的LV与文件系统就无法放大的。因此要用尽各种方法来产生多的VG容量才行。一般来说，如果VG容量不足，最简单的方法就是再加硬盘！然后将该硬盘使用上面讲过的pvcreate及vgextend增加到该VG内即可！</p>
</li>
<li>
<p>LV阶段产生更多的可用容量：如果VG的剩余容量足够了，此时就可以利用lvresize这个指令来将剩余容量加入到所需要增加的LV设备内！过程相当简单！</p>
</li>
<li>
<p>文件系统阶段的放大：我们的Linux实际使用的其实不是LV啊！而是LV这个设备内的文件系统！所以一切最终还是要以文件系统为依归！目前在Linux环境下，可以放大的文件系统有XFS以及EXT家族！至于缩小仅有EXT家族，目前XFS文件系统并不支持文件系统的容量缩小！要注意！要注意！XFS放大文件系统通过简单的xfs_growfs指令即可！</p>
</li>
</ol>
<p>针对/srv/lvm 再增加500M 的容量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## 1.由前面的过程我们知道/srv/lvm是/dev/kiyonvg/kiyonlv这个设备，所以检查kiyonvg吧！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># vgdisplay kiyonvg</span>
  --- Volume group ---
  VG Name               kiyonvg
  System ID
  Format                lvm2
  Metadata Areas        <span class="m">4</span>
  Metadata Sequence No  <span class="m">3</span>
  VG Access             read/write
  VG Status             resizable
  MAX LV                <span class="m">0</span>
  Cur LV                <span class="m">1</span>
  Open LV               <span class="m">1</span>
  Max PV                <span class="m">0</span>
  Cur PV                <span class="m">4</span>
  Act PV                <span class="m">4</span>
  VG Size               3.94 GiB
  PE Size               16.00 MiB
  Total PE              <span class="m">252</span>
  Alloc PE / Size       <span class="m">128</span> / 2.00 GiB
  Free  PE / Size       <span class="m">124</span> / 1.94 GiB
  VG UUID               cBoibr-y9mY-90Cl-SRSr-1DAY-lLAZ-Ecbl4u
<span class="c1">## 既然VG 的容量够大了！所以直接来放大LV 吧！！</span>

<span class="c1">## 2.放大LV吧！利用lvresize的功能来增加！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvresize -L +500M /dev/kiyonvg/kiyonlv</span>
  Rounding size to boundary between physical extents: 512.00 MiB.
  Size of logical volume kiyonvg/kiyonlv changed from 2.00 GiB <span class="o">(</span><span class="m">128</span> extents<span class="o">)</span> to 2.50 GiB <span class="o">(</span><span class="m">160</span> extents<span class="o">)</span>.
  Logical volume kiyonvg/kiyonlv successfully resized.
<span class="c1">## 这样就增加了LV 了！lvresize 的语法很简单，基本上同样通过-l 或-L 来增加！</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvscan</span> 
  ACTIVE            <span class="s1">&#39;/dev/kiyonvg/kiyonlv&#39;</span> <span class="o">[</span>2.50 GiB<span class="o">]</span> inherit
  ACTIVE            <span class="s1">&#39;/dev/centos/root&#39;</span> <span class="o">[</span>10.00 GiB<span class="o">]</span> inherit
  ACTIVE            <span class="s1">&#39;/dev/centos/home&#39;</span> <span class="o">[</span>5.00 GiB<span class="o">]</span> inherit
  ACTIVE            <span class="s1">&#39;/dev/centos/swap&#39;</span> <span class="o">[</span>1.00 GiB<span class="o">]</span> inherit
<span class="c1">## 可以发现/dev/kiyonvg/kiyonlv 容量由2G 增加到2.5G ！</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv xfs   2.0G   74M  2.0G   4% /srv/lvm
</code></pre></td></tr></table>
</div>
</div><p>最终的结果中LV 真的有放大到2.5GB ！但是文件系统却没有相对增加！我们的LVM 可以线上直接处理，并不需要特别umount ！使用xfs_growfs 来处理一下！</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## 3.1先看一下原本的文件系统内的superblock记录情况吧！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># xfs_info /srv/lvm</span> 
meta-data<span class="o">=</span>/dev/mapper/kiyonvg-kiyonlv <span class="nv">isize</span><span class="o">=</span><span class="m">512</span>    <span class="nv">agcount</span><span class="o">=</span>4, <span class="nv">agsize</span><span class="o">=</span><span class="m">131072</span> <span class="nv">blks</span>
         <span class="o">=</span>                       <span class="nv">sectsz</span><span class="o">=</span><span class="m">4096</span>  <span class="nv">attr</span><span class="o">=</span>2, <span class="nv">projid32bit</span><span class="o">=</span><span class="nv">1</span>
         <span class="o">=</span>                       <span class="nv">crc</span><span class="o">=</span><span class="m">1</span>        <span class="nv">finobt</span><span class="o">=</span><span class="m">0</span> <span class="nv">spinodes</span><span class="o">=</span><span class="m">0</span>
<span class="nv">data</span>     <span class="o">=</span>                       <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>524288, <span class="nv">imaxpct</span><span class="o">=</span><span class="nv">25</span>
         <span class="o">=</span>                       <span class="nv">sunit</span><span class="o">=</span><span class="m">0</span>      <span class="nv">swidth</span><span class="o">=</span><span class="m">0</span> blks
<span class="nv">naming</span>   <span class="o">=</span>version <span class="m">2</span>              <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   ascii-ci<span class="o">=</span><span class="m">0</span> <span class="nv">ftype</span><span class="o">=</span><span class="m">1</span>
<span class="nv">log</span>      <span class="o">=</span>internal               <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>2560, <span class="nv">version</span><span class="o">=</span><span class="nv">2</span>
         <span class="o">=</span>                       <span class="nv">sectsz</span><span class="o">=</span><span class="m">4096</span>  <span class="nv">sunit</span><span class="o">=</span><span class="m">1</span> blks, lazy-count<span class="o">=</span><span class="m">1</span>
<span class="nv">realtime</span> <span class="o">=</span>none                   <span class="nv">extsz</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>0, <span class="nv">rtextents</span><span class="o">=</span><span class="m">0</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># xfs_growfs /srv/lvm   #这一步骤才是最重要的！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># xfs_info /srv/lvm</span> 
meta-data<span class="o">=</span>/dev/mapper/kiyonvg-kiyonlv <span class="nv">isize</span><span class="o">=</span><span class="m">512</span>    <span class="nv">agcount</span><span class="o">=</span>5, <span class="nv">agsize</span><span class="o">=</span><span class="m">131072</span> <span class="nv">blks</span>
         <span class="o">=</span>                       <span class="nv">sectsz</span><span class="o">=</span><span class="m">4096</span>  <span class="nv">attr</span><span class="o">=</span>2, <span class="nv">projid32bit</span><span class="o">=</span><span class="nv">1</span>
         <span class="o">=</span>                       <span class="nv">crc</span><span class="o">=</span><span class="m">1</span>        <span class="nv">finobt</span><span class="o">=</span><span class="m">0</span> <span class="nv">spinodes</span><span class="o">=</span><span class="m">0</span>
<span class="nv">data</span>     <span class="o">=</span>                       <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>655360, <span class="nv">imaxpct</span><span class="o">=</span><span class="nv">25</span>
         <span class="o">=</span>                       <span class="nv">sunit</span><span class="o">=</span><span class="m">0</span>      <span class="nv">swidth</span><span class="o">=</span><span class="m">0</span> blks
<span class="nv">naming</span>   <span class="o">=</span>version <span class="m">2</span>              <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   ascii-ci<span class="o">=</span><span class="m">0</span> <span class="nv">ftype</span><span class="o">=</span><span class="m">1</span>
<span class="nv">log</span>      <span class="o">=</span>internal               <span class="nv">bsize</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>2560, <span class="nv">version</span><span class="o">=</span><span class="nv">2</span>
         <span class="o">=</span>                       <span class="nv">sectsz</span><span class="o">=</span><span class="m">4096</span>  <span class="nv">sunit</span><span class="o">=</span><span class="m">1</span> blks, lazy-count<span class="o">=</span><span class="m">1</span>
<span class="nv">realtime</span> <span class="o">=</span>none                   <span class="nv">extsz</span><span class="o">=</span><span class="m">4096</span>   <span class="nv">blocks</span><span class="o">=</span>0, <span class="nv">rtextents</span><span class="o">=</span><span class="m">0</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv xfs   2.5G   74M  2.5G   3% /srv/lvm

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># ls -l /srv/lvm</span>
total <span class="m">16</span>
drwxr-xr-x. <span class="m">78</span> root root <span class="m">8192</span> Apr <span class="m">21</span> 11:17 etc
drwxr-xr-x.  <span class="m">8</span> root root <span class="m">4096</span> Apr <span class="m">19</span> 14:40 log
<span class="c1">## 刚刚复制进去的资料可还是存在的！并没有消失不见！</span>
</code></pre></td></tr></table>
</div>
</div><p>在上表中，注意看两次xfs_info 的结果，你会发现到1)整个block group (agcount) 的数量增加一个！那个block group 就是纪录新的设备容量之文件系统所在！而你也会2)发现整体的block 数量增加了！这样整个文件系统就给他放大了！同时，使用df 去查阅时，就真的看到增加的量了！文件系统的放大可以在On-line 的环境下操作。</p>
<p>目前的XFS 文件系统中，并没有缩小文件系统容量的设计！也就是说，文件系统只能放大不能缩小喔！如果你想要保有放大、缩小的本事， 那还请回去使用EXT 家族最新的EXT4 文件系统啰！XFS 目前是办不到的！</p>
<h2 id="使用lvm-thin-volume-让lvm-动态自动调整磁盘使用率">使用LVM thin Volume 让LVM 动态自动调整磁盘使用率</h2>
<p>LVM thin Volume 的概念是：先建立一个可以实支实付、用多少容量才分配实际写入多少容量的磁盘容量储存池(thin pool)， 然后再由这个thin pool 去产生一个『指定要固定容量大小的LV 设备』，这个LV 就有趣了！虽然你会看到『表面上，它的容量可能有10GB ，但实际上， 该设备用到多少容量时，才会从thin pool 去实际取得所需要的容量』！可能thin pool 仅有1GB 的容量， 但是可以分配给一个10GB 的LV 设备！而该设备实际使用到500M 时，整个thin pool 才分配500M 给该LV ！当然啦！在所有由thin pool 所分配出来的LV 设备中，总实际使用量绝不能超过thin pool 的最大实际容量！如这个案例说的， thin pool 仅有1GB， 那所有的由这个thin pool 建置出来的LV 设备内的实际用量，就绝不能超过1GB ！</p>
<p>实际操作：</p>
<ul>
<li>由kiyonvg 的剩余容量取出1GB 来做出一个名为kiyontpool 的thin pool LV 设备，这就是所谓的磁盘容量储存池(thin pool)</li>
<li>由kiyonvg 内的kiyontpool 产生一个名为kiyonthin 的10GB LV 设备</li>
<li>将此设备实际格式化为xfs 文件系统，并且挂载于/srv/thin 目录内！</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## 1.先以lvcreate来建立kiyontpool这个thin pool设备：</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvcreate -L 1G -T kiyonvg/kiyontpool   #最重要的建置指令</span> 
  Using default stripesize 64.00 KiB.
  Logical volume <span class="s2">&#34;kiyontpool&#34;</span> created.
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvdisplay /dev/kiyonvg/kiyontpool</span>
  --- Logical volume ---
  LV Name                kiyontpool
  VG Name                kiyonvg
  LV UUID                dGEm2n-ARFT-OjI4-7Q85-bIp1-unqJ-X98pRu
  LV Write Access        read/write
  LV Creation host, <span class="nb">time</span> study.centos.kiyon, 2017-04-21 15:02:50 +0800
  LV Pool metadata       kiyontpool_tmeta
  LV Pool data           kiyontpool_tdata
  LV Status              available
  <span class="c1"># open                 0</span>
  LV Size                1.00 GiB       <span class="c1"># 总共可分配出去的容量</span> 
  Allocated pool data    0.00%          <span class="c1"># 已分配的容量百分比</span> 
  Allocated metadata     0.24%          <span class="c1"># 已分配的中介资料百分比</span>
  Current LE             <span class="m">64</span>
  Segments               <span class="m">1</span>
  Allocation             inherit
  Read ahead sectors     auto
  - currently <span class="nb">set</span> to     <span class="m">8192</span>
  Block device           253:6
<span class="c1">## 非常有趣吧！竟然在LV 设备中还可以有再分配(Allocated) 的项目！果然是储存池！</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvs kiyonvg   #语法为lvs VGname</span> 
  LV         VG      Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  kiyonlv    kiyonvg -wi-ao---- 2.50g
  kiyontpool kiyonvg twi-a-tz-- 1.00g             0.00   0.24
<span class="c1">#这个lvs指令的输出更加简单明了！直接看比较清晰！</span>

<span class="c1">## 2.开始建立kiyonthin这个有10GB的设备，注意！必须使用--thin与kiyontpool连结！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvcreate -V 10G -T kiyonvg/kiyontpool -n kiyonthin</span>
  Using default stripesize 64.00 KiB.
  WARNING: Sum of all thin volume sizes <span class="o">(</span>10.00 GiB<span class="o">)</span> exceeds the size of thin pool kiyonvg/kiyontpool and the size of whole volume group <span class="o">(</span>3.94 GiB<span class="o">)</span>!
  For thin pool auto extension activation/thin_pool_autoextend_threshold should be below 100.
  Logical volume <span class="s2">&#34;kiyonthin&#34;</span> created.
  
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvs kiyonvg</span>
  LV         VG      Attr       LSize  Pool       Origin Data%  Meta%  Move Log Cpy%Sync Convert
  kiyonlv    kiyonvg -wi-ao----  2.50g
  kiyonthin  kiyonvg Vwi-a-tz-- 10.00g kiyontpool        0.00
  kiyontpool kiyonvg twi-aotz--  1.00g                   0.00   0.27
<span class="c1">## 很有趣吧！明明连kiyonvg 这个VG 都没有足够大到10GB 的容量，通过thin pool</span>
<span class="c1">## 竟然就产生了10GB 的kiyonthin 这个设备！</span>

<span class="c1">## 3.开始建立文件系统</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># mkfs.xfs /dev/kiyonvg/kiyonthin</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># mkdir /srv/thin</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># mount /dev/kiyonvg/kiyonthin /srv/thin</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># df -Th /srv/thin</span>
Filesystem                    Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonthin xfs    10G   33M   10G   1% /srv/thin
<span class="c1">## 真的有10GB！！</span>

<span class="c1">## 4.测试一下容量的使用！建立500MB的文件，但不可超过1GB的测试为宜！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># dd if=/dev/zero of=/srv/thin/test.img bs=1M count=500</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvs kiyonvg</span>
  LV         VG      Attr       LSize  Pool       Origin Data%  Meta%  Move Log Cpy%Sync Convert
  kiyonlv    kiyonvg -wi-ao----  2.50g
  kiyonthin  kiyonvg Vwi-aotz-- 10.00g kiyontpool        4.99
  kiyontpool kiyonvg twi-aotz--  1.00g                   49.93  2.00
<span class="c1">## 很要命！这时已经分配出49%以上的容量了！而kiyonthin却只看到用掉5%而已！</span>
<span class="c1">## 所以鸟哥认为，这个thin pool 非常好用！但是在管理上，得要特别特别的留意！</span>
</code></pre></td></tr></table>
</div>
</div><p>这就是用多少算多少的thin pool 操作方式！基本上，用来骗人挺吓人的！小小的一个磁盘可以模拟出好多容量！但实际上，真的可用容量就是实际的磁盘储存池内的容量！如果突破该容量，这个thin pool 可是会爆炸而让资料损毁！要注意！要注意！</p>
<h2 id="lvm-的lv-磁盘快照">LVM 的LV 磁盘快照</h2>
<p>快照就是将当时的系统信息记录下来，就好像照相记录一般！未来若有任何资料更动了，则原始资料会被搬移到快照区，没有被更动的区域则由快照区与文件系统共享。
快照区与被快照的LV必须要在同一个VG上头。</p>
<h3 id="传统快照区的建立">传统快照区的建立</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## 1.先观察VG还剩下多少剩余容量</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># vgdisplay kiyonvg</span> 
<span class="c1">## ....(其他省略)....</span>
  Total PE              <span class="m">252</span>
  Alloc PE / Size       <span class="m">226</span> / 3.53 GiB
  Free  PE / Size       <span class="m">26</span> / 416.00 MiB
<span class="c1">## 就只有剩下26个PE了！全部分配给kiyonsnap1！</span>

<span class="c1">## 2.利用lvcreate建立kiyonlv的快照区，快照被取名为kiyonsnap1，且给予26个PE</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvcreate -s -l 26 -n kiyonsnap1 /dev/kiyonvg/kiyonlv</span>
  Logical volume <span class="s2">&#34;kiyonsnap1&#34;</span> created
<span class="c1">## 上述的指令中最重要的是那个-s 的选项！代表是snapshot 快照功能的意思！</span>
<span class="c1">## -n 后面接快照区的设备名称， /dev/.... 则是要被快照的LV 完整档名。</span>
<span class="c1">## -l 后面则是接使用多少个PE 来作为这个快照区使用。</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvdisplay /dev/kiyonvg/kiyonsnap1</span>
  --- Logical volume ---
  LV Path                /dev/kiyonvg/kiyonspan1
  LV Name                kiyonspan1
  VG Name                kiyonvg
  LV UUID                08alSG-10xu-dRnP-CgfI-smCX-y8Xx-IPxtjw
  LV Write Access        read/write
  LV Creation host, <span class="nb">time</span> study.centos.kiyon, 2017-04-22 09:13:12 +0800
  LV snapshot status     active destination <span class="k">for</span> kiyonlv
  LV Status              available
  <span class="c1"># open                 0</span>
  LV Size                2.50 GiB
  Current LE             <span class="m">160</span>
  COW-table size         416.00 MiB
  COW-table LE           <span class="m">26</span>
  Allocated to snapshot  0.00%
  Snapshot chunk size    4.00 KiB
  Segments               <span class="m">1</span>
  Allocation             inherit
  Read ahead sectors     auto
  - currently <span class="nb">set</span> to     <span class="m">8192</span>
  Block device           253:11
</code></pre></td></tr></table>
</div>
</div><p>/dev/kiyonvg/kiyonsnap1 快照区就被建立起来了！而且它的VG 量与原本的/dev/kiyonvg/kiyonlv 相同！也就是说，如果真的挂载这个设备时，看到的资料会跟原本的kiyonlv 相同！</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># mkdir /srv/snapshot1</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># mount -o nouuid /dev/kiyonvg/kiyonsnap1 /srv/snapshot1</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># df -Th /srv/lvm /srv/ snapshot1</span>
Filesystem                     Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv    xfs   2.5G   74M  2.5G   3% /srv/lvm
/dev/mapper/kiyonvg-kiyonspan1 xfs   2.5G   74M  2.5G   3% /srv/snapshot1
<span class="c1">## /dev/kiyonvg/kiyonsnap1 会主动记录原kiyonlv 的内容！</span>
</code></pre></td></tr></table>
</div>
</div><p>因为XFS 不允许相同的UUID 文件系统的挂载，因此得要加上那个nouuid 的参数，让文件系统忽略相同的UUID 所造成的问题！</p>
<h3 id="利用快照区复原系统">利用快照区复原系统</h3>
<p>要注意的是，要复原的资料量不能够高于快照区所能负载的实际容量。由于原始资料会被搬移到快照区，如果快照区不够大，若原始资料被更动的实际资料量比快照区大，那么快照区当然容纳不了，这时候快照功能会失效！</p>
<p>我们的/srv/lvm 已经有/srv/lvm/etc, /srv/lvm/log 等目录了，接下来将这个文件系统的内容作个变更， 然后再以快照区资料还原看看：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## 1.先将原本的/dev/kiyonvg/kiyonlv内容作些变更，增增减减一些目录吧！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># cp -a /usr/share/doc /srv/lvm</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># rm -rf /srv/lvm/log</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># rm -rf /srv/lvm /etc/sysconfig</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># df -Th /srv/lvm /srv/snapshot1</span>
Filesystem                     Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv    xfs   2.5G  115M  2.4G   5% /srv/lvm
/dev/mapper/kiyonvg-kiyonspan1 xfs   2.5G   74M  2.5G   3% /srv/snapshot1
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># ll /srv/lvm /srv/snapshot1</span>
/srv/lvm:
total 28K
drwxr-xr-x. <span class="m">284</span> root root  12K Apr <span class="m">19</span> 14:26 doc
drwxr-xr-x.  <span class="m">77</span> root root 8.0K Apr <span class="m">22</span> 09:38 etc

/srv/snapshot1:
total 16K
drwxr-xr-x. <span class="m">78</span> root root 8.0K Apr <span class="m">21</span> 11:17 etc
drwxr-xr-x.  <span class="m">8</span> root root 4.0K Apr <span class="m">19</span> 14:40 log
<span class="c1">## 两个目录的内容看起来已经不太一样了！</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvdisplay /dev/kiyonvg/kiyonsnap1</span>
  --- Logical volume ---
  LV Path /dev/kiyonvg/kiyonsnap1
<span class="c1">## ....(中间省略)....</span> 
  Allocated to snapshot  13.12%
<span class="c1">## 列出最重要的部份: 全部的容量已经被用掉了13.12%！</span>

<span class="c1">## 2.利用快照区将原本的filesystem备份，使用xfsdump来处理！</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># xfsdump -l 0 -L lvm1 -M lvm1 -f /home/lvm.dump /srv/snapshot1</span> 
<span class="c1">## 此时就会有一个备份资料/home/lvm.dump了！</span>
</code></pre></td></tr></table>
</div>
</div><p>为什么要备份呢？为什么不可以直接格式化/dev/kiyonvg/kiyonlv 然后将/dev/kiyonvg/kiyonsnap1 直接复制给kiyonlv 呢？要知道kiyonsnap1 其实是kiyonlv 的快照，因此如果你格式化整个kiyonlv 时，原本的文件系统所有资料都会被搬移到kiyonsnap1。那如果kiyonsnap1 的容量不够大(通常也真的不够大)，那么部分资料将无法复制到kiyonsnap1 内，资料当然无法全部还原啊！所以才要在上面制作出一个备份文件！</p>
<p>而快照还有另外一个功能，就是你可以比对/srv/lvm 与/srv/snapshot1 的内容，就能够发现到最近你到底改了啥！</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">## 3.将kiyonsnap1卸载并移除(因为里面的内容已经备份起来了)</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># umount /srv/snapshot1</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvremove /dev/kiyonvg/kiyonsnap1</span> 
Do you really want to remove active logical volume <span class="s2">&#34;kiyonsnap1&#34;</span>? <span class="o">[</span>y/n<span class="o">]</span>: y
  Logical volume <span class="s2">&#34;kiyonsnap1&#34;</span> successfully removed

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># umount /srv/lvm</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># mkfs.xfs -f /dev/kiyonvg/kiyonlv</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># mount /dev/kiyonvg/kiyonlv /srv/lvm</span> 
<span class="o">[</span>root @study ~<span class="o">]</span><span class="c1"># xfsrestore -f /home/lvm.dump -L lvm1 /srv/lvm</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># ll /srv/lvm</span>
total 16K
drwxr-xr-x. <span class="m">78</span> root root 8.0K Apr <span class="m">21</span> 11:17 etc
drwxr-xr-x.  <span class="m">8</span> root root 4.0K Apr <span class="m">19</span> 14:40 log
</code></pre></td></tr></table>
</div>
</div><h2 id="lvm-的关闭">LVM 的关闭</h2>
<p>如果没有将LVM 关闭就直接将那些partition 删除或转为其他用途的话，系统是会发生很大的问题的！所以必须要知道如何将LVM 的设备关闭并移除才行！依据以下的流程来处理即可：</p>
<ul>
<li>先卸载系统上面的LVM 文件系统(包括快照与所有LV)；</li>
<li>使用lvremove 移除LV ；</li>
<li>使用vgchange -an VGname 让VGname 这个VG 不具有Active 的标志；</li>
<li>使用vgremove 移除VG：</li>
<li>使用pvremove 移除PV；</li>
<li>最后，使用fdisk 修改ID 回来！</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># umount /srv/lvm /srv/thin /srv/snapshot1</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvs kiyonvg</span>
  LV         VG      Attr       LSize  Pool       Origin Data%  Meta%  Move Log Cpy%Sync Convert
  kiyonlv    kiyonvg -wi-a-----  2.50g
  kiyonthin  kiyonvg Vwi-a-tz-- 10.00g kiyontpool        4.99
  kiyontpool kiyonvg twi-aotz--  1.00g                   49.93  1.83
<span class="c1">## 要注意！按顺序删除kiyonthin --&gt; kiyontpool --&gt; kiyonlv 比较好！</span>

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvremove /dev/kiyonvg/kiyonthin</span>
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># lvremove /dev/kiyonvg/kiyonlv</span> 
<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># vgchange -an kiyonvg</span>
  <span class="m">0</span> logical volume<span class="o">(</span>s<span class="o">)</span> in volume group <span class="s2">&#34;kiyonvg&#34;</span> now active

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># vgremove kiyonvg</span>
  Volume group <span class="s2">&#34;kiyonvg&#34;</span> successfully removed

<span class="o">[</span>root@study ~<span class="o">]</span><span class="c1"># pvremove /dev/sda{5,6,7,8}</span>
  Labels on physical volume <span class="s2">&#34;/dev/sda5&#34;</span> successfully wiped.
  Labels on physical volume <span class="s2">&#34;/dev/sda6&#34;</span> successfully wiped.
  Labels on physical volume <span class="s2">&#34;/dev/sda7&#34;</span> successfully wiped.
  Labels on physical volume <span class="s2">&#34;/dev/sda8&#34;</span> successfully wiped.
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Kiyon Lin</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2017-04-21
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://kiyonlin.github.io/tags/linux/">linux</a>
          <a href="https://kiyonlin.github.io/tags/lvm/">LVM</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/work/cs/c%E9%A2%84%E5%A4%84%E7%90%86%E5%99%A8/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">C预处理器</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/work/php/phpunit/">
            <span class="next-text nav-default">PHPUnit</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "kiyonlin/kiyonlin.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:kiyonlin@163.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
  
  
  
  
  
    <a href="https://github.com/kiyonlin" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
  
    <a href="https://www.zhihu.com/people/kiyonlin" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>
  
  
  
  
  
  
  
  
  
  


<a href="https://kiyonlin.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2016 -
    2021
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Kiyon Lin
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
