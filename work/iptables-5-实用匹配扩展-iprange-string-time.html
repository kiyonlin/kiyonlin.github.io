<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>iptables详解-5-实用匹配扩展iprange,string,time | 清峰</title>
    <meta name="description" content="瞎逼逼乐呵呵">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0d62e7eb.css" as="style"><link rel="preload" href="/assets/js/app.2d955dbb.js" as="script"><link rel="preload" href="/assets/js/34.d0b5b557.js" as="script"><link rel="prefetch" href="/assets/js/30.345400e7.js"><link rel="prefetch" href="/assets/js/2.f5f0c793.js"><link rel="prefetch" href="/assets/js/3.0c53a62e.js"><link rel="prefetch" href="/assets/js/4.6dc6e921.js"><link rel="prefetch" href="/assets/js/5.f0d8b77a.js"><link rel="prefetch" href="/assets/js/6.7a9758ae.js"><link rel="prefetch" href="/assets/js/7.b51204e9.js"><link rel="prefetch" href="/assets/js/8.c6e4b2c3.js"><link rel="prefetch" href="/assets/js/9.b42a1ed6.js"><link rel="prefetch" href="/assets/js/10.cd90217d.js"><link rel="prefetch" href="/assets/js/11.b90dd23f.js"><link rel="prefetch" href="/assets/js/12.7fd7f019.js"><link rel="prefetch" href="/assets/js/13.5dd26e27.js"><link rel="prefetch" href="/assets/js/14.edbc82f6.js"><link rel="prefetch" href="/assets/js/15.57d836d3.js"><link rel="prefetch" href="/assets/js/16.a6c01c03.js"><link rel="prefetch" href="/assets/js/17.8b192702.js"><link rel="prefetch" href="/assets/js/18.881fd6a9.js"><link rel="prefetch" href="/assets/js/19.2a77eb47.js"><link rel="prefetch" href="/assets/js/20.3125fd14.js"><link rel="prefetch" href="/assets/js/21.65d186d5.js"><link rel="prefetch" href="/assets/js/22.b212c0f6.js"><link rel="prefetch" href="/assets/js/23.f8565e0f.js"><link rel="prefetch" href="/assets/js/24.a5d020f5.js"><link rel="prefetch" href="/assets/js/25.8d212baf.js"><link rel="prefetch" href="/assets/js/26.e32b59c8.js"><link rel="prefetch" href="/assets/js/27.8fee8fa6.js"><link rel="prefetch" href="/assets/js/28.10d662c5.js"><link rel="prefetch" href="/assets/js/29.fc2b7d6f.js"><link rel="prefetch" href="/assets/js/31.0021887b.js"><link rel="prefetch" href="/assets/js/32.6d8cc34a.js"><link rel="prefetch" href="/assets/js/33.400472c3.js"><link rel="prefetch" href="/assets/js/35.dab3d66c.js"><link rel="prefetch" href="/assets/js/36.4204741a.js"><link rel="prefetch" href="/assets/js/37.185d1621.js"><link rel="prefetch" href="/assets/js/38.550aada5.js"><link rel="prefetch" href="/assets/js/39.9e92ee1e.js"><link rel="prefetch" href="/assets/js/40.03a52358.js"><link rel="prefetch" href="/assets/js/41.ef831165.js"><link rel="prefetch" href="/assets/js/42.e0c38418.js"><link rel="prefetch" href="/assets/js/43.da8459a5.js"><link rel="prefetch" href="/assets/js/44.4f569cce.js"><link rel="prefetch" href="/assets/js/45.38642093.js"><link rel="prefetch" href="/assets/js/46.7b97ef73.js"><link rel="prefetch" href="/assets/js/47.f8d75afb.js"><link rel="prefetch" href="/assets/js/48.2e2cb42a.js"><link rel="prefetch" href="/assets/js/49.60a17578.js"><link rel="prefetch" href="/assets/js/50.d45ed52e.js"><link rel="prefetch" href="/assets/js/51.d7919b6f.js"><link rel="prefetch" href="/assets/js/52.99ec12e9.js"><link rel="prefetch" href="/assets/js/53.493ba67b.js"><link rel="prefetch" href="/assets/js/54.5e33cfde.js"><link rel="prefetch" href="/assets/js/55.c8831137.js"><link rel="prefetch" href="/assets/js/56.297ec3bb.js"><link rel="prefetch" href="/assets/js/57.7044d604.js"><link rel="prefetch" href="/assets/js/58.244520da.js"><link rel="prefetch" href="/assets/js/59.7a54d002.js"><link rel="prefetch" href="/assets/js/60.dd3227c0.js"><link rel="prefetch" href="/assets/js/61.2489adfb.js"><link rel="prefetch" href="/assets/js/62.b788d9b9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0d62e7eb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="particles"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">清峰</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页</a></div><div class="nav-item"><a href="/life/" class="nav-link">
  认真生活</a></div><div class="nav-item"><a href="/work/" class="nav-link router-link-active">
  开心工作</a></div><div class="nav-item"><a href="/relax/" class="nav-link">
  劳逸结合</a></div> <a href="https://github.com/kiyonlin" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页</a></div><div class="nav-item"><a href="/life/" class="nav-link">
  认真生活</a></div><div class="nav-item"><a href="/work/" class="nav-link router-link-active">
  开心工作</a></div><div class="nav-item"><a href="/relax/" class="nav-link">
  劳逸结合</a></div> <a href="https://github.com/kiyonlin" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>iptables详解-5-实用匹配扩展iprange,string,time</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/work/iptables-5-%E5%AE%9E%E7%94%A8%E5%8C%B9%E9%85%8D%E6%89%A9%E5%B1%95-iprange-string-time.html#iprange-扩展" class="sidebar-link">iprange 扩展</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/work/iptables-5-%E5%AE%9E%E7%94%A8%E5%8C%B9%E9%85%8D%E6%89%A9%E5%B1%95-iprange-string-time.html#string-扩展" class="sidebar-link">string 扩展</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/work/iptables-5-%E5%AE%9E%E7%94%A8%E5%8C%B9%E9%85%8D%E6%89%A9%E5%B1%95-iprange-string-time.html#time扩展" class="sidebar-link">time扩展</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content -mt-32"><p>本章介绍三个实用的规则匹配扩展模块<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>：<code>iprange</code> 、<code>string</code> 和 <code>time</code>。</p> <div class="warning custom-block"><p class="custom-block-title">注意</p> <p>本系列文章测试环境为 <code>centos 7</code>，<code>iptables</code> 版本 <code>1.4.21</code>。</p></div> <h2 id="iprange-扩展"><a href="#iprange-扩展" aria-hidden="true" class="header-anchor">#</a> iprange 扩展</h2> <p><code>iptables</code> 匹配IP地址时，<code>-s</code> 和 <code>-d</code> 选项只能指定离散的IP地址，不能指定连续的IP地址，这时候就需要 <code>iprange</code> 扩展模块。该模块包含了两个选项：</p> <ul><li>[!] --src-range from[-to]</li> <li>[!] --dst-range from[-to]</li></ul> <blockquote><p>拒绝来自 <code>10.211.54.111</code> 到 <code>10.211.55.11</code> 范围的IP地址报文</p></blockquote> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br></div><pre class="language-bash"><code>iptables -I INPUT -m iprange --src-range 10.211.55.3-10.211.55.11 -j DROP
iptables -nvL INPUT
Chain INPUT <span class="token punctuation">(</span>policy ACCEPT 34 packets, 2308 bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token function">source</span>               destination
    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            <span class="token function">source</span> IP range 10.211.55.3-10.211.55.11
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="string-扩展"><a href="#string-扩展" aria-hidden="true" class="header-anchor">#</a> string 扩展</h2> <p><code>string</code> 扩展可以匹配报文中的字符串或者字节流，是一个比较实用的扩展。该扩展的选项如下：</p> <ul><li><code>--algo {bm|kmp}</code> 指定字符串匹配算法，必填选项(算法介绍可以参考这两篇文章<a href="http://www.ruanyifeng.com/blog/2013/05/boyer-moore_string_search_algorithm.html" target="_blank" rel="noopener noreferrer">bm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<a href="http://www.ruanyifeng.com/blog/2013/05/Knuth%E2%80%93Morris%E2%80%93Pratt_algorithm.html" target="_blank" rel="noopener noreferrer">kmp<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</li> <li><code>--from offset</code> 指定在报文中的起始偏移量，默认为0，可选项</li> <li><code>--to offset</code> 指定在报文中的结束偏移量，默认是报文大小，可选项</li> <li><code>[!] --string pattern</code> 匹配字符串</li> <li><code>[!] --hex-string pattern</code> 匹配十六进制字节流</li></ul> <p>下面让我们实际应用一下该扩展。这里我们在 <code>10.211.55.19</code> 搭建了一个 <code>http</code> 服务，包含两个页面：</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-bash"><code><span class="token function">curl</span> 10.211.55.19/drop.html -v                      
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to 10.211.55.19 port 80 <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying 10.211.55.19<span class="token punctuation">..</span>.
* Connected to 10.211.55.19 <span class="token punctuation">(</span>10.211.55.19<span class="token punctuation">)</span> port 80 <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET /drop.html HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Host: 10.211.55.19
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 200 OK
<span class="token operator">&lt;</span> Server: openresty/1.13.6.1
<span class="token operator">&lt;</span> Date: Thu, 23 Aug 2018 00:59:18 GMT
<span class="token operator">&lt;</span> Content-Type: text/html
<span class="token operator">&lt;</span> Content-Length: 8
<span class="token operator">&lt;</span> Last-Modified: Wed, 22 Aug 2018 09:11:45 GMT
<span class="token operator">&lt;</span> Connection: keep-alive
<span class="token operator">&lt;</span> ETag: <span class="token string">&quot;5b7d28d1-8&quot;</span>
<span class="token operator">&lt;</span> Accept-Ranges: bytes
<span class="token operator">&lt;</span>
drop
me
* Connection <span class="token comment">#0 to host 10.211.55.19 left intact</span>
<span class="token comment">#####################################################</span>
<span class="token function">curl</span> 10.211.55.19/hello.html -v                     
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to 10.211.55.19 port 80 <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying 10.211.55.19<span class="token punctuation">..</span>.
* Connected to 10.211.55.19 <span class="token punctuation">(</span>10.211.55.19<span class="token punctuation">)</span> port 80 <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET /hello.html HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Host: 10.211.55.19
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 200 OK
<span class="token operator">&lt;</span> Server: openresty/1.13.6.1
<span class="token operator">&lt;</span> Date: Thu, 23 Aug 2018 00:59:52 GMT
<span class="token operator">&lt;</span> Content-Type: text/html
<span class="token operator">&lt;</span> Content-Length: 12
<span class="token operator">&lt;</span> Last-Modified: Wed, 22 Aug 2018 09:11:59 GMT
<span class="token operator">&lt;</span> Connection: keep-alive
<span class="token operator">&lt;</span> ETag: <span class="token string">&quot;5b7d28df-c&quot;</span>
<span class="token operator">&lt;</span> Accept-Ranges: bytes
<span class="token operator">&lt;</span>
hello world
* Connection <span class="token comment">#0 to host 10.211.55.19 left intact</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><blockquote><p>拒绝包含 <code>world</code> 字符串的报文</p></blockquote> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br></div><pre class="language-bash"><code>iptables -F OUTPUT
iptables -I OUTPUT -m string --algo kmp --string <span class="token string">&quot;world&quot;</span> -j REJECT
iptables -nvL OUTPUT
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT 15 packets, 2432 bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token function">source</span>               destination
    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  <span class="token string">&quot;world&quot;</span> ALGO name kmp TO 65535 reject-with icmp-port-unreachable
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>因为我们要用测试机获取 <code>10.211.55.19</code> 上的页面，所以 <code>iptables</code> 规则要写在 <code>OUTPUT</code> 链上。
再使用测试机 <code>curl</code> 一下 <code>hello.html</code> 页面，发现无法获取页面内容：</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-bash"><code><span class="token function">curl</span> 10.211.55.19/hello.html -v                     
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to 10.211.55.19 port 80 <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying 10.211.55.19<span class="token punctuation">..</span>.
* Connected to 10.211.55.19 <span class="token punctuation">(</span>10.211.55.19<span class="token punctuation">)</span> port 80 <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET /hello.html HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Host: 10.211.55.19
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 200 OK
<span class="token operator">&lt;</span> Server: openresty/1.13.6.1
<span class="token operator">&lt;</span> Date: Thu, 23 Aug 2018 01:00:03 GMT
<span class="token operator">&lt;</span> Content-Type: text/html
<span class="token operator">&lt;</span> Content-Length: 12
<span class="token operator">&lt;</span> Last-Modified: Wed, 22 Aug 2018 09:11:59 GMT
<span class="token operator">&lt;</span> Connection: keep-alive
<span class="token operator">&lt;</span> ETag: <span class="token string">&quot;5b7d28df-c&quot;</span>
<span class="token operator">&lt;</span> Accept-Ranges: bytes
<span class="token operator">&lt;</span>                       
^C
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>查看 <code>OUTPUT</code> 链，拦截了96个报文：</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br></div><pre class="language-bash"><code>iptables -nvL OUTPUT
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT 220 packets, 15689 bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token function">source</span>               destination
   96  7704 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  <span class="token string">&quot;world&quot;</span> ALGO name kmp TO 65535 reject-with icmp-port-unreachable
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p>拒绝包含 <code>drop\nme</code> 字节流的报文
查看 <code>ascii</code> 表，可以知道 <code>\n</code> 的十六进制值为 <code>0A</code>。</p></blockquote> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br></div><pre class="language-bash"><code>iptables -I OUTPUT -m string --algo kmp --hex-string <span class="token string">&quot;drop|0A|me&quot;</span> -j REJECT
iptables -nvL OUTPUT
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT 31 packets, 4008 bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token function">source</span>               destination
    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  <span class="token string">&quot;|64726f700a6d65|&quot;</span> ALGO name kmp TO 65535 reject-with icmp-port-unreachable
  108  8640 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  <span class="token string">&quot;world&quot;</span> ALGO name kmp TO 65535 reject-with icmp-port-unreachable
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>&quot;drop|0A|me&quot;</code> 被转化成了纯字节流字符串 <code>&quot;|64726f700a6d65|&quot;</code>。
再使用测试机 <code>curl</code> 一下 <code>drop.html</code> 页面，发现无法获取页面内容：</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-bash"><code><span class="token function">curl</span> 10.211.55.19/drop.html -v                      
* About to connect<span class="token punctuation">(</span><span class="token punctuation">)</span> to 10.211.55.19 port 80 <span class="token punctuation">(</span><span class="token comment">#0)</span>
*   Trying 10.211.55.19<span class="token punctuation">..</span>.
* Connected to 10.211.55.19 <span class="token punctuation">(</span>10.211.55.19<span class="token punctuation">)</span> port 80 <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET /drop.html HTTP/1.1
<span class="token operator">&gt;</span> User-Agent: curl/7.29.0
<span class="token operator">&gt;</span> Host: 10.211.55.19
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span> HTTP/1.1 200 OK
<span class="token operator">&lt;</span> Server: openresty/1.13.6.1
<span class="token operator">&lt;</span> Date: Thu, 23 Aug 2018 01:01:43 GMT
<span class="token operator">&lt;</span> Content-Type: text/html
<span class="token operator">&lt;</span> Content-Length: 8
<span class="token operator">&lt;</span> Last-Modified: Wed, 22 Aug 2018 09:11:45 GMT
<span class="token operator">&lt;</span> Connection: keep-alive
<span class="token operator">&lt;</span> ETag: <span class="token string">&quot;5b7d28d1-8&quot;</span>
<span class="token operator">&lt;</span> Accept-Ranges: bytes
<span class="token operator">&lt;</span>                      
^C
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>查看 <code>OUTPUT</code> 链，拦截了54个报文：</p> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br></div><pre class="language-bash"><code>iptables -nvL OUTPUT
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT 490 packets, 34180 bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token function">source</span>               destination
   54  4140 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  <span class="token string">&quot;|64726f700a6d65|&quot;</span> ALGO name kmp TO 65535 reject-with icmp-port-unreachable
  108  8640 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  <span class="token string">&quot;world&quot;</span> ALGO name kmp TO 65535 reject-with icmp-port-unreachable
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">注意</p> <p><code>http</code> 协议是基于 <code>tcp</code> 协议的可靠连接，当客户端未得到响应时，会尝试重传，尝试一定次数后才确认请求失败。所以上述两条规则匹配到的报文数最后都会达到108。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>iptables -nvL OUTPUT
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT 2202 packets, 279K bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token function">source</span>               destination
  108  8208 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  <span class="token string">&quot;|64726f700a6d65|&quot;</span> ALGO name kmp TO 65535 reject-with icmp-port-unreachable
  108  8640 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            STRING match  <span class="token string">&quot;world&quot;</span> ALGO name kmp TO 65535 reject-with icmp-port-unreachable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div> <div class="warning custom-block"><p class="custom-block-title">注意</p> <p>实验过程中，发现使用 <code>bm</code> 算法时，无法匹配目标字符串。</p></div> <h2 id="time扩展"><a href="#time扩展" aria-hidden="true" class="header-anchor">#</a> time扩展</h2> <p><code>time</code> 扩展可以匹配报文到达时间。该扩展的常用选项有：</p> <ul><li><code>--datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</code></li> <li><code>--datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</code></li> <li><code>--timestart hh:mm[:ss]</code></li> <li><code>--timestop hh:mm[:ss]</code></li> <li><code>[!] --monthdays day[,day...]</code> 没有31的月份会忽略31，二月份还会忽略29，30</li> <li><code>[!] --weekdays day[,day...]</code> 星期选项可以是 <code>1-7</code> 的数字，或者英文缩写 <code>Mon</code>, <code>Tue</code>, <code>Wed</code>, <code>Thu</code>, <code>Fri</code>, <code>Sat</code>, <code>Sun</code>。只使用两个字母也是允许的：<code>Mo</code>, <code>Tu</code>, <code>We</code>, <code>Th</code>, <code>Fr</code>, <code>Sa</code>, <code>Su</code></li></ul> <blockquote><p>周六周日 00:00-00:06, 21:00-23:59 不提供网页服务</p></blockquote> <div class="language-bash line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br></div><pre class="language-bash"><code>iptables -F OUTPUT
iptables -I OUTPUT -p tcp -m multiport --dports 80,443 -m <span class="token function">time</span> --weekdays Sa,Su --timestart 21:00  --timestop 06:00 -j REJECT
iptables -nvL OUTPUT
Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT 7 packets, 1272 bytes<span class="token punctuation">)</span>
 pkts bytes target     prot opt <span class="token keyword">in</span>     out     <span class="token function">source</span>               destination
    0     0 REJECT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            multiport dports 80,443 TIME from 21:00:00 to 06:00:00 on Sat,Sun UTC reject-with icmp-port-unreachable
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><hr class="footnotes-sep"> <section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>man iptables-extensions 8 <a href="#fnref1" class="footnote-backref">↩︎</a></p></li></ol></section></div> <p class="page-edit">（完）</p> <p class="text-center">欢迎转载分享本文，原创文章请注明出处，谢谢配合!</p> <p class="page-edit"><div class="m-3 ant-tag ant-tag-blue" style="background-color:null;"><a href="/tags/iptables">iptables</a></div><div class="m-3 ant-tag ant-tag-blue" style="background-color:null;"><a href="/tags/iptables扩展">iptables扩展</a></div></p> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新: </span> <span class="time">10/13/2018, 10:17:06 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
            ←
            <a href="/work/译)Angular NgRx Entity完全实用指南.html" class="prev">
              (译)Angular NgRx Entity完全实用指南
            </a></span> <span class="next"><a href="/work/iptables-4-规则匹配.html">
            iptables详解-4-规则匹配
          </a>
          →
        </span></p></div> <div id="comments"></div> </div> <!----> <!----></div></div></div>
    <script src="/assets/js/34.d0b5b557.js" defer></script><script src="/assets/js/app.2d955dbb.js" defer></script>
  </body>
</html>
