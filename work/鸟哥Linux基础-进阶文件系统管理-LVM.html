<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>鸟哥Linux基础-进阶文件系统管理-LVM | 清峰</title>
    <meta name="description" content="瞎逼逼乐呵呵">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0d62e7eb.css" as="style"><link rel="preload" href="/assets/js/app.2d955dbb.js" as="script"><link rel="preload" href="/assets/js/62.b788d9b9.js" as="script"><link rel="prefetch" href="/assets/js/30.345400e7.js"><link rel="prefetch" href="/assets/js/2.f5f0c793.js"><link rel="prefetch" href="/assets/js/3.0c53a62e.js"><link rel="prefetch" href="/assets/js/4.6dc6e921.js"><link rel="prefetch" href="/assets/js/5.f0d8b77a.js"><link rel="prefetch" href="/assets/js/6.7a9758ae.js"><link rel="prefetch" href="/assets/js/7.b51204e9.js"><link rel="prefetch" href="/assets/js/8.c6e4b2c3.js"><link rel="prefetch" href="/assets/js/9.b42a1ed6.js"><link rel="prefetch" href="/assets/js/10.cd90217d.js"><link rel="prefetch" href="/assets/js/11.b90dd23f.js"><link rel="prefetch" href="/assets/js/12.7fd7f019.js"><link rel="prefetch" href="/assets/js/13.5dd26e27.js"><link rel="prefetch" href="/assets/js/14.edbc82f6.js"><link rel="prefetch" href="/assets/js/15.57d836d3.js"><link rel="prefetch" href="/assets/js/16.a6c01c03.js"><link rel="prefetch" href="/assets/js/17.8b192702.js"><link rel="prefetch" href="/assets/js/18.881fd6a9.js"><link rel="prefetch" href="/assets/js/19.2a77eb47.js"><link rel="prefetch" href="/assets/js/20.3125fd14.js"><link rel="prefetch" href="/assets/js/21.65d186d5.js"><link rel="prefetch" href="/assets/js/22.b212c0f6.js"><link rel="prefetch" href="/assets/js/23.f8565e0f.js"><link rel="prefetch" href="/assets/js/24.a5d020f5.js"><link rel="prefetch" href="/assets/js/25.8d212baf.js"><link rel="prefetch" href="/assets/js/26.e32b59c8.js"><link rel="prefetch" href="/assets/js/27.8fee8fa6.js"><link rel="prefetch" href="/assets/js/28.10d662c5.js"><link rel="prefetch" href="/assets/js/29.fc2b7d6f.js"><link rel="prefetch" href="/assets/js/31.0021887b.js"><link rel="prefetch" href="/assets/js/32.6d8cc34a.js"><link rel="prefetch" href="/assets/js/33.400472c3.js"><link rel="prefetch" href="/assets/js/34.d0b5b557.js"><link rel="prefetch" href="/assets/js/35.dab3d66c.js"><link rel="prefetch" href="/assets/js/36.4204741a.js"><link rel="prefetch" href="/assets/js/37.185d1621.js"><link rel="prefetch" href="/assets/js/38.550aada5.js"><link rel="prefetch" href="/assets/js/39.9e92ee1e.js"><link rel="prefetch" href="/assets/js/40.03a52358.js"><link rel="prefetch" href="/assets/js/41.ef831165.js"><link rel="prefetch" href="/assets/js/42.e0c38418.js"><link rel="prefetch" href="/assets/js/43.da8459a5.js"><link rel="prefetch" href="/assets/js/44.4f569cce.js"><link rel="prefetch" href="/assets/js/45.38642093.js"><link rel="prefetch" href="/assets/js/46.7b97ef73.js"><link rel="prefetch" href="/assets/js/47.f8d75afb.js"><link rel="prefetch" href="/assets/js/48.2e2cb42a.js"><link rel="prefetch" href="/assets/js/49.60a17578.js"><link rel="prefetch" href="/assets/js/50.d45ed52e.js"><link rel="prefetch" href="/assets/js/51.d7919b6f.js"><link rel="prefetch" href="/assets/js/52.99ec12e9.js"><link rel="prefetch" href="/assets/js/53.493ba67b.js"><link rel="prefetch" href="/assets/js/54.5e33cfde.js"><link rel="prefetch" href="/assets/js/55.c8831137.js"><link rel="prefetch" href="/assets/js/56.297ec3bb.js"><link rel="prefetch" href="/assets/js/57.7044d604.js"><link rel="prefetch" href="/assets/js/58.244520da.js"><link rel="prefetch" href="/assets/js/59.7a54d002.js"><link rel="prefetch" href="/assets/js/60.dd3227c0.js"><link rel="prefetch" href="/assets/js/61.2489adfb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0d62e7eb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="particles"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">清峰</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页</a></div><div class="nav-item"><a href="/life/" class="nav-link">
  认真生活</a></div><div class="nav-item"><a href="/work/" class="nav-link router-link-active">
  开心工作</a></div><div class="nav-item"><a href="/relax/" class="nav-link">
  劳逸结合</a></div> <a href="https://github.com/kiyonlin" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页</a></div><div class="nav-item"><a href="/life/" class="nav-link">
  认真生活</a></div><div class="nav-item"><a href="/work/" class="nav-link router-link-active">
  开心工作</a></div><div class="nav-item"><a href="/relax/" class="nav-link">
  劳逸结合</a></div> <a href="https://github.com/kiyonlin" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>鸟哥Linux基础-进阶文件系统管理-LVM</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#什么是lvm" class="sidebar-link">什么是LVM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#physical-volume-pv-物理卷轴" class="sidebar-link">Physical Volume, PV, 物理卷轴</a></li><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#volume-group-vg-卷轴群组" class="sidebar-link">Volume Group, VG, 卷轴群组</a></li><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#physical-extent-pe-物理范围区块" class="sidebar-link">Physical Extent, PE, 物理范围区块</a></li><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#logical-volume-lv-逻辑卷轴" class="sidebar-link">Logical Volume, LV, 逻辑卷轴</a></li></ul></li><li><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#lvm-操作流程" class="sidebar-link">LVM 操作流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#_0-disk-阶段-实际的磁盘" class="sidebar-link">0. Disk 阶段(实际的磁盘)</a></li><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#_1-pv-阶段" class="sidebar-link">1. PV 阶段</a></li><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#_2-vg-阶段" class="sidebar-link">2. VG 阶段</a></li><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#_3-lv-阶段" class="sidebar-link">3. LV 阶段</a></li><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#文件系统阶段" class="sidebar-link">文件系统阶段</a></li><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#放大lv-容量" class="sidebar-link">放大LV 容量</a></li></ul></li><li><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#使用lvm-thin-volume-让lvm-动态自动调整磁盘使用率" class="sidebar-link">使用LVM thin Volume 让LVM 动态自动调整磁盘使用率</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#lvm-的lv-磁盘快照" class="sidebar-link">LVM 的LV 磁盘快照</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#传统快照区的建立" class="sidebar-link">传统快照区的建立</a></li><li class="sidebar-sub-header"><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#利用快照区复原系统" class="sidebar-link">利用快照区复原系统</a></li></ul></li><li><a href="/work/%E9%B8%9F%E5%93%A5Linux%E5%9F%BA%E7%A1%80-%E8%BF%9B%E9%98%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86-LVM.html#lvm-的关闭" class="sidebar-link">LVM 的关闭</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content -mt-32"><p>原文<a href="http://linux.kiyon.org/" target="_blank" rel="noopener noreferrer">鸟哥的 Linux私房菜<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="什么是lvm"><a href="#什么是lvm" aria-hidden="true" class="header-anchor">#</a> 什么是LVM</h2> <p>LVM 的全名是Logical Volume Manager，逻辑卷轴管理员。LVM 的作法是将几个物理的partitions (或disk) 通过软件组合成为一块看起来是独立的大磁盘(VG) ，然后将这块大磁盘再经过分割成为可使用分区(LV)，最终就能够挂载使用了。但是为什么这样的系统可以进行filesystem 的扩充或缩小呢？其实与一个称为PE 的项目有关。</p> <h3 id="physical-volume-pv-物理卷轴"><a href="#physical-volume-pv-物理卷轴" aria-hidden="true" class="header-anchor">#</a> Physical Volume, PV, 物理卷轴</h3> <p>我们实际的partition (或Disk)需要调整系统识别码(system ID)成为8e (LVM的识别码)，然后再经过pvcreate的指令将它转成LVM最底层的物理卷轴(PV) ，之后才能够将这些PV加以利用！调整system ID的方是就是通过gdisk进行！</p> <h3 id="volume-group-vg-卷轴群组"><a href="#volume-group-vg-卷轴群组" aria-hidden="true" class="header-anchor">#</a> Volume Group, VG, 卷轴群组</h3> <p>所谓的LVM 大磁盘就是将许多PV 整合成这个VG ！所以VG 就是LVM 组合起来的大磁盘！那么这个大磁盘最大可以到多少容量呢？这与底下要说明的PE 以及LVM 的格式版本有关。在预设的情况下， 使用32位的Linux 系统时，基本上LV 最大仅能支持到65534 个PE 而已，若使用预设的PE为4MB 的情况下， 最大容量则仅能达到约256GB 而已。不过，这个问题在64位的Linux 系统上面已经不存在了！LV 几乎没有啥容量限制！</p> <h3 id="physical-extent-pe-物理范围区块"><a href="#physical-extent-pe-物理范围区块" aria-hidden="true" class="header-anchor">#</a> Physical Extent, PE, 物理范围区块</h3> <p>LVM预设使用4MB的PE区块，而LVM的LV在32位系统上最多仅能含有65534个PE (lvm1的格式)，因此预设的LVM的LV会有4M*65534/(1024M/G )=256G。PE是整个LVM最小的储存区块，也就是说，其实我们的文件资料都是藉由写入PE来处理的。简单的说，这个PE就有点像文件系统里面的block大小。所以调整PE会影响到LVM的最大容量！不过，在CentOS 6.x以后，由于直接使用lvm2的各项格式功能，以及系统转为64位，因此这个限制已经不存在了。</p> <h3 id="logical-volume-lv-逻辑卷轴"><a href="#logical-volume-lv-逻辑卷轴" aria-hidden="true" class="header-anchor">#</a> Logical Volume, LV, 逻辑卷轴</h3> <p>最终的VG还会被切成LV，这个LV就是最后可以被格式化使用的类似分区的东西！那么LV是否可以随意指定大小呢？当然不可以！既然PE是整个LVM的最小储存单位，那么LV的大小就与在此LV内的PE总数有关。为了方便使用者利用LVM来管理其系统，因此LV的设备档名通常指定为『 /dev/vgname/lvname』的样式！</p> <p>此外，我们刚刚有谈到LVM 可弹性的变更filesystem 的容量，那是如何办到的？其实就是通过『交换PE 』来进行资料转换， 将原本LV 内的PE 移转到其他设备中以降低LV 容量，或将其他设备的PE 加到此LV 中以加大容量！</p> <h2 id="lvm-操作流程"><a href="#lvm-操作流程" aria-hidden="true" class="header-anchor">#</a> LVM 操作流程</h2> <h3 id="_0-disk-阶段-实际的磁盘"><a href="#_0-disk-阶段-实际的磁盘" aria-hidden="true" class="header-anchor">#</a> 0. Disk 阶段(实际的磁盘)</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># gdisk -l /dev/vda</span>
Number  Start <span class="token punctuation">(</span>sector<span class="token punctuation">)</span>    End <span class="token punctuation">(</span>sector<span class="token punctuation">)</span>  Size       Code  Name
   1            2048            6143   2.0 MiB     EF02
   2            6144         2103295   1024.0 MiB  0700
   3         2103296        65026047   30.0 GiB    8E00
   4        65026048        67123199   1024.0 MiB  8300  Linux filesystem
   5        75511808        77608959   1024.0 MiB  8E00  Linux LVM
   6        69220352        71317503   1024.0 MiB  8E00  Linux LVM
   7        71317504        73414655   1024.0 MiB  8E00  Linux LVM
   8        73414656        75511807   1024.0 MiB  8E00  Linux LVM
   9        77608960        79706111   1024.0 MiB  8E00  Linux LVM
<span class="token comment">## 其实system ID不改变也没关系！只是为了让我们管理员清楚知道该partition的内容，</span>
<span class="token comment">## 所以这里建议还是修改成正确的磁盘内容较好！</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>上面的/dev/sda{5,6,7,8} 这4 个分区就是我们的物理分区！也就是底下会实际用到的信息！至于/dev/sda9 则先保留下来不使用。注意看，那个8e 的出现会导致system 变成『 Linux LVM 』！其实没有设定成为8e 也没关系， 不过某些LVM 的侦测指令可能会侦测不到该partition。</p> <h3 id="_1-pv-阶段"><a href="#_1-pv-阶段" aria-hidden="true" class="header-anchor">#</a> 1. PV 阶段</h3> <p>要建立PV 其实很简单，只要直接使用pvcreate 即可！</p> <ul><li>pvcreate ：将物理partition 建立成为PV ；</li> <li>pvscan ：搜寻目前系统里面任何具有PV 的磁盘；</li> <li>pvdisplay ：显示出目前系统上面的PV 状态；</li> <li>pvremove ：将PV 属性移除，让该partition 不具有PV 属性。</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>
<span class="token comment">## 1.检查有无PV在系统上，然后将/dev/sda{5-8}建立成为PV格式 </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># pvscan</span>
  PV /dev/sda3   VG centos          lvm2 <span class="token punctuation">[</span>30.00 GiB / 14.00 GiB free<span class="token punctuation">]</span>
    Total: 1 <span class="token punctuation">[</span>30.00 GiB<span class="token punctuation">]</span> / <span class="token keyword">in</span> use: 1 <span class="token punctuation">[</span>30.00 GiB<span class="token punctuation">]</span> / <span class="token keyword">in</span> no VG: 0 <span class="token punctuation">[</span>0   <span class="token punctuation">]</span>
<span class="token comment">## 其实安装的时候，我们就有使用LVM 了喔！所以会有/dev/vda3 存在的！</span>

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># pvcreate /dev/sda{5,6,7,8}</span>
  Physical volume <span class="token string">&quot;/dev/sda5&quot;</span> successfully created.
  Physical volume <span class="token string">&quot;/dev/sda6&quot;</span> successfully created.
  Physical volume <span class="token string">&quot;/dev/sda7&quot;</span> successfully created.
  Physical volume <span class="token string">&quot;/dev/sda8&quot;</span> successfully created.
<span class="token comment">## 这个指令可以一口气建立这四个partition 成为PV ！注意大括号的用途</span>

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># pvscan</span>
  PV /dev/sda3   VG centos          lvm2 <span class="token punctuation">[</span>30.00 GiB / 14.00 GiB free<span class="token punctuation">]</span>
  PV /dev/sda7                      lvm2 <span class="token punctuation">[</span>1.00 GiB<span class="token punctuation">]</span>
  PV /dev/sda8                      lvm2 <span class="token punctuation">[</span>1.00 GiB<span class="token punctuation">]</span>
  PV /dev/sda6                      lvm2 <span class="token punctuation">[</span>1.00 GiB<span class="token punctuation">]</span>
  PV /dev/sda5                      lvm2 <span class="token punctuation">[</span>1.00 GiB<span class="token punctuation">]</span>
  Total: 5 <span class="token punctuation">[</span>34.00 GiB<span class="token punctuation">]</span> / <span class="token keyword">in</span> use: 1 <span class="token punctuation">[</span>30.00 GiB<span class="token punctuation">]</span> / <span class="token keyword">in</span> no VG: 4 <span class="token punctuation">[</span>4.00 GiB<span class="token punctuation">]</span>
<span class="token comment">## 这就分别显示每个PV 的信息与系统所有PV 的信息。尤其最后一行，显示的是：</span>
<span class="token comment">## 整体PV 的量 / 已经被使用到VG 的PV 量 / 剩余的PV 量</span>

<span class="token comment">## 2.更详细的列示出系统上面每个PV的个别信息： </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># pvdisplay /dev/sda5</span>
  <span class="token string">&quot;/dev/sda5&quot;</span> is a new physical volume of <span class="token string">&quot;1.00 GiB&quot;</span>
  --- NEW Physical volume ---
  PV Name               /dev/sda5
  VG Name
  PV Size               1.00 GiB
  Allocatable           NO
  PE Size               0
  Total PE              0
  Free PE               0
  Allocated PE          0
  PV UUID               hiIqyY-CcAj-qImn-6MWn-07Ed-XJgf-3wzMul
<span class="token comment">## 由于PE 是在建立VG 时才给予的参数，因此在这里看到的PV 里头的PE 都会是 0</span>
<span class="token comment">## 而且也没有多余的PE 可供分配(allocatable)。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="_2-vg-阶段"><a href="#_2-vg-阶段" aria-hidden="true" class="header-anchor">#</a> 2. VG 阶段</h3> <ul><li>vgcreate ：建立VG 的指令。</li> <li>vgscan ：搜寻系统上面是否有VG 存在；</li> <li>vgdisplay ：显示目前系统上面的VG 状态；</li> <li>vgextend ：在VG 内增加额外的PV ；</li> <li>vgreduce ：在VG 内移除PV；</li> <li>vgchange ：设定VG 是否启动(active)；</li> <li>vgremove ：删除一个VG。</li></ul> <p>与PV 不同的是， VG 的名称是自定义的！我们知道PV 的名称其实就是partition 的设备文件名， 但是这个VG 名称则可以随便自己取。建立这个 VG 的流程是这样的：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## vgcreate [-s N[mgt]] VG名称PV名称</span>
<span class="token comment">## 选项与参数：</span>
<span class="token comment">## -s ：后面接PE 的大小(size) ，单位可以是m, g, t (大小写均可)</span>

<span class="token comment">## 1.将/dev/sda5-7建立成为一个VG，且指定PE为16MB！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># vgcreate -s 16M kiyonvg /dev/sda{5,6,7}</span>
  Volume group <span class="token string">&quot;kiyonvg&quot;</span> successfully created

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># vgscan</span>
  Reading volume <span class="token function">groups</span> from cache.
  Found volume group <span class="token string">&quot;kiyonvg&quot;</span> using metadata <span class="token function">type</span> lvm2
  Found volume group <span class="token string">&quot;centos&quot;</span> using metadata <span class="token function">type</span> lvm2

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># pvscan </span>
  PV /dev/sda5   VG kiyonvg         lvm2 <span class="token punctuation">[</span>1008.00 MiB / 1008.00 MiB free<span class="token punctuation">]</span>
  PV /dev/sda6   VG kiyonvg         lvm2 <span class="token punctuation">[</span>1008.00 MiB / 1008.00 MiB free<span class="token punctuation">]</span>
  PV /dev/sda7   VG kiyonvg         lvm2 <span class="token punctuation">[</span>1008.00 MiB / 1008.00 MiB free<span class="token punctuation">]</span>
  PV /dev/sda3   VG centos          lvm2 <span class="token punctuation">[</span>30.00 GiB / 14.00 GiB free<span class="token punctuation">]</span>
  PV /dev/sda8                      lvm2 <span class="token punctuation">[</span>1.00 GiB<span class="token punctuation">]</span>
  Total: 5 <span class="token punctuation">[</span>33.95 GiB<span class="token punctuation">]</span> / <span class="token keyword">in</span> use: 4 <span class="token punctuation">[</span>32.95 GiB<span class="token punctuation">]</span> / <span class="token keyword">in</span> no VG: 1 <span class="token punctuation">[</span>1.00 GiB<span class="token punctuation">]</span>
<span class="token comment">## 有三个PV 被用去，剩下1 个/dev/sda8 的PV 没被用掉！</span>

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># vgdisplay kiyonvg</span>
  --- Volume group ---
  VG Name               kiyonvg
  System ID
  Format                lvm2
  Metadata Areas        3
  Metadata Sequence No  1
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                0
  Open LV               0
  Max PV                0
  Cur PV                3
  Act PV                3
  VG Size               2.95 GiB
  PE Size               16.00 MiB
  Total PE              189
  Alloc PE / Size       0 / 0
  Free  PE / Size       189 / 2.95 GiB
  VG UUID               cBoibr-y9mY-90Cl-SRSr-1DAY-lLAZ-Ecbl4u
<span class="token comment">## 最后那三行指的就是PE 能够使用的情况！由于尚未切出LV，因此所有的PE 均可自由使用。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>这样就建立一个VG 了！假设我们要增加这个VG 的容量，因为我们还有/dev/sda8 ！此时可以这样做：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 2.将剩余的PV (/dev/sda8)丢给kiyonvg</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># vgextend kiyonvg /dev/sda8</span>
  Volume group <span class="token string">&quot;kiyonvg&quot;</span> successfully extended

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># vgdisplay kiyonvg </span>
<span class="token comment">## ....(前面省略)....</span>
  VG Size               3.94 GiB
  PE Size               16.00 MiB
  Total PE              252
  Alloc PE / Size       0 / 0
  Free  PE / Size       252 / 3.94 GiB
  VG UUID               cBoibr-y9mY-90Cl-SRSr-1DAY-lLAZ-Ecbl4u
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_3-lv-阶段"><a href="#_3-lv-阶段" aria-hidden="true" class="header-anchor">#</a> 3. LV 阶段</h3> <p>创造出VG 这个大磁盘之后，再来就是要建立分割区啦！这个分割区就是所谓的LV ！假设我要将刚刚那个 kiyonvg 磁盘，分割成为kiyonlv ，整个VG 的容量都被分配到kiyonlv 里面去。</p> <ul><li>lvcreate ：建立LV！</li> <li>lvscan ：查询系统上面的LV ；</li> <li>lvdisplay ：显示系统上面的LV 状态！</li> <li>lvextend ：在LV 里面增加容量！</li> <li>lvreduce ：在LV 里面减少容量；</li> <li>lvremove ：删除一个LV ！</li> <li>lvresize ：对LV 进行容量大小的调整！</li></ul> <p>命令详解：
<code>lvcreate [-LN[mgt]] [-n LV名称] VG名称</code> <code>lvcreate [-l N] [-n LV名称] VG名称</code>
选项与参数：</p> <ul><li>-L ：后面接容量，容量的单位可以是M,G,T 等，要注意的是，最小单位为PE，
因此这个数量必须要是PE 的倍数，若不相符，系统会自行计算最相近的容量。</li> <li>-l ：后面可以接PE 的『个数』，而不是数量。若要这么做，得要自行计算PE 数。</li> <li>-n ：后面接的就是LV 的名称！</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 1.将kiyonvg分2GB给kiyonlv！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvcreate -L 2G -n kiyonlv kiyonvg</span>
  Logical volume <span class="token string">&quot;kiyonlv&quot;</span> created
<span class="token comment">## 由于本案例中每个PE 为16M ，如果要用PE 的数量来处理的话，那使用下面的指令也OK！</span>
<span class="token comment">## lvcreate -l 128 -n kiyonlv kiyonvg</span>

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvscan </span>
  ACTIVE            <span class="token string">'/dev/kiyonvg/kiyonlv'</span> <span class="token punctuation">[</span>2.00 GiB<span class="token punctuation">]</span> inherit
  ACTIVE            <span class="token string">'/dev/centos/root'</span>     <span class="token punctuation">[</span>10.00 GiB<span class="token punctuation">]</span> inherit
  ACTIVE            <span class="token string">'/dev/centos/home'</span>     <span class="token punctuation">[</span>5.00 GiB<span class="token punctuation">]</span> inherit
  ACTIVE            <span class="token string">'/dev/centos/swap'</span>     <span class="token punctuation">[</span>1.00 GiB<span class="token punctuation">]</span> inherit

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvdisplay /dev/kiyonvg/kiyonlv</span>
  --- Logical volume ---
  LV Path                /dev/kiyonvg/kiyonlv
  LV Name                kiyonlv
  VG Name                kiyonvg
  LV UUID                1t1324-TfsC-bx5M-P9Ee-MeMK-Cjs3-m94yH2
  LV Write Access        read/write
  LV Creation host, <span class="token function">time</span> study.centos.kiyon, 2017-04-21 14:18:30 +0800
  LV Status              available
  <span class="token comment"># open                 0</span>
  LV Size                2.00 GiB
  Current LE             128
  Segments               3
  Allocation             inherit
  Read ahead sectors     auto
  - currently <span class="token keyword">set</span> to     8192
  Block device           253:3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>如此一来，整个LV partition也准备好了！接下来，就是针对这个LV来处理！要特别注意的是， VG的名称为kiyonvg ，但是LV的名称必须使用全名/dev/kiyonvg/kiyonlv才对！后续的处理都是这样的！</p> <h3 id="文件系统阶段"><a href="#文件系统阶段" aria-hidden="true" class="header-anchor">#</a> 文件系统阶段</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 1.格式化、挂载与观察我们的LV吧！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># mkfs.xfs /dev/kiyonvg/kiyonlv  #&lt;==注意LV全名！</span>
meta-data<span class="token operator">=</span>/dev/kiyonvg/kiyonlv   isize<span class="token operator">=</span>512    agcount<span class="token operator">=</span>4, agsize<span class="token operator">=</span>131072 blks
         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>4096  attr<span class="token operator">=</span>2, projid32bit<span class="token operator">=</span>1
         <span class="token operator">=</span>                       crc<span class="token operator">=</span>1        finobt<span class="token operator">=</span>0, sparse<span class="token operator">=</span>0
data     <span class="token operator">=</span>                       bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>524288, imaxpct<span class="token operator">=</span>25
         <span class="token operator">=</span>                       sunit<span class="token operator">=</span>0      swidth<span class="token operator">=</span>0 blks
naming   <span class="token operator">=</span>version 2              bsize<span class="token operator">=</span>4096   ascii-ci<span class="token operator">=</span>0 ftype<span class="token operator">=</span>1
log      <span class="token operator">=</span>internal log           bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2560, version<span class="token operator">=</span>2
         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>4096  sunit<span class="token operator">=</span>1 blks, lazy-count<span class="token operator">=</span>1
realtime <span class="token operator">=</span>none                   extsz<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>0, rtextents<span class="token operator">=</span>0

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># mkdir /srv/lvm </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># mount /dev/kiyonvg/kiyonlv /srv/lvm </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv xfs   2.0G   33M  2.0G   2% /srv/lvm

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># cp -a /etc /var/log /srv/lvm </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv xfs   2.0G   74M  2.0G   4% /srv/lvm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="放大lv-容量"><a href="#放大lv-容量" aria-hidden="true" class="header-anchor">#</a> 放大LV 容量</h3> <ol><li><p>VG阶段需要有剩余的容量：因为需要放大文件系统，所以需要放大LV，但是若没有多的VG容量，那么更上层的LV与文件系统就无法放大的。因此要用尽各种方法来产生多的VG容量才行。一般来说，如果VG容量不足，最简单的方法就是再加硬盘！然后将该硬盘使用上面讲过的pvcreate及vgextend增加到该VG内即可！</p></li> <li><p>LV阶段产生更多的可用容量：如果VG的剩余容量足够了，此时就可以利用lvresize这个指令来将剩余容量加入到所需要增加的LV设备内！过程相当简单！</p></li> <li><p>文件系统阶段的放大：我们的Linux实际使用的其实不是LV啊！而是LV这个设备内的文件系统！所以一切最终还是要以文件系统为依归！目前在Linux环境下，可以放大的文件系统有XFS以及EXT家族！至于缩小仅有EXT家族，目前XFS文件系统并不支持文件系统的容量缩小！要注意！要注意！XFS放大文件系统通过简单的xfs_growfs指令即可！</p></li></ol> <p>针对/srv/lvm 再增加500M 的容量</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 1.由前面的过程我们知道/srv/lvm是/dev/kiyonvg/kiyonlv这个设备，所以检查kiyonvg吧！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># vgdisplay kiyonvg</span>
  --- Volume group ---
  VG Name               kiyonvg
  System ID
  Format                lvm2
  Metadata Areas        4
  Metadata Sequence No  3
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                1
  Open LV               1
  Max PV                0
  Cur PV                4
  Act PV                4
  VG Size               3.94 GiB
  PE Size               16.00 MiB
  Total PE              252
  Alloc PE / Size       128 / 2.00 GiB
  Free  PE / Size       124 / 1.94 GiB
  VG UUID               cBoibr-y9mY-90Cl-SRSr-1DAY-lLAZ-Ecbl4u
<span class="token comment">## 既然VG 的容量够大了！所以直接来放大LV 吧！！</span>

<span class="token comment">## 2.放大LV吧！利用lvresize的功能来增加！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvresize -L +500M /dev/kiyonvg/kiyonlv</span>
  Rounding size to boundary between physical extents: 512.00 MiB.
  Size of logical volume kiyonvg/kiyonlv changed from 2.00 GiB <span class="token punctuation">(</span>128 extents<span class="token punctuation">)</span> to 2.50 GiB <span class="token punctuation">(</span>160 extents<span class="token punctuation">)</span>.
  Logical volume kiyonvg/kiyonlv successfully resized.
<span class="token comment">## 这样就增加了LV 了！lvresize 的语法很简单，基本上同样通过-l 或-L 来增加！</span>

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvscan </span>
  ACTIVE            <span class="token string">'/dev/kiyonvg/kiyonlv'</span> <span class="token punctuation">[</span>2.50 GiB<span class="token punctuation">]</span> inherit
  ACTIVE            <span class="token string">'/dev/centos/root'</span> <span class="token punctuation">[</span>10.00 GiB<span class="token punctuation">]</span> inherit
  ACTIVE            <span class="token string">'/dev/centos/home'</span> <span class="token punctuation">[</span>5.00 GiB<span class="token punctuation">]</span> inherit
  ACTIVE            <span class="token string">'/dev/centos/swap'</span> <span class="token punctuation">[</span>1.00 GiB<span class="token punctuation">]</span> inherit
<span class="token comment">## 可以发现/dev/kiyonvg/kiyonlv 容量由2G 增加到2.5G ！</span>

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv xfs   2.0G   74M  2.0G   4% /srv/lvm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>最终的结果中LV 真的有放大到2.5GB ！但是文件系统却没有相对增加！我们的LVM 可以线上直接处理，并不需要特别umount ！使用xfs_growfs 来处理一下！</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 3.1先看一下原本的文件系统内的superblock记录情况吧！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># xfs_info /srv/lvm </span>
meta-data<span class="token operator">=</span>/dev/mapper/kiyonvg-kiyonlv isize<span class="token operator">=</span>512    agcount<span class="token operator">=</span>4, agsize<span class="token operator">=</span>131072 blks
         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>4096  attr<span class="token operator">=</span>2, projid32bit<span class="token operator">=</span>1
         <span class="token operator">=</span>                       crc<span class="token operator">=</span>1        finobt<span class="token operator">=</span>0 spinodes<span class="token operator">=</span>0
data     <span class="token operator">=</span>                       bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>524288, imaxpct<span class="token operator">=</span>25
         <span class="token operator">=</span>                       sunit<span class="token operator">=</span>0      swidth<span class="token operator">=</span>0 blks
naming   <span class="token operator">=</span>version 2              bsize<span class="token operator">=</span>4096   ascii-ci<span class="token operator">=</span>0 ftype<span class="token operator">=</span>1
log      <span class="token operator">=</span>internal               bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2560, version<span class="token operator">=</span>2
         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>4096  sunit<span class="token operator">=</span>1 blks, lazy-count<span class="token operator">=</span>1
realtime <span class="token operator">=</span>none                   extsz<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>0, rtextents<span class="token operator">=</span>0

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># xfs_growfs /srv/lvm   #这一步骤才是最重要的！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># xfs_info /srv/lvm </span>
meta-data<span class="token operator">=</span>/dev/mapper/kiyonvg-kiyonlv isize<span class="token operator">=</span>512    agcount<span class="token operator">=</span>5, agsize<span class="token operator">=</span>131072 blks
         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>4096  attr<span class="token operator">=</span>2, projid32bit<span class="token operator">=</span>1
         <span class="token operator">=</span>                       crc<span class="token operator">=</span>1        finobt<span class="token operator">=</span>0 spinodes<span class="token operator">=</span>0
data     <span class="token operator">=</span>                       bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>655360, imaxpct<span class="token operator">=</span>25
         <span class="token operator">=</span>                       sunit<span class="token operator">=</span>0      swidth<span class="token operator">=</span>0 blks
naming   <span class="token operator">=</span>version 2              bsize<span class="token operator">=</span>4096   ascii-ci<span class="token operator">=</span>0 ftype<span class="token operator">=</span>1
log      <span class="token operator">=</span>internal               bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2560, version<span class="token operator">=</span>2
         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>4096  sunit<span class="token operator">=</span>1 blks, lazy-count<span class="token operator">=</span>1
realtime <span class="token operator">=</span>none                   extsz<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>0, rtextents<span class="token operator">=</span>0

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># df -Th /srv/lvm</span>
Filesystem                  Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv xfs   2.5G   74M  2.5G   3% /srv/lvm

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># ls -l /srv/lvm</span>
total 16
drwxr-xr-x. 78 root root 8192 Apr 21 11:17 etc
drwxr-xr-x.  8 root root 4096 Apr 19 14:40 log
<span class="token comment">## 刚刚复制进去的资料可还是存在的！并没有消失不见！</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>在上表中，注意看两次xfs_info 的结果，你会发现到1)整个block group (agcount) 的数量增加一个！那个block group 就是纪录新的设备容量之文件系统所在！而你也会2)发现整体的block 数量增加了！这样整个文件系统就给他放大了！同时，使用df 去查阅时，就真的看到增加的量了！文件系统的放大可以在On-line 的环境下操作。</p> <p>目前的XFS 文件系统中，并没有缩小文件系统容量的设计！也就是说，文件系统只能放大不能缩小喔！如果你想要保有放大、缩小的本事， 那还请回去使用EXT 家族最新的EXT4 文件系统啰！XFS 目前是办不到的！</p> <h2 id="使用lvm-thin-volume-让lvm-动态自动调整磁盘使用率"><a href="#使用lvm-thin-volume-让lvm-动态自动调整磁盘使用率" aria-hidden="true" class="header-anchor">#</a> 使用LVM thin Volume 让LVM 动态自动调整磁盘使用率</h2> <p>LVM thin Volume 的概念是：先建立一个可以实支实付、用多少容量才分配实际写入多少容量的磁盘容量储存池(thin pool)， 然后再由这个thin pool 去产生一个『指定要固定容量大小的LV 设备』，这个LV 就有趣了！虽然你会看到『表面上，它的容量可能有10GB ，但实际上， 该设备用到多少容量时，才会从thin pool 去实际取得所需要的容量』！可能thin pool 仅有1GB 的容量， 但是可以分配给一个10GB 的LV 设备！而该设备实际使用到500M 时，整个thin pool 才分配500M 给该LV ！当然啦！在所有由thin pool 所分配出来的LV 设备中，总实际使用量绝不能超过thin pool 的最大实际容量！如这个案例说的， thin pool 仅有1GB， 那所有的由这个thin pool 建置出来的LV 设备内的实际用量，就绝不能超过1GB ！</p> <p>实际操作：</p> <ul><li>由kiyonvg 的剩余容量取出1GB 来做出一个名为kiyontpool 的thin pool LV 设备，这就是所谓的磁盘容量储存池(thin pool)</li> <li>由kiyonvg 内的kiyontpool 产生一个名为kiyonthin 的10GB LV 设备</li> <li>将此设备实际格式化为xfs 文件系统，并且挂载于/srv/thin 目录内！</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 1.先以lvcreate来建立kiyontpool这个thin pool设备： </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvcreate -L 1G -T kiyonvg/kiyontpool   #最重要的建置指令 </span>
  Using default stripesize 64.00 KiB.
  Logical volume <span class="token string">&quot;kiyontpool&quot;</span> created.
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvdisplay /dev/kiyonvg/kiyontpool</span>
  --- Logical volume ---
  LV Name                kiyontpool
  VG Name                kiyonvg
  LV UUID                dGEm2n-ARFT-OjI4-7Q85-bIp1-unqJ-X98pRu
  LV Write Access        read/write
  LV Creation host, <span class="token function">time</span> study.centos.kiyon, 2017-04-21 15:02:50 +0800
  LV Pool metadata       kiyontpool_tmeta
  LV Pool data           kiyontpool_tdata
  LV Status              available
  <span class="token comment"># open                 0</span>
  LV Size                1.00 GiB       <span class="token comment"># 总共可分配出去的容量 </span>
  Allocated pool data    0.00%          <span class="token comment"># 已分配的容量百分比 </span>
  Allocated metadata     0.24%          <span class="token comment"># 已分配的中介资料百分比</span>
  Current LE             64
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently <span class="token keyword">set</span> to     8192
  Block device           253:6
<span class="token comment">## 非常有趣吧！竟然在LV 设备中还可以有再分配(Allocated) 的项目！果然是储存池！</span>

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvs kiyonvg   #语法为lvs VGname </span>
  LV         VG      Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  kiyonlv    kiyonvg -wi-ao---- 2.50g
  kiyontpool kiyonvg twi-a-tz-- 1.00g             0.00   0.24
<span class="token comment">#这个lvs指令的输出更加简单明了！直接看比较清晰！</span>

<span class="token comment">## 2.开始建立kiyonthin这个有10GB的设备，注意！必须使用--thin与kiyontpool连结！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvcreate -V 10G -T kiyonvg/kiyontpool -n kiyonthin</span>
  Using default stripesize 64.00 KiB.
  WARNING: Sum of all thin volume sizes <span class="token punctuation">(</span>10.00 GiB<span class="token punctuation">)</span> exceeds the size of thin pool kiyonvg/kiyontpool and the size of whole volume group <span class="token punctuation">(</span>3.94 GiB<span class="token punctuation">)</span><span class="token operator">!</span>
  For thin pool auto extension activation/thin_pool_autoextend_threshold should be below 100.
  Logical volume <span class="token string">&quot;kiyonthin&quot;</span> created.
  
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvs kiyonvg</span>
  LV         VG      Attr       LSize  Pool       Origin Data%  Meta%  Move Log Cpy%Sync Convert
  kiyonlv    kiyonvg -wi-ao----  2.50g
  kiyonthin  kiyonvg Vwi-a-tz-- 10.00g kiyontpool        0.00
  kiyontpool kiyonvg twi-aotz--  1.00g                   0.00   0.27
<span class="token comment">## 很有趣吧！明明连kiyonvg 这个VG 都没有足够大到10GB 的容量，通过thin pool</span>
<span class="token comment">## 竟然就产生了10GB 的kiyonthin 这个设备！</span>

<span class="token comment">## 3.开始建立文件系统 </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># mkfs.xfs /dev/kiyonvg/kiyonthin </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># mkdir /srv/thin </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># mount /dev/kiyonvg/kiyonthin /srv/thin </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># df -Th /srv/thin</span>
Filesystem                    Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonthin xfs    10G   33M   10G   1% /srv/thin
<span class="token comment">## 真的有10GB！！</span>

<span class="token comment">## 4.测试一下容量的使用！建立500MB的文件，但不可超过1GB的测试为宜！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># dd if=/dev/zero of=/srv/thin/test.img bs=1M count=500 </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvs kiyonvg</span>
  LV         VG      Attr       LSize  Pool       Origin Data%  Meta%  Move Log Cpy%Sync Convert
  kiyonlv    kiyonvg -wi-ao----  2.50g
  kiyonthin  kiyonvg Vwi-aotz-- 10.00g kiyontpool        4.99
  kiyontpool kiyonvg twi-aotz--  1.00g                   49.93  2.00
<span class="token comment">## 很要命！这时已经分配出49%以上的容量了！而kiyonthin却只看到用掉5%而已！</span>
<span class="token comment">## 所以鸟哥认为，这个thin pool 非常好用！但是在管理上，得要特别特别的留意！</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><p>这就是用多少算多少的thin pool 操作方式！基本上，用来骗人挺吓人的！小小的一个磁盘可以模拟出好多容量！但实际上，真的可用容量就是实际的磁盘储存池内的容量！如果突破该容量，这个thin pool 可是会爆炸而让资料损毁！要注意！要注意！</p> <h2 id="lvm-的lv-磁盘快照"><a href="#lvm-的lv-磁盘快照" aria-hidden="true" class="header-anchor">#</a> LVM 的LV 磁盘快照</h2> <p>快照就是将当时的系统信息记录下来，就好像照相记录一般！未来若有任何资料更动了，则原始资料会被搬移到快照区，没有被更动的区域则由快照区与文件系统共享。
快照区与被快照的LV必须要在同一个VG上头。</p> <h3 id="传统快照区的建立"><a href="#传统快照区的建立" aria-hidden="true" class="header-anchor">#</a> 传统快照区的建立</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 1.先观察VG还剩下多少剩余容量 </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># vgdisplay kiyonvg </span>
<span class="token comment">## ....(其他省略)....</span>
  Total PE              252
  Alloc PE / Size       226 / 3.53 GiB
  Free  PE / Size       26 / 416.00 MiB
<span class="token comment">## 就只有剩下26个PE了！全部分配给kiyonsnap1！</span>

<span class="token comment">## 2.利用lvcreate建立kiyonlv的快照区，快照被取名为kiyonsnap1，且给予26个PE </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvcreate -s -l 26 -n kiyonsnap1 /dev/kiyonvg/kiyonlv</span>
  Logical volume <span class="token string">&quot;kiyonsnap1&quot;</span> created
<span class="token comment">## 上述的指令中最重要的是那个-s 的选项！代表是snapshot 快照功能的意思！</span>
<span class="token comment">## -n 后面接快照区的设备名称， /dev/.... 则是要被快照的LV 完整档名。</span>
<span class="token comment">## -l 后面则是接使用多少个PE 来作为这个快照区使用。</span>

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvdisplay /dev/kiyonvg/kiyonsnap1</span>
  --- Logical volume ---
  LV Path                /dev/kiyonvg/kiyonspan1
  LV Name                kiyonspan1
  VG Name                kiyonvg
  LV UUID                08alSG-10xu-dRnP-CgfI-smCX-y8Xx-IPxtjw
  LV Write Access        read/write
  LV Creation host, <span class="token function">time</span> study.centos.kiyon, 2017-04-22 09:13:12 +0800
  LV snapshot status     active destination <span class="token keyword">for</span> kiyonlv
  LV Status              available
  <span class="token comment"># open                 0</span>
  LV Size                2.50 GiB
  Current LE             160
  COW-table size         416.00 MiB
  COW-table LE           26
  Allocated to snapshot  0.00%
  Snapshot chunk size    4.00 KiB
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently <span class="token keyword">set</span> to     8192
  Block device           253:11
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>/dev/kiyonvg/kiyonsnap1 快照区就被建立起来了！而且它的VG 量与原本的/dev/kiyonvg/kiyonlv 相同！也就是说，如果真的挂载这个设备时，看到的资料会跟原本的kiyonlv 相同！</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># mkdir /srv/snapshot1 </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># mount -o nouuid /dev/kiyonvg/kiyonsnap1 /srv/snapshot1 </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># df -Th /srv/lvm /srv/ snapshot1</span>
Filesystem                     Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv    xfs   2.5G   74M  2.5G   3% /srv/lvm
/dev/mapper/kiyonvg-kiyonspan1 xfs   2.5G   74M  2.5G   3% /srv/snapshot1
<span class="token comment">## /dev/kiyonvg/kiyonsnap1 会主动记录原kiyonlv 的内容！</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>因为XFS 不允许相同的UUID 文件系统的挂载，因此得要加上那个nouuid 的参数，让文件系统忽略相同的UUID 所造成的问题！</p> <h3 id="利用快照区复原系统"><a href="#利用快照区复原系统" aria-hidden="true" class="header-anchor">#</a> 利用快照区复原系统</h3> <p>要注意的是，要复原的资料量不能够高于快照区所能负载的实际容量。由于原始资料会被搬移到快照区，如果快照区不够大，若原始资料被更动的实际资料量比快照区大，那么快照区当然容纳不了，这时候快照功能会失效！</p> <p>我们的/srv/lvm 已经有/srv/lvm/etc, /srv/lvm/log 等目录了，接下来将这个文件系统的内容作个变更， 然后再以快照区资料还原看看：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 1.先将原本的/dev/kiyonvg/kiyonlv内容作些变更，增增减减一些目录吧！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># cp -a /usr/share/doc /srv/lvm </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># rm -rf /srv/lvm/log </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># rm -rf /srv/lvm /etc/sysconfig </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># df -Th /srv/lvm /srv/snapshot1</span>
Filesystem                     Type  Size  Used Avail Use% Mounted on
/dev/mapper/kiyonvg-kiyonlv    xfs   2.5G  115M  2.4G   5% /srv/lvm
/dev/mapper/kiyonvg-kiyonspan1 xfs   2.5G   74M  2.5G   3% /srv/snapshot1
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># ll /srv/lvm /srv/snapshot1</span>
/srv/lvm:
total 28K
drwxr-xr-x. 284 root root  12K Apr 19 14:26 doc
drwxr-xr-x.  77 root root 8.0K Apr 22 09:38 etc

/srv/snapshot1:
total 16K
drwxr-xr-x. 78 root root 8.0K Apr 21 11:17 etc
drwxr-xr-x.  8 root root 4.0K Apr 19 14:40 log
<span class="token comment">## 两个目录的内容看起来已经不太一样了！</span>

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvdisplay /dev/kiyonvg/kiyonsnap1</span>
  --- Logical volume ---
  LV Path /dev/kiyonvg/kiyonsnap1
<span class="token comment">## ....(中间省略).... </span>
  Allocated to snapshot  13.12%
<span class="token comment">## 列出最重要的部份: 全部的容量已经被用掉了13.12%！</span>

<span class="token comment">## 2.利用快照区将原本的filesystem备份，使用xfsdump来处理！</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># xfsdump -l 0 -L lvm1 -M lvm1 -f /home/lvm.dump /srv/snapshot1 </span>
<span class="token comment">## 此时就会有一个备份资料/home/lvm.dump了！</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>为什么要备份呢？为什么不可以直接格式化/dev/kiyonvg/kiyonlv 然后将/dev/kiyonvg/kiyonsnap1 直接复制给kiyonlv 呢？要知道kiyonsnap1 其实是kiyonlv 的快照，因此如果你格式化整个kiyonlv 时，原本的文件系统所有资料都会被搬移到kiyonsnap1。那如果kiyonsnap1 的容量不够大(通常也真的不够大)，那么部分资料将无法复制到kiyonsnap1 内，资料当然无法全部还原啊！所以才要在上面制作出一个备份文件！</p> <p>而快照还有另外一个功能，就是你可以比对/srv/lvm 与/srv/snapshot1 的内容，就能够发现到最近你到底改了啥！</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">## 3.将kiyonsnap1卸载并移除(因为里面的内容已经备份起来了) </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># umount /srv/snapshot1 </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvremove /dev/kiyonvg/kiyonsnap1 </span>
Do you really want to remove active logical volume <span class="token string">&quot;kiyonsnap1&quot;</span>? <span class="token punctuation">[</span>y/n<span class="token punctuation">]</span>: y
  Logical volume <span class="token string">&quot;kiyonsnap1&quot;</span> successfully removed

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># umount /srv/lvm </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># mkfs.xfs -f /dev/kiyonvg/kiyonlv </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># mount /dev/kiyonvg/kiyonlv /srv/lvm </span>
<span class="token punctuation">[</span>root @study ~<span class="token punctuation">]</span><span class="token comment"># xfsrestore -f /home/lvm.dump -L lvm1 /srv/lvm </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># ll /srv/lvm</span>
total 16K
drwxr-xr-x. 78 root root 8.0K Apr 21 11:17 etc
drwxr-xr-x.  8 root root 4.0K Apr 19 14:40 log
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="lvm-的关闭"><a href="#lvm-的关闭" aria-hidden="true" class="header-anchor">#</a> LVM 的关闭</h2> <p>如果没有将LVM 关闭就直接将那些partition 删除或转为其他用途的话，系统是会发生很大的问题的！所以必须要知道如何将LVM 的设备关闭并移除才行！依据以下的流程来处理即可：</p> <ul><li>先卸载系统上面的LVM 文件系统(包括快照与所有LV)；</li> <li>使用lvremove 移除LV ；</li> <li>使用vgchange -an VGname 让VGname 这个VG 不具有Active 的标志；</li> <li>使用vgremove 移除VG：</li> <li>使用pvremove 移除PV；</li> <li>最后，使用fdisk 修改ID 回来！</li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># umount /srv/lvm /srv/thin /srv/snapshot1 </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvs kiyonvg</span>
  LV         VG      Attr       LSize  Pool       Origin Data%  Meta%  Move Log Cpy%Sync Convert
  kiyonlv    kiyonvg -wi-a-----  2.50g
  kiyonthin  kiyonvg Vwi-a-tz-- 10.00g kiyontpool        4.99
  kiyontpool kiyonvg twi-aotz--  1.00g                   49.93  1.83
<span class="token comment">## 要注意！按顺序删除kiyonthin --&gt; kiyontpool --&gt; kiyonlv 比较好！</span>

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvremove /dev/kiyonvg/kiyonthin</span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># lvremove /dev/kiyonvg/kiyonlv </span>
<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># vgchange -an kiyonvg</span>
  0 logical volume<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">in</span> volume group <span class="token string">&quot;kiyonvg&quot;</span> now active

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># vgremove kiyonvg</span>
  Volume group <span class="token string">&quot;kiyonvg&quot;</span> successfully removed

<span class="token punctuation">[</span>root@study ~<span class="token punctuation">]</span><span class="token comment"># pvremove /dev/sda{5,6,7,8}</span>
  Labels on physical volume <span class="token string">&quot;/dev/sda5&quot;</span> successfully wiped.
  Labels on physical volume <span class="token string">&quot;/dev/sda6&quot;</span> successfully wiped.
  Labels on physical volume <span class="token string">&quot;/dev/sda7&quot;</span> successfully wiped.
  Labels on physical volume <span class="token string">&quot;/dev/sda8&quot;</span> successfully wiped.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></div> <p class="page-edit">（完）</p> <p class="text-center">欢迎转载分享本文，原创文章请注明出处，谢谢配合!</p> <p class="page-edit"><div class="m-3 ant-tag ant-tag-blue" style="background-color:null;"><a href="/tags/Linux">Linux</a></div><div class="m-3 ant-tag ant-tag-blue" style="background-color:null;"><a href="/tags/LVM">LVM</a></div></p> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新: </span> <span class="time">8/13/2018, 5:20:00 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
            ←
            <a href="/work/C预处理器.html" class="prev">
              C预处理器
            </a></span> <span class="next"><a href="/work/PHPUnit.html">
            PHPUnit
          </a>
          →
        </span></p></div> <div id="comments"></div> </div> <!----> <!----></div></div></div>
    <script src="/assets/js/62.b788d9b9.js" defer></script><script src="/assets/js/app.2d955dbb.js" defer></script>
  </body>
</html>
