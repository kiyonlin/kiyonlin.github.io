(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{231:function(s,t,a){"use strict";a.r(t);var n=a(2),e=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("div",{staticClass:"content"},[a("p",[s._v("本章介绍更多的规则匹配条件。")]),s._v(" "),a("div",{staticClass:"warning custom-block"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("本系列文章测试环境为 "),a("code",[s._v("centos 7")]),s._v("，"),a("code",[s._v("iptables")]),s._v(" 版本 "),a("code",[s._v("1.4.21")]),s._v("。")])]),s._v(" "),a("h2",{attrs:{id:"源ip地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#源ip地址","aria-hidden":"true"}},[s._v("#")]),s._v(" 源IP地址")]),s._v(" "),a("blockquote",[a("p",[s._v("指定多个IP地址")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -I INPUT -s 10.211.55.9,10.211.55.10 -j DROP\niptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 40 packets, 2652 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    0     0 DROP       all  --  *      *       10.211.55.10         0.0.0.0/0\n    0     0 DROP       all  --  *      *       10.211.55.9          0.0.0.0/0\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("blockquote",[a("p",[s._v("指定某个网段")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -I INPUT -s 10.211.0.0/16 -j ACCEPT\niptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 27 packets, 2293 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n   40  2772 ACCEPT     all  --  *      *       10.211.0.0/16        0.0.0.0/0\n    0     0 DROP       all  --  *      *       10.211.55.10         0.0.0.0/0\n    0     0 DROP       all  --  *      *       10.211.55.9          0.0.0.0/0\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("blockquote",[a("p",[s._v("对源IP地址取反")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -F INPUT\niptables -A INPUT "),a("span",{attrs:{class:"token operator"}},[s._v("!")]),s._v(" -s 10.211.55.9 -j ACCEPT\niptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 0 packets, 0 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n   53  4145 ACCEPT     all  --  *      *      "),a("span",{attrs:{class:"token operator"}},[s._v("!")]),s._v("10.211.55.9          0.0.0.0/0\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("上述规则的意思为报文的源IP地址不是 "),a("code",[s._v("10.211.55.9")]),s._v(" 的，都执行 "),a("code",[s._v("ACCEPT")]),s._v(" 操作。\n让我们使用测试机 "),a("code",[s._v("ping")]),s._v(" 一下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("ping")]),s._v(" 10.211.55.19                                  \nPING 10.211.55.19 "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("10.211.55.19"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" 56"),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("84"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n64 bytes from 10.211.55.19: icmp_seq"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("1 ttl"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("64 time"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("0.401 ms\n64 bytes from 10.211.55.19: icmp_seq"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("2 ttl"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("64 time"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("0.261 ms\n64 bytes from 10.211.55.19: icmp_seq"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("3 ttl"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("64 time"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("0.258 ms\n^C\n--- 10.211.55.19 "),a("span",{attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n3 packets transmitted, 3 received, 0% packet loss, "),a("span",{attrs:{class:"token function"}},[s._v("time")]),s._v(" 2001ms\nrtt min/avg/max/mdev "),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v(" 0.258/0.306/0.401/0.069 ms\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("我们可以看到，测试机仍然可以 "),a("code",[s._v("ping")]),s._v(" 通目标机器。这是因为，当所有规则都未匹配时，会使用链的默认策略执行操作，而现在 "),a("code",[s._v("INPUT")]),s._v(" 链的默认规则为 "),a("code",[s._v("ACCEPT")]),s._v("。查看 "),a("code",[s._v("INPUT")]),s._v(" 链情况：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 3 packets, 252 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n  505 41315 ACCEPT     all  --  *      *      "),a("span",{attrs:{class:"token operator"}},[s._v("!")]),s._v("10.211.55.9          0.0.0.0/0\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("从输出结果可以看到，默认策略接受了3个报文，总大小为252b。")]),s._v(" "),a("h2",{attrs:{id:"目标ip地址"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#目标ip地址","aria-hidden":"true"}},[s._v("#")]),s._v(" 目标IP地址")]),s._v(" "),a("p",[a("code",[s._v("iptables")]),s._v(" 使用 "),a("code",[s._v("-d, --destination")]),s._v(" 选项指定目标IP地址，表示报文要发到哪里去。\n查看当前机器的IP地址：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("ifconfig")]),s._v(" "),a("span",{attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{attrs:{class:"token string"}},[s._v("'/inet\\>/ {print "),a("span",{attrs:{class:"token variable"}},[s._v("$2")]),s._v("}'")]),s._v("\n10.211.55.19\n127.0.0.1\n192.168.122.1\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("blockquote",[a("p",[s._v("拒绝向 "),a("code",[s._v("192.168.122.1")]),s._v(" 发送报文")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -I INPUT -d 192.168.122.1 -j DROP\niptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 0 packets, 0 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    0     0 DROP       all  --  *      *       0.0.0.0/0            192.168.122.1\n 5192  416K ACCEPT     all  --  *      *      "),a("span",{attrs:{class:"token operator"}},[s._v("!")]),s._v("10.211.55.9          0.0.0.0/0\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[a("code",[s._v("-d")]),s._v(" 和 "),a("code",[s._v("-s")]),s._v(" 选项一样，支持多地址以及网段，也可以取反。")]),s._v(" "),a("h2",{attrs:{id:"协议"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协议","aria-hidden":"true"}},[s._v("#")]),s._v(" 协议")]),s._v(" "),a("p",[a("code",[s._v("-p, --protocol")]),s._v(" 选项指定匹配报文的协议。")]),s._v(" "),a("blockquote",[a("p",[s._v("拒绝来自 "),a("code",[s._v("10.211.55.9")]),s._v(" 的 "),a("code",[s._v("tcp")]),s._v(" 报文")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -F INPUT\niptables -I INPUT -s 10.211.55.9 -d 10.211.55.19 -p tcp -j REJECT\niptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 32 packets, 2092 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    0     0 REJECT     tcp  --  *      *       10.211.55.9          10.211.55.19         reject-with icmp-port-unreachable\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("使用测试机 "),a("code",[s._v("telnet")]),s._v(" 一下:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("telnet 10.211.55.19 22                              \nTrying 10.211.55.19"),a("span",{attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ntelnet: connect to address 10.211.55.19: Connection refused\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("再用测试机 "),a("code",[s._v("ping")]),s._v(" 一下:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ping 10.211.55.19                                   \nPING 10.211.55.19 (10.211.55.19) 56(84) bytes of data.\n64 bytes from 10.211.55.19: icmp_seq=1 ttl=64 time=0.240 ms\n64 bytes from 10.211.55.19: icmp_seq=2 ttl=64 time=0.237 ms\n64 bytes from 10.211.55.19: icmp_seq=3 ttl=64 time=0.284 ms\n^C\n--- 10.211.55.19 ping statistics ---\n3 packets transmitted, 3 received, 0% packet loss, time 2000ms\nrtt min/avg/max/mdev = 0.237/0.253/0.284/0.028 ms\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("这时候查看 "),a("code",[s._v("INPUT")]),s._v(" 链:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 428 packets, 34304 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    1    60 REJECT     tcp  --  *      *       10.211.55.9          10.211.55.19         reject-with icmp-port-unreachable\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("拒绝了一个报文。")]),s._v(" "),a("p",[a("code",[s._v("-p")]),s._v(" 选项包含的协议如下：")]),s._v(" "),a("ul",[a("li",[s._v("tcp")]),s._v(" "),a("li",[s._v("udp")]),s._v(" "),a("li",[s._v("icmp")]),s._v(" "),a("li",[s._v("udplite")]),s._v(" "),a("li",[s._v("icmpv6")]),s._v(" "),a("li",[s._v("esp")]),s._v(" "),a("li",[s._v("ah")]),s._v(" "),a("li",[s._v("sctp")]),s._v(" "),a("li",[s._v("mh")]),s._v(" "),a("li",[s._v("all(所有协议)")])]),s._v(" "),a("p",[s._v("不指定 "),a("code",[s._v("-p")]),s._v(" 选项时，相当于 "),a("code",[s._v("-p all")]),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"网卡接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网卡接口","aria-hidden":"true"}},[s._v("#")]),s._v(" 网卡接口")]),s._v(" "),a("p",[s._v("当机器中有多个网卡时，可以使用 "),a("code",[s._v("-i, --in-interface")]),s._v(" 选项指定具体的网卡接口。\n下面是 10.211.55.19 所在网卡的信息:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("ifconfig")]),s._v("\nbr0: flags"),a("span",{attrs:{class:"token operator"}},[s._v("=")]),s._v("4163"),a("span",{attrs:{class:"token operator"}},[s._v("<")]),s._v("UP,BROADCAST,RUNNING,MULTICAST"),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v("  mtu 1500\n        inet 10.211.55.19  netmask 255.255.255.0  broadcast 10.211.55.255\n        inet6 fe80::21c:42ff:fe14:8ef3  prefixlen 64  scopeid 0x20"),a("span",{attrs:{class:"token operator"}},[s._v("<")]),s._v("link"),a("span",{attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("blockquote",[a("p",[s._v("拒绝流入 "),a("code",[s._v("br0")]),s._v(" 网卡的 "),a("code",[s._v("ping")]),s._v(" 报文")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -F INPUT\niptables -I INPUT -i br0 -p icmp -j DROP\niptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 54 packets, 4185 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    0     0 DROP       icmp --  br0    *       0.0.0.0/0            0.0.0.0/0\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("使用测试机 ping 一下:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("ping")]),s._v(" 10.211.55.19                                   \nPING 10.211.55.19 "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("10.211.55.19"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" 56"),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("84"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" bytes of data.\n^C\n--- 10.211.55.19 "),a("span",{attrs:{class:"token function"}},[s._v("ping")]),s._v(" statistics ---\n4 packets transmitted, 0 received, 100% packet loss, "),a("span",{attrs:{class:"token function"}},[s._v("time")]),s._v(" 3000ms\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("查看 "),a("code",[s._v("INPUT")]),s._v(" 链:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 409 packets, 33105 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    4   336 DROP       icmp --  br0    *       0.0.0.0/0            0.0.0.0/0\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[a("code",[s._v("-i")]),s._v(" 选项只适用于 "),a("code",[s._v("PREROUTING")]),s._v("、"),a("code",[s._v("INPUT")]),s._v("、"),a("code",[s._v("FORWARD")]),s._v(" 这三个链，因为只有它们涉及流入网卡。\n同理，"),a("code",[s._v("-o, --out-interface")]),s._v(" 选项适用 "),a("code",[s._v("OUTPUT")]),s._v("、"),a("code",[s._v("FORWARD")]),s._v("、"),a("code",[s._v("POSTROUTING")]),s._v(" 这三个链。")]),s._v(" "),a("p",[s._v("另外，"),a("code",[s._v("-i")]),s._v(" 和 "),a("code",[s._v("-o")]),s._v(" 都支持取反 "),a("code",[s._v("!")]),s._v(" 操作，而且参数以 "),a("code",[s._v("+")]),s._v(" 结尾时，表示以参数开头的网卡都能匹配到。")]),s._v(" "),a("h2",{attrs:{id:"扩展匹配"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#扩展匹配","aria-hidden":"true"}},[s._v("#")]),s._v(" 扩展匹配")]),s._v(" "),a("p",[s._v("除了基本匹配条件以为，还有很多扩展匹配条件。这些匹配条件基于各个匹配模块，使用 "),a("code",[s._v("-m, --match")]),s._v(" 选项可以指定模块，然后就可以使用模块中的各种选项。")]),s._v(" "),a("p",[a("code",[s._v("tcp")]),s._v(" 模块中包含了端口匹配条件："),a("code",[s._v("[!] --source-port,--sport port[:port]")]),s._v(", "),a("code",[s._v("[!] --destination-port,--dport port[:port]")]),s._v("。")]),s._v(" "),a("blockquote",[a("p",[s._v("拒绝 来自 "),a("code",[s._v("10.211.55.9")]),s._v(" 且目标端口为 22 的报文")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -F INPUT\niptables -I INPUT -p tcp -m tcp -s 10.211.55.9 --dport 22 -j REJECT\niptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 28 packets, 1932 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    0     0 REJECT     tcp  --  *      *       10.211.55.9          0.0.0.0/0            tcp dpt:22 reject-with icmp-port-unreachable\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("使用测试机 "),a("code",[s._v("ssh")]),s._v(" 连接:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{attrs:{class:"token function"}},[s._v("ssh")]),s._v(" root@10.211.55.19                              \nssh: connect to host 10.211.55.19 port 22: Connection refused\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("查看 "),a("code",[s._v("INPUT")]),s._v(" 链:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 496 packets, 40260 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    1    60 REJECT     tcp  --  *      *       10.211.55.9          0.0.0.0/0            tcp dpt:22 reject-with icmp-port-unreachable\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("当使用 "),a("code",[s._v("-p")]),s._v(" 选项时，会默认添加 "),a("code",[s._v("-m 协议名")]),s._v("。比如 "),a("code",[s._v("-p udp")]),s._v(" 相当于 "),a("code",[s._v("-p udp -m udp")]),s._v("。")]),s._v(" "),a("p",[a("code",[s._v("--dport")]),s._v(" 和 "),a("code",[s._v("--sport")]),s._v(" 都支持端口范围。")]),s._v(" "),a("blockquote",[a("p",[s._v("拒绝 来自 "),a("code",[s._v("10.211.55.9")]),s._v(" 且源端口范围 "),a("code",[s._v("30-40")]),s._v(" 的报文")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -I INPUT -p tcp -s 10.211.55.9 --sport 30:40 -j REJECT\niptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 8 packets, 540 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    0     0 REJECT     tcp  --  *      *       10.211.55.9          0.0.0.0/0            tcp spts:30:40 reject-with icmp-port-unreachable\n    1    60 REJECT     tcp  --  *      *       10.211.55.9          0.0.0.0/0            tcp dpt:22 reject-with icmp-port-unreachable\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("端口范围可以省略数字，比如 "),a("code",[s._v("8080:")]),s._v(" 表示 "),a("code",[s._v("8080:65535")]),s._v("， "),a("code",[s._v(":3306")]),s._v(" 表示 "),a("code",[s._v("0:3306")]),s._v("。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -I INPUT -p tcp -s 10.211.55.9 --sport 8080: -j REJECT\niptables -I INPUT -p tcp -s 10.211.55.9 --sport :3306 -j REJECT\niptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 10 packets, 688 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    0     0 REJECT     tcp  --  *      *       10.211.55.9          0.0.0.0/0            tcp spts:0:3306 reject-with icmp-port-unreachable\n    0     0 REJECT     tcp  --  *      *       10.211.55.9          0.0.0.0/0            tcp spts:8080:65535 reject-with icmp-port-unreachable\n    0     0 REJECT     tcp  --  *      *       10.211.55.9          0.0.0.0/0            tcp spts:30:40 reject-with icmp-port-unreachable\n    1    60 REJECT     tcp  --  *      *       10.211.55.9          0.0.0.0/0            tcp dpt:22 reject-with icmp-port-unreachable\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"multiport模块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#multiport模块","aria-hidden":"true"}},[s._v("#")]),s._v(" multiport模块")]),s._v(" "),a("p",[a("code",[s._v("--dport")]),s._v(" 和 "),a("code",[s._v("--sport")]),s._v(" 只支持连续的端口范围，但不支持离散的端口范围。\n这时候需要使用 "),a("code",[s._v("multiport")]),s._v(" 模块的")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("[!] --source-ports,--sports port[,port|,port:port]...")])]),s._v(" "),a("li",[a("code",[s._v("[!] --destination-ports,--dports port[,port|,port:port]...")])]),s._v(" "),a("li",[a("code",[s._v("[!] --ports port[,port|,port:port]...")])])]),s._v(" "),a("p",[s._v("选项来指定离散端口。其中 "),a("code",[s._v("--ports")]),s._v(" 会匹配源端口和目标端口。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("div",{staticClass:"highlight-lines"},[a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br"),a("br"),a("div",{staticClass:"highlighted"},[s._v(" ")]),a("br")]),a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iptables -F INPUT\niptables -I INPUT -p tcp -s 10.211.55.9 -m multiport --dports 22,23,80:88,9000 -j REJECT\niptables -nvL INPUT\nChain INPUT "),a("span",{attrs:{class:"token punctuation"}},[s._v("(")]),s._v("policy ACCEPT 34 packets, 2248 bytes"),a("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n pkts bytes target     prot opt "),a("span",{attrs:{class:"token keyword"}},[s._v("in")]),s._v("     out     "),a("span",{attrs:{class:"token function"}},[s._v("source")]),s._v("               destination\n    0     0 REJECT     tcp  --  *      *       10.211.55.9          0.0.0.0/0            multiport dports 22,23,80:88,9000 reject-with icmp-port-unreachable\n")])]),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"warning custom-block"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[a("code",[s._v("multiport")]),s._v(" 模块只能结合 "),a("code",[s._v("tcp")]),s._v(" 、 "),a("code",[s._v("udp")]),s._v(" 、 "),a("code",[s._v("udplite")]),s._v(" 、 "),a("code",[s._v("dccp")]),s._v(" 和 "),a("code",[s._v("sctp")]),s._v(" 协议使用。\n且最多支持15个离散端口，其中范围端口算作两个端口。")])])])}],!1,null,null,null);e.options.__file="iptables-4-规则匹配.md";t.default=e.exports}}]);