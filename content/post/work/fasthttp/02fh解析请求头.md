---
title: "Fasthttpç³»åˆ—â€”â€”è§£æè¯·æ±‚å¤´"
date: 2020-08-21T19:16:54+08:00
lastmod: 2020-08-25T15:30:41+08:00
tags: [golang, fasthttp]
categories: [golang, fasthttp]
---
> æœ¬ç³»åˆ—é€šè¿‡è§£æ`fasthttp`([v1.16.0](https://github.com/valyala/fasthttp/tree/v1.16.0))æºç å­¦ä¹ [HTTP/1.1](https://httpwg.org/specs/rfc7230.html)ã€‚

## å‰è¨€
[ä¸Šä¸€ç¯‡æ–‡ç« ](https://kiyonlin.github.io/post/work/fasthttp/01fh%E8%AF%B7%E6%B1%82%E8%A1%8C/)æˆ‘ä»¬å­¦ä¹ äº†`HTTP/1.1`çš„è¯·æ±‚è¡Œ(`Request Line`)ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­å­¦ä¹ è¯·æ±‚å¤´çš„è§£æã€‚

## è¯·æ±‚å¤´æ ¼å¼
`HTTP/1.1`çš„[æ¶ˆæ¯æ ¼å¼](https://httpwg.org/specs/rfc7230.html#http.message)å¦‚ä¸‹ï¼š
  
```text
  HTTP-message   = start-line
                   *( header-field CRLF )
                   CRLF
                   [ message-body ]
```

- start-line: èµ·å§‹è¡Œ
- *( header-field CRLF ): å¤´å­—æ®µ+åˆ†éš”ç¬¦(`\r\n`)
- CRLF: ç©ºè¡Œ
- \[ message-body \]: å¯é€‰çš„æ¶ˆæ¯ä½“

æ‰€æœ‰`HTTP/1.1`æ¶ˆæ¯å‡åŒ…å«ä¸€ä¸ªèµ·å§‹è¡Œï¼Œå…¶åæ˜¯ä¸€ç³»åˆ—å¤´å­—æ®µï¼Œç”±åˆ†éš”ç¬¦(`\r\n`)éš”å¼€ï¼Œæ¥ç€æ˜¯ä¸€ä¸ª**ç©ºè¡Œ**(`\r\n`)ï¼Œæœ€åæ˜¯å¯é€‰çš„æ¶ˆæ¯ä½“ã€‚

[ä¸Šä¸€ç¯‡æ–‡ç« ](https://kiyonlin.github.io/post/work/fasthttp/01fh%E8%AF%B7%E6%B1%82%E8%A1%8C/)å­¦ä¹ çš„è¯·æ±‚è¡Œå°±æ˜¯èµ·å§‹è¡Œçš„ä¸€ç§ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯[çŠ¶æ€è¡Œ(Status Line)](https://httpwg.org/specs/rfc7230.html#status.line)ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¹‹åè®²è§£ã€‚

æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ¯ä¸€ä¸ªå¤´å­—æ®µåé¢éƒ½éœ€è¦è·Ÿéšä¸€ä¸ªåˆ†éš”ç¬¦(`\r\n`)ï¼Œ**å½“æŸä¸€è¡Œåªæœ‰åˆ†éš”ç¬¦(`\r\n`)æ—¶**ï¼Œå°±æ„å‘³ç€è¯·æ±‚å¤´æ•°æ®å·²å‘é€å®Œæ¯•ã€‚ä½¿ç”¨[httpie](https://httpie.org/)å°±å¯ä»¥è½»æ¾æŸ¥çœ‹ä¸€ä¸ªçœŸå®çš„è¯·æ±‚å¤´æ•°æ®ï¼š
```bash
$ http "www.baidu.com" -p H
# è¯·æ±‚è¡Œ
GET / HTTP/1.1
# è¯·æ±‚å¤´
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: www.baidu.com
User-Agent: HTTPie/1.0.3

```

## è§£æè¯·æ±‚å¤´
æˆ‘ä»¬å†æ¥çœ‹çœ‹`fasthttp`æ˜¯å¦‚ä½•è§£æè¯·æ±‚å¤´çš„ã€‚å½“`fasthttp`è¯»å–åˆ°å®Œæ•´çš„è¯·æ±‚å¤´æ•°æ®åï¼Œå¼€å§‹è§£æè¯·æ±‚å¤´ï¼Œå¹¶è¿”å›è¯·æ±‚å¤´çš„å­—èŠ‚æ•°ï¼š

```go
func (h *RequestHeader) parse(buf []byte) (int, error) {
	m, err := h.parseFirstLine(buf)
	if err != nil {
		return 0, err
	}

	h.rawHeaders, _, err = readRawHeaders(h.rawHeaders[:0], buf[m:])
	if err != nil {
		return 0, err
	}
	var n int
	n, err = h.parseHeaders(buf[m:])
	if err != nil {
		return 0, err
	}
	return m + n, nil
}
```

æˆ‘ä»¬çœ‹åˆ°äº†ç†Ÿæ‚‰çš„`parseFirstLine`ï¼Œè§£æè¯·æ±‚è¡Œï¼Œæ¥ç€ç»§ç»­è¯»å–å¹¶ä¿å­˜è¯·æ±‚å¤´çš„åŸå§‹æ•°æ®`h.rawHeaders, _, err = readRawHeaders(h.rawHeaders[:0], buf[m:])`ã€‚åœ¨`readRawHeaders`ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°([å®Œæ•´æºç ](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L1760-L1786))ï¼š
```go
func readRawHeaders(dst, buf []byte) ([]byte, int, error) {
	n := bytes.IndexByte(buf, '\n')
	if (n == 1 && buf[0] == '\r') || n == 0 {
		// empty headers
		return dst, n + 1, nil
	}
	for {
		m = bytes.IndexByte(b, '\n')
		// ...
		m++
		// ...
		if (m == 2 && b[0] == '\r') || m == 1 {
			// ...
			return dst, n, nil
		}
	}
}
```

ç›®çš„å°±æ˜¯æ‰¾åˆ°å•ç‹¬çš„`\r\n`æˆ–è€…`\n`ï¼Œä¸€æ—¦æ‰¾åˆ°ï¼Œå°±è¡¨ç¤ºæ²¡æœ‰æ›´å¤šçš„è¯·æ±‚å¤´æ•°æ®äº†ã€‚ä»æºç ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°*`fasthttp`å…¼å®¹äº†ä»¥`\n`ä½œä¸ºåˆ†éš”ç¬¦çš„æ•°æ®æ ¼å¼*ã€‚

æœ€åæ˜¯è§£æè¯·æ±‚å¤´ä¿¡æ¯`n, err = h.parseHeaders(buf[m:])`ï¼Œè§£ææˆåŠŸåï¼Œè¿”å›ç¬¬ä¸€è¡Œæ•°æ®å’Œè¯·æ±‚å¤´çš„æ€»å­—èŠ‚æ•°ã€‚`parseHeaders`çš„[ä»£ç ](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L1868-L1952)æ¯”è¾ƒé•¿ï¼Œå°±ä¸å†å…¨éƒ¨è´´å‡ºæ¥ã€‚

`fasthttp`åœ¨è§£æè¯·æ±‚å¤´æ—¶ï¼Œä½¿ç”¨äº†[headerScanner](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L1985-L2005)è¿™ä¸ªç»“æ„ä½“ï¼Œè°ƒç”¨[next](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L2007-L2114)æ–¹æ³•ä¸€è¡Œä¸€è¡Œè§£æã€‚

é’ˆå¯¹æŒ‡å®šçš„å¤´å­—æ®µï¼š[Host](#Host)ï¼Œ[UserAgent](#UserAgent)ï¼Œ[Content-Type](#ContentType)ï¼Œ[Content-Length](#ContentLength)ï¼Œ[Connection](#Connection)å’Œ[Transfer-Encoding](#TransferEncoding)ï¼Œ`fasthttp`ä¼šåšä¸€äº›ç‰¹æ®Šæ“ä½œï¼Œæˆ‘ä»¬ä¼šä¸€ä¸€è¿›è¡Œè§£æã€‚å…¶ä»–å¤´å­—æ®µä¿¡æ¯ä¼šå­˜å…¥`h.h`([æºç ](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L70))ä¸­ï¼š`h.h = appendArgBytes(h.h, s.key, s.value, argsHasValue)`ã€‚

æˆ‘ä»¬å…ˆæ·±å…¥åˆ†æ`headerScanner.next()`ã€‚

### å¤´å­—æ®µ
é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹[å¤´å­—æ®µ](https://httpwg.org/specs/rfc7230.html#header.fields)çš„ç»“æ„ï¼š
```text
  header-field   = field-name ":" OWS field-value OWS

  field-name     = token
  field-value    = *( field-content / obs-fold )
  field-content  = field-vchar [ 1*( SP / HTAB ) field-vchar ]
  field-vchar    = VCHAR / obs-text

  obs-fold       = CRLF 1*( SP / HTAB )
                 ; obsolete line folding
                 ; see Section 3.2.4
```

æ¯ä¸ªå¤´å­—æ®µå‡ç”±ä¸åŒºåˆ†å¤§å°å†™çš„å­—æ®µåï¼Œåè·Ÿå†’å·(`:`)ï¼Œå¯é€‰çš„å‰å¯¼ç©ºç™½(`OWS`)ï¼Œå­—æ®µå€¼å’Œå¯é€‰çš„å°¾éšç©ºç™½(`OWS`)ç»„æˆã€‚

> æ³¨ï¼š`OWS`æŒ‡çš„æ˜¯`optional whitespace`ï¼Œ[è¯¦æƒ…é“¾æ¥](https://httpwg.org/specs/rfc7230.html#whitespace)ã€‚

`fasthttp`çš„[headerScanner](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L1985-L2005)å°±æ˜¯å¤´éƒ¨æ‰«æå™¨ï¼Œè´Ÿè´£æ‰«æè¯·æ±‚å¤´æ•°æ®ï¼Œè§£æå‡ºå¤´å­—æ®µçš„å­—æ®µå(`key`)å’Œå­—æ®µå€¼(`value`)ï¼Œæ¯æ¬¡è°ƒç”¨`next()`éƒ½è§£æä¸€è¡Œæ•°æ®ã€‚

æ ¹æ®æ ‡å‡†ï¼Œå¤´å­—æ®µåç§°ç´§è·Ÿç€ä¸€ä¸ª`:`ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®`:`çš„ä½ç½®ç¡®è®¤å¤´å­—æ®µåç§°çš„å€¼ã€‚è¿™é‡Œ`fasthttp`åŠ äº†ä¸€ä¸ª[å¤„ç†](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L2039-L2043)ï¼š`:`ä¹‹å‰ä¸èƒ½æœ‰`\n`ï¼Œå› ä¸ºæ­¤æ—¶è¿™ä¸ªå¤´å­—æ®µè‚¯å®šæ˜¯éæ³•çš„ã€‚

è§£æå‡ºå¤´å­—æ®µåç§°åï¼Œ`fasthttp`æ ¹æ®[é…ç½®](https://github.com/valyala/fasthttp/blob/v1.16.0/server.go#L315-L331)çœ‹éœ€ä¸éœ€è¦æ ‡å‡†åŒ–å¤´åç§°ï¼Œ`normalizeHeaderKey(s.key, s.disableNormalizing)`ï¼Œè¿™æ˜¯ä¸ºäº†ç»Ÿä¸€å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚å¤´å­—æ®µåç§°æ ¼å¼ï¼Œé˜²æ­¢å‡ºç°ç±»ä¼¼`cONTENT-lenGTH`çš„å­—æ®µåè€Œåœ¨ä½¿ç”¨æ—¶æ— æ³•åŒ¹é…çš„æƒ…å†µã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå¤´å­—æ®µçš„å€¼åœ¨ä¸€è¡Œå†…ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½æ”¾åœ¨å¤šè¡Œé‡Œ(obs-fold)ï¼Œä¸¾ä¸ªä¾‹å­ï¼š
```text
# ä¸€è¡Œ
Header: value1, value2

# å¤šè¡Œ
Header: value1,
        value2
```

è¿™ä¸¤ç§æ ¼å¼çš„å€¼æ˜¯ç­‰ä»·çš„ï¼Œæƒ³æ·±å…¥äº†è§£çš„å¯ä»¥æŸ¥çœ‹[è¿™é‡Œ](https://stackoverflow.com/questions/31237198/is-it-possible-to-include-multiple-crlfs-in-a-http-header-field)ã€‚`fasthttp`ä¹Ÿ[å…¼å®¹](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L2071-L2112)äº†è¿™ç§æƒ…å†µï¼Œç„¶åå¯¹å¤šè¡Œå€¼è¿›è¡Œæ ¼å¼åŒ–`s.value, s.b, s.hLen = normalizeHeaderValue(s.value, oldB, s.hLen)`ã€‚

æœ€ç»ˆè·å–åˆ°`s.key`å’Œ`s.value`ã€‚

### å¤„ç†å¤´å­—æ®µé”®å€¼å¯¹
è·å–åˆ°å¤´å­—æ®µé”®å€¼å¯¹åï¼Œå¯¹äºä¸€èˆ¬çš„å¤´å­—æ®µï¼Œ`fasthttp`å°†ä»–ä»¬å­˜å‚¨åœ¨`h.h []argsKV`åˆ‡ç‰‡ä¸­(`h.h = appendArgBytes(h.h, s.key, s.value, argsHasValue)`)ï¼Œ`argsKV`å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š
```go
type argsKV struct {
	key     []byte
	value   []byte
	noValue bool
}
```

ä¸ºä»€ä¹ˆä¸ç›´æ¥å­˜åœ¨`map`ä¸­å‘¢ï¼Ÿæˆ‘ä»¬ä¹‹åä¼šè®²è§£ï¼Œä¸»è¦æ˜¯ä¸ºäº†**å»¶è¿Ÿè§£æ**ä»¥åŠ**å†…å­˜å¤ç”¨**ã€‚ç°åœ¨å°±æƒ³çŸ¥é“åŸå› çš„å¯ä»¥æŸ¥çœ‹[youtu.be 13:42](https://youtu.be/ghKCFvSNQkQ?t=822)ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬è®²è®²å‡ ä¸ªç‰¹æ®Šçš„å¤´å­—æ®µï¼Œä»¥åŠ`fasthttp`å¯¹å®ƒä»¬çš„å¤„ç†ã€‚ä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦çœ‹æ‡‚è¿™è¡Œä»£ç ï¼š
```go
switch s.key[0] | 0x20
```

ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯å°†`s.key[0]`ï¼Œå³å¤´å­—æ®µåç§°çš„é¦–å­—æ¯ï¼Œè½¬ä¸ºå°å†™ã€‚åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œç”¨ä¸€æ®µä»£ç è§£é‡Šï¼š
```go
A := 0b01000001
a := 0b01100001
x := 0b00100000 // 0x20
println(A|x == a) // true
println(a|x == a) // true
```

#### Host
`Host`å¤´å­—æ®µ([è¯¦æƒ…](https://httpwg.org/specs/rfc7230.html#header.host))æä¾›äº†ç›®æ ‡`URI`çš„ä¸»æœºå’Œç«¯å£ä¿¡æ¯ï¼Œä½¿æœåŠ¡å™¨èƒ½å¤ŸåŒºåˆ†èµ„æºï¼ŒåŒæ—¶ä¸ºå•ä¸ª`IP`åœ°å€ä¸Šçš„å¤šä¸ªä¸»æœºåçš„è¯·æ±‚æä¾›æœåŠ¡ã€‚`Host`å…·æœ‰æŒ‡å®šçš„æ ¼å¼ï¼š
```text
  Host = uri-host [ ":" port ] ; Section 2.7.1
```

**`RFC7230`ä¸­æŒ‡æ˜`Host`æ˜¯å¿…é¡»å­—æ®µ**ã€‚è‹¥`Host`ä¸åˆæ³•(æœªæä¾›ï¼Œæä¾›å¤šä¸ªï¼Œæ ¼å¼éæ³•)ï¼ŒæœåŠ¡ç«¯å¿…é¡»å“åº”`400 Bad Request`ã€‚

é€šè¿‡`caseInsensitiveCompare(s.key, strHost)`æ¯”è¾ƒå¤´å­—æ®µåç§°å’Œå¸¸é‡`strHost`ï¼Œç¡®å®šæ˜¯å¦å°†å…¶å­˜å…¥è¯·æ±‚å¤´çš„`host`å­—æ®µï¼š`h.host = append(h.host[:0], s.value...)`ã€‚

> æ³¨ï¼š`caseInsensitiveCompare`ä¹Ÿç”¨åˆ°äº†`0x20`çš„æŠ€å·§([æºç ](https://github.com/valyala/fasthttp/blob/v1.16.0/cookie.go#L538-L550))ã€‚

#### UserAgent
`User-Agent`å¤´å­—æ®µ([è¯¦æƒ…](https://httpwg.org/specs/rfc7231.html#header.user-agent))åŒ…å«æœ‰å…³å‘èµ·è¯·æ±‚çš„ç”¨æˆ·ä»£ç†çš„ä¿¡æ¯ï¼ŒæœåŠ¡å™¨é€šå¸¸ä½¿ç”¨è¯¥ä¿¡æ¯æ¥å¸®åŠ©è¯†åˆ«æŠ¥å‘Šçš„äº’æ“ä½œæ€§é—®é¢˜çš„èŒƒå›´ï¼Œè§£å†³æˆ–è°ƒæ•´å“åº”ä»¥é¿å…ç‰¹å®šçš„ç”¨æˆ·ä»£ç†é™åˆ¶ä»¥åŠè¿›è¡Œåˆ†ææœ‰å…³æµè§ˆå™¨æˆ–æ“ä½œç³»ç»Ÿçš„ä½¿ç”¨ã€‚ç”¨æˆ·ä»£ç†åº”è¯¥åœ¨æ¯ä¸ªè¯·æ±‚ä¸­å‘é€ä¸€ä¸ª`User-Agent`å­—æ®µã€‚

å®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š
```text
  User-Agent = product *( RWS ( product / comment ) )
```

è¯¥å­—æ®µçš„å€¼ç›´æ¥å­˜å…¥è¯·æ±‚å¤´çš„`userAgent`å­—æ®µä¸­ã€‚

#### ContentType
`Content-Type`å¤´å­—æ®µ([è¯¦æƒ…](https://httpwg.org/specs/rfc7231.html#header.content-type))æŒ‡å®šäº†è¯·æ±‚çš„[åª’ä½“ç±»å‹](https://httpwg.org/specs/rfc7231.html#media.type)ã€‚

å¸¸è§çš„ä¾‹å­æœ‰ï¼š
```text
  Content-Type: text/html; charset=ISO-8859-4
  Content-Type: application/json; charset=utf-8
```

è¯¥å­—æ®µçš„å€¼ç›´æ¥å­˜å…¥è¯·æ±‚å¤´çš„`contentType`å­—æ®µä¸­ã€‚

#### ContentLength
å½“è¯·æ±‚ä¸­æ²¡æœ‰[Transfer-Encoding](https://httpwg.org/specs/rfc7230.html#header.transfer-encoding)å¤´å­—æ®µæ—¶ï¼Œå¯ä»¥è®¾ç½®[Content-Length](https://httpwg.org/specs/rfc7230.html#header.content-length)å¤´å­—æ®µï¼Œä¸ºæ½œåœ¨çš„æ¶ˆæ¯ä½“æä¾›é¢„æœŸçš„å¤§å°ï¼ˆå…«ä½å­—èŠ‚çš„åè¿›åˆ¶æ•°ï¼‰ï¼›è‹¥åŒ…å«[Transfer-Encoding](https://httpwg.org/specs/rfc7230.html#header.transfer-encoding)å¤´å­—æ®µï¼Œåˆ™**æ— æ³•**è®¾ç½®`Content-Length`ã€‚

`fasthttp`ä½¿ç”¨`parseContentLength`([æºç ](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L1974-L1983))è§£æå…·ä½“çš„æ•°å€¼ï¼Œå¹¶[å¤„ç†](https://github.com/valyala/fasthttp/blob/v1.16.0/bytesconv.go#L189-L192)äº†æº¢å‡ºçš„æƒ…å†µï¼Œé¿å…äº†[é€šè¿‡åè®®å…ƒç´ é•¿åº¦äº§ç”Ÿçš„æ”»å‡»](https://httpwg.org/specs/rfc7230.html#attack.protocol.element.length)ã€‚

è‹¥è§£ææˆåŠŸï¼Œ`fasthttp`ä¹Ÿä¼šå°†åŸå§‹çš„å­—èŠ‚æ•°æ®ä¿å­˜åœ¨`h.contentLengthBytes = append(h.contentLengthBytes[:0], s.value...)`ä¸­ã€‚

#### Connection
`Connection`å¤´å­—æ®µ([è¯¦æƒ…](https://httpwg.org/specs/rfc7230.html#header.connection))å…è®¸å®¢æˆ·ç«¯æ§åˆ¶å½“å‰è¿æ¥ã€‚

*`Connection`å€¼æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„*ï¼Œæ‰€ä»¥`fasthttp`ä½¿ç”¨`bytes.Equal(s.value, strClose)`æ¥æ¯”è¾ƒè¿æ¥å€¼æ˜¯å¦ä¸ºå¸¸é‡`strClose("close")`ï¼Œå¹¶ä¿å­˜åˆ°`connectionClose`å­—æ®µä¸­ï¼ŒåŒæ—¶å°†åŸå§‹çš„å­—èŠ‚æ•°æ®ä¿å­˜åœ¨`h.h = appendArgBytes(h.h, s.key, s.value, argsHasValue)`ä¸­ã€‚

#### TransferEncoding
`Transfer-Encoding`å¤´å­—æ®µ([è¯¦æƒ…](https://httpwg.org/specs/rfc7230.html#header.transfer-encoding))åˆ—å‡ºä¸å·²ç»ï¼ˆæˆ–å°†è¦ï¼‰åº”ç”¨äºæœ‰æ•ˆè½½è·ä¸»ä½“ä»¥å½¢æˆæ¶ˆæ¯ä¸»ä½“çš„ä¼ è¾“ç¼–ç åºåˆ—ç›¸å¯¹åº”çš„ä¼ è¾“ç¼–ç åç§°ã€‚ä¼ è¾“ç¼–ç åœ¨[è¿™é‡Œ](https://httpwg.org/specs/rfc7230.html#transfer.codings)å®šä¹‰ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œäº†è§£ã€‚

æˆ‘ä»¬çœ‹çœ‹`fasthttp`çš„å¤„ç†é€»è¾‘ï¼š
```go
if !bytes.Equal(s.value, strIdentity) {
	h.contentLength = -1
	h.h = setArgBytes(h.h, strTransferEncoding, strChunked, argsHasValue)
}
```

å› ä¸º`identity`å·²ç»è¢«[ç§»é™¤](https://httpwg.org/specs/rfc7230.html#changes.from.rfc.2616)ï¼Œæ‰€ä»¥`fasthttp`å¿½ç•¥äº†`identity`ï¼Œä¸”æ ¹æ®æˆ‘ä»¬åœ¨[Content-Length](#ContentLength)ä¸­å­¦åˆ°çš„çŸ¥è¯†ï¼Œæ­¤æ—¶åº”è¯¥å¿½ç•¥`contentLength`ï¼Œæ‰€ä»¥å°†å…¶è®¾ä¸º`-1`ï¼Œå¯¹åº”äº†`Content-Length`å¤´å­—æ®µçš„`if h.contentLength != -1 {...}`([æºç ](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L1901-L1911))å¤„ç†ã€‚æœ€åæŠŠ`Transfer-Encoding`å¤´å­—æ®µçš„å€¼è®¾ä¸º`chunked`ã€‚

### æ”¶å°¾æ“ä½œ
è§£æå®Œæ‰€æœ‰çš„å¤´å­—æ®µåï¼Œ`fasthttp`è¿›è¡Œäº†ä¸€äº›æ”¶å°¾æ“ä½œï¼š
```go
if h.contentLength < 0 {
	h.contentLengthBytes = h.contentLengthBytes[:0]
}
if h.noHTTP11 && !h.connectionClose {
	// close connection for non-http/1.1 request unless 'Connection: keep-alive' is set.
	v := peekArgBytes(h.h, strConnection)
	h.connectionClose = !hasHeaderValue(v, strKeepAlive)
}
```

1. æœªè®¾ç½®`h.contentLength`æ—¶ï¼Œæ¸…ç©º`h.contentLengthBytes`
1. ä¸æ˜¯`HTTP/1.1`çš„æƒ…å†µä¸‹é‡æ–°è®¾ç½®`h.connectionClose`çš„å€¼(æ’é™¤`Connection: keep-alive`çš„æƒ…å†µ)

## æ€»ç»“
è¯·æ±‚å¤´è§£æéƒ¨åˆ†åˆ°è¿™é‡Œå°±å‘Šä¸€æ®µè½äº†ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ä¸å°‘è¯·æ±‚å¤´ç›¸å…³çš„çŸ¥è¯†ï¼Œç¨å¾®æ€»ç»“ï¼š
- æ¯ä¸ªè¯·æ±‚å¤´æ˜¯æ ¹æ®åˆ†éš”ç¬¦(`\r\n`)åˆ†éš”çš„ï¼Œä½†å¯ä»¥åŒ…å«å¤šè¡Œå€¼
- ç©ºè¡Œä»£è¡¨è¯·æ±‚å¤´æ•°æ®çš„ç»ˆæ­¢
- ä¸€äº›å…·ä½“çš„è¯·æ±‚å¤´æ¦‚å¿µ
- ä½¿ç”¨`scanner`è§£ææ•°æ®æµ
- å­—æ¯å­—ç¬¦æ¯”è¾ƒæ—¶ä½¿ç”¨`0x20`çš„å°æŠ€å·§

*æ•¬è¯·æœŸå¾…ä¹‹åçš„ç³»åˆ—æ–‡ç« ï¼* ğŸ‘‹
