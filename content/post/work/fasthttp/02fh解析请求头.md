---
title: "Fasthttpç³»åˆ—â€”â€”è§£æè¯·æ±‚å¤´"
date: 2020-08-21T19:16:54+08:00
lastmod: 2020-08-21T19:16:59+08:00
tags: [golang, fasthttp]
categories: [golang, fasthttp]
draft: true
---
> æœ¬ç³»åˆ—é€šè¿‡è§£æ`fasthttp`([v1.16.0](https://github.com/valyala/fasthttp/tree/v1.16.0))æºç å­¦ä¹ [HTTP/1.1](https://httpwg.org/specs/rfc7230.html)ã€‚

## å‰è¨€
[ä¸Šä¸€ç¯‡æ–‡ç« ](https://kiyonlin.github.io/post/work/fasthttp/01fh%E8%AF%B7%E6%B1%82%E8%A1%8C/)æˆ‘ä»¬å­¦ä¹ äº†`HTTP/1.1`çš„è¯·æ±‚è¡Œ(`Request Line`)ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­å­¦ä¹ è¯·æ±‚å¤´çš„è§£æã€‚

## è¯·æ±‚å¤´æ ¼å¼
`HTTP/1.1`çš„[æ¶ˆæ¯æ ¼å¼](https://httpwg.org/specs/rfc7230.html#http.message)å¦‚ä¸‹ï¼š
  
```text
  HTTP-message   = start-line
                   *( header-field CRLF )
                   CRLF
                   [ message-body ]
```

- start-line: èµ·å§‹è¡Œ
- *( header-field CRLF ): å¤´å­—æ®µ+åˆ†éš”ç¬¦(`\r\n`)
- CRLF: ç©ºè¡Œ
- \[ message-body \]: å¯é€‰çš„æ¶ˆæ¯ä½“

æ‰€æœ‰`HTTP/1.1`æ¶ˆæ¯å‡åŒ…å«ä¸€ä¸ªèµ·å§‹è¡Œï¼Œå…¶åæ˜¯ä¸€ç³»åˆ—å¤´å­—æ®µï¼Œç”±åˆ†éš”ç¬¦(`\r\n`)éš”å¼€ï¼Œæ¥ç€æ˜¯ä¸€ä¸ª**ç©ºè¡Œ**(`\r\n`)ï¼Œæœ€åæ˜¯å¯é€‰çš„æ¶ˆæ¯ä½“ã€‚

[ä¸Šä¸€ç¯‡æ–‡ç« ](https://kiyonlin.github.io/post/work/fasthttp/01fh%E8%AF%B7%E6%B1%82%E8%A1%8C/)å­¦ä¹ çš„è¯·æ±‚è¡Œå°±æ˜¯èµ·å§‹è¡Œçš„ä¸€ç§ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯[çŠ¶æ€è¡Œ(Status Line)](https://httpwg.org/specs/rfc7230.html#status.line)ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¹‹åè®²è§£ã€‚

æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ¯ä¸€ä¸ªå¤´å­—æ®µåé¢éƒ½éœ€è¦è·Ÿéšä¸€ä¸ªåˆ†éš”ç¬¦(`\r\n`)ï¼Œ**å½“æŸä¸€è¡Œåªæœ‰åˆ†éš”ç¬¦(`\r\n`)æ—¶**ï¼Œå°±æ„å‘³ç€è¯·æ±‚å¤´æ•°æ®å·²å‘é€å®Œæ¯•ã€‚ä½¿ç”¨[httpie](https://httpie.org/)å°±å¯ä»¥è½»æ¾æŸ¥çœ‹ä¸€ä¸ªçœŸå®çš„è¯·æ±‚å¤´æ•°æ®ï¼š
```bash
$ http "www.baidu.com" -p H
# è¯·æ±‚è¡Œ
GET / HTTP/1.1
# è¯·æ±‚å¤´
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: www.baidu.com
User-Agent: HTTPie/1.0.3

```

## è§£æè¯·æ±‚å¤´
æˆ‘ä»¬å†æ¥çœ‹çœ‹`fasthttp`æ˜¯å¦‚ä½•è§£æè¯·æ±‚å¤´çš„ã€‚å½“`fasthttp`è¯»å–åˆ°å®Œæ•´çš„è¯·æ±‚å¤´æ•°æ®åï¼Œå¼€å§‹è§£æè¯·æ±‚å¤´ï¼Œå¹¶è¿”å›è¯·æ±‚å¤´çš„å­—èŠ‚æ•°ï¼š

```go
func (h *RequestHeader) parse(buf []byte) (int, error) {
	m, err := h.parseFirstLine(buf)
	if err != nil {
		return 0, err
	}

	h.rawHeaders, _, err = readRawHeaders(h.rawHeaders[:0], buf[m:])
	if err != nil {
		return 0, err
	}
	var n int
	n, err = h.parseHeaders(buf[m:])
	if err != nil {
		return 0, err
	}
	return m + n, nil
}
```

æˆ‘ä»¬çœ‹åˆ°äº†ç†Ÿæ‚‰çš„`parseFirstLine`ï¼Œè§£æè¯·æ±‚è¡Œï¼Œæ¥ç€ç»§ç»­è¯»å–å¹¶ä¿å­˜è¯·æ±‚å¤´çš„åŸå§‹æ•°æ®`h.rawHeaders, _, err = readRawHeaders(h.rawHeaders[:0], buf[m:])`ã€‚åœ¨`readRawHeaders`ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°([å®Œæ•´æºç ](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L1760-L1786))ï¼š
```go
func readRawHeaders(dst, buf []byte) ([]byte, int, error) {
	n := bytes.IndexByte(buf, '\n')
	if (n == 1 && buf[0] == '\r') || n == 0 {
		// empty headers
		return dst, n + 1, nil
	}
	for {
		m = bytes.IndexByte(b, '\n')
		// ...
		m++
		// ...
		if (m == 2 && b[0] == '\r') || m == 1 {
			dst = append(dst, buf[:n]...)
			return dst, n, nil
		}
	}
}
```

ç›®çš„å°±æ˜¯æ‰¾åˆ°å•ç‹¬çš„`\r\n`æˆ–è€…`\n`ï¼Œä¸€æ—¦æ‰¾åˆ°ï¼Œå°±è¡¨ç¤ºæ²¡æœ‰æ›´å¤šçš„è¯·æ±‚å¤´æ•°æ®äº†ã€‚ä»æºç ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°*`fasthttp`å…¼å®¹äº†ä»¥`\n`ä½œä¸ºåˆ†éš”ç¬¦çš„æ•°æ®æ ¼å¼*ã€‚

æœ€åæ˜¯è§£æè¯·æ±‚å¤´ä¿¡æ¯`n, err = h.parseHeaders(buf[m:])`ï¼Œè§£ææˆåŠŸåï¼Œè¿”å›ç¬¬ä¸€è¡Œæ•°æ®å’Œè¯·æ±‚å¤´çš„æ€»å­—èŠ‚æ•°ã€‚`parseHeaders`çš„[ä»£ç ](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L1868-L1952)æ¯”è¾ƒé•¿ï¼Œå°±ä¸å†å…¨éƒ¨è´´å‡ºæ¥ã€‚

`fasthttp`åœ¨è§£æè¯·æ±‚å¤´æ—¶ï¼Œä½¿ç”¨äº†[headerScanner](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L1985-L2005)è¿™ä¸ªç»“æ„ä½“ï¼Œè°ƒç”¨[next](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L2007-L2114)æ–¹æ³•ä¸€è¡Œä¸€è¡Œè§£æã€‚

é’ˆå¯¹æŒ‡å®šçš„å¤´å­—æ®µï¼š`Host`ï¼Œ`UserAgent`ï¼Œ`ContentType`ï¼Œ`ContentLength`ï¼Œ`Connection`å’Œ`Transfer-Encoding`ï¼Œ`fasthttp`ä¼šåšä¸€äº›ç‰¹æ®Šæ“ä½œï¼Œæˆ‘ä»¬ä¼šä¸€ä¸€è¿›è¡Œè§£æã€‚å…¶ä»–å¤´å­—æ®µä¿¡æ¯ä¼šå­˜å…¥`h.h`([æºç ](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L70))ä¸­ï¼š`h.h = appendArgBytes(h.h, s.key, s.value, argsHasValue)`ã€‚

æˆ‘ä»¬å…ˆæ¥`headerScanner.next()`ã€‚

### `headerScanner.next()`

## æ€»ç»“

*æ•¬è¯·æœŸå¾…ä¹‹åçš„ç³»åˆ—æ–‡ç« ï¼* ğŸ‘‹
