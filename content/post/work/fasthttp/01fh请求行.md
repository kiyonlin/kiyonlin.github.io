---
title: "Fasthttpç³»åˆ—â€”â€”è¯·æ±‚è¡Œ"
date: 2020-08-18T14:08:37+08:00
lastmod: 2020-08-18T14:08:42+08:00
tags: [golang, fasthttp]
categories: [golang, fasthttp]
---
> æœ¬ç³»åˆ—é€šè¿‡è§£æ`fasthttp`([v1.16.0](https://github.com/valyala/fasthttp/tree/v1.16.0))æºç å­¦ä¹ [HTTP/1.1](https://httpwg.org/specs/rfc7230.html)ã€‚

## ç¬¬ä¸€è¡Œ
`WEB`æœåŠ¡æ¥æ”¶`HTTP`è¯·æ±‚è¦åšçš„ç¬¬ä¸€ä»¶äº‹ï¼Œå°±æ˜¯è§£æè¯·æ±‚è¡Œ([Request Line](https://httpwg.org/specs/rfc7230.html#request.line))ã€‚å®ƒçš„æ ¼å¼å¦‚ä¸‹ï¼š

```text
request-line   = method SP request-target SP HTTP-version CRLF
```

- method: [è¯·æ±‚æ–¹æ³•](#è¯·æ±‚æ–¹æ³•)
- SP: ç©ºæ ¼
- request-target: [è¯·æ±‚ç›®æ ‡](#è¯·æ±‚ç›®æ ‡)
- HTTP-version: `HTTP`ç‰ˆæœ¬
- CRLF: åˆ†éš”ç¬¦`\r\n`

å¯¹åº”åˆ°`fasthttp`ä¸­çš„[ä»£ç ](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L1696-L1727)æ˜¯ï¼š
```go
func (h *RequestHeader) parseFirstLine(buf []byte) (int, error) {
	bNext := buf
	var b []byte
	var err error
	for len(b) == 0 {
		if b, bNext, err = nextLine(bNext); err != nil {
			return 0, err
		}
	}

	// parse method
	n := bytes.IndexByte(b, ' ')
	if n <= 0 {
		return 0, fmt.Errorf("cannot find http request method in %q", buf)
	}
	h.method = append(h.method[:0], b[:n]...)
	b = b[n+1:]

	// parse requestURI
	n = bytes.LastIndexByte(b, ' ')
	if n < 0 {
		h.noHTTP11 = true
		n = len(b)
	} else if n == 0 {
		return 0, fmt.Errorf("requestURI cannot be empty in %q", buf)
	} else if !bytes.Equal(b[n+1:], strHTTP11) {
		h.noHTTP11 = true
	}
	h.requestURI = append(h.requestURI[:0], b[:n]...)

	return len(buf) - len(bNext), nil
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`fasthttp`å…ˆè°ƒç”¨[nextLine](https://github.com/valyala/fasthttp/blob/v1.16.0/header.go#L2158-L2167)æ–¹æ³•ï¼Œæ ¹æ®åˆ†éš”ç¬¦(`\r\n`)è·å–å‡ºç¬¬ä¸€è¡Œçš„æ‰€æœ‰å­—èŠ‚æ•°æ®`b`ã€‚

å†æ ¹æ®`b`ä¸­ç¬¬ä¸€ä¸ªç©ºæ ¼å­—èŠ‚çš„ä½ç½®è§£æå‡º`method`ï¼Œå­˜å…¥è¯·æ±‚å¤´å¯¹è±¡ä¸­`h.method = append(h.method[:0], b[:n]...)`ã€‚

å†æ ¹æ®`b`ä¸­æœ€åä¸€ä¸ªç©ºæ ¼çš„ä½ç½®ï¼Œè§£æå‡º`request-target`å’Œ`HTTP-version`ã€‚

å…¶ä¸­`HTTP-version`ç”±`h.noHTTP11`ä¿å­˜ä¸€ä¸ª`bool`å€¼ï¼Œä¸å­˜åœ¨`HTTP`ç‰ˆæœ¬æ•°æ®æˆ–è€…å®ƒä¸ç­‰äº`HTTP/1.1`æ—¶ï¼Œè¿™ä¸ªå­—æ®µéƒ½ä¸º`false`ã€‚

è€Œ`request-target`ä¹Ÿæ˜¯ç›´æ¥ä¿å­˜åˆ°è¯·æ±‚å¤´å¯¹è±¡ä¸­`h.requestURI = append(h.requestURI[:0], b[:n]...)`ã€‚

æœ€åè¿”å›ç¬¬ä¸€è¡Œçš„å­—èŠ‚æ•°ï¼Œdoneï¼

## è¯·æ±‚æ–¹æ³•
> The method token indicates the request method to be performed on the target resource. The request method is case-sensitive.

æˆ‘ä»¬æ³¨æ„åˆ°`RFC`ä¸­æœ‰æåˆ°è¯·æ±‚`method`æ˜¯å¤§å°å†™æ•æ„Ÿçš„(`The request method is case-sensitive`)ã€‚

è€Œä¸”æ ¹æ®ä¸Šé¢çš„è§£æè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡º`fasthttp`è·å–åˆ°`method`æ—¶ï¼Œç›´æ¥ä¿å­˜åœ¨è¯·æ±‚å¤´ä¸­ï¼Œå¹¶æ²¡æœ‰åšä»»ä½•æ£€æŸ¥ã€‚æ‰€ä»¥å½“è¯·æ±‚ç«¯å‘é€äº†ä¸æ­£ç¡®(æ¯”å¦‚ç”¨äº†å°å†™)çš„`method`å€¼æ—¶ï¼ŒæœåŠ¡ç«¯å¯ä»¥æ‹’ç»è¿™æ¬¡è¯·æ±‚(`400 Bad Request`)ã€‚

æ‰€æœ‰çš„è¯·æ±‚`method`å¯ä»¥åœ¨[RFC7231](https://httpwg.org/specs/rfc7231.html#methods)ä¸­æŸ¥çœ‹ï¼Œä¹‹åä¹Ÿä¼šç»†è®²ã€‚

## è¯·æ±‚ç›®æ ‡
å®¢æˆ·ç«¯å‘é€`HTTP`è¯·æ±‚æ¶ˆæ¯æ—¶ï¼Œå…¶ä¸­åŒ…å«ä»ç›®æ ‡`URI`æ´¾ç”Ÿçš„è¯·æ±‚ç›®æ ‡ã€‚è¯·æ±‚ç›®æ ‡æœ‰å››ç§ä¸åŒçš„æ ¼å¼ï¼Œå…·ä½“å–å†³äºè¯·æ±‚çš„æ–¹æ³•ä»¥åŠè¯·æ±‚æ˜¯å¦é’ˆå¯¹ä»£ç†ï¼š

```text
  request-target = origin-form
                 / absolute-form
                 / authority-form
                 / asterisk-form
```

ä¹‹åçš„æ–‡ç« ä¼šé’ˆå¯¹è¯·æ±‚ç›®æ ‡åšè¯¦ç»†çš„åˆ†æï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚

## æ€»ç»“
æœ¬ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« å°±è¿™æ ·ç»“æŸäº†ã€‚æˆ‘ä»¬äº†è§£äº†è¯·æ±‚è¡Œçš„ç»“æ„ï¼Œå¹¶å‰–æäº†`fasthttp`æ˜¯å¦‚ä½•ä»æ•°æ®æµä¸­è§£æè¿™ç¬¬ä¸€è¡Œè¯·æ±‚æ•°æ®ã€‚

*æ•¬è¯·æœŸå¾…ä¹‹åçš„ç³»åˆ—æ–‡ç« ï¼* ğŸ‘‹
